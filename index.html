<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <script data-ios-detect-early>
    (function(){
      try{
        var isiOS = /AppleWebKit/.test(navigator.userAgent||'') && (navigator.maxTouchPoints||0) > 1;
        if (isiOS) document.documentElement.classList.add('ios');
      }catch(e){}
    })();
    </script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>Setlist Manager - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
        // === Long-press (1s) before dragging files ===
        let dragTimer = null;
        $(document).on('mousedown touchstart', 'li.draggable', function(e) {
            const item = $(this);
            dragTimer = setTimeout(() => {
                item.draggable('enable');
            }, 1000); // 1 second hold
            // disable dragging immediately until timer completes
            item.draggable('disable');
        }).on('mouseup mouseleave touchend touchcancel', 'li.draggable', function(e) {
            clearTimeout(dragTimer);
            // re-disable dragging so it requires hold again next time
            $(this).draggable('disable');
        });
        // Initially disable all draggables until long-press
        $(function() {
            $('li.draggable').draggable('disable');
        });
        // === Refined long-press-to-drag with movement threshold ===
        (function(){
            let dragTimer = null;
            let startX = 0, startY = 0;
            const THRESHOLD = 8; // px
            const HOLD_MS = 1100;
            function getPoint(e){
                if (e.touches && e.touches.length) return {x: e.touches[0].clientX, y: e.touches[0].clientY};
                if (e.changedTouches && e.changedTouches.length) return {x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY};
                return {x: e.clientX || 0, y: e.clientY || 0};
            }
            function cancelTimer(){
                if (dragTimer){ clearTimeout(dragTimer); dragTimer = null; }
            }
            $(document).on('mousedown touchstart', 'li.draggable', function(e) {
                const item = $(this);
                const p = getPoint(e);
                startX = p.x; startY = p.y;
                item.draggable('disable'); // always start disabled
                cancelTimer();
                dragTimer = setTimeout(() => {
                    // Only enable if we haven't moved too much during the hold
                    item.draggable('enable');
                }, HOLD_MS);
            });
            $(document).on('mousemove touchmove', 'li.draggable', function(e) {
                if (!dragTimer) return; // already enabled or canceled
                const p = getPoint(e);
                const dx = Math.abs(p.x - startX);
                const dy = Math.abs(p.y - startY);
                if (dx > THRESHOLD || dy > THRESHOLD) {
                    // User is scrolling or moving: cancel drag enabling
                    cancelTimer();
                    $(this).draggable('disable');
                }
            });
            $(document).on('mouseup mouseleave touchend touchcancel', 'li.draggable', function(e) {
                cancelTimer();
                // Require long-press again next time
                $(this).draggable('disable');
            });
            // On load, add a small distance requirement for extra safety
            $(function(){
                try {
                    $('li.draggable').draggable('option', 'distance', 12);
                } catch(e) {}
            });
        })();
        // === Left-edge custom scrollbar logic (shown when sidebar is collapsed) ===
        (function(){
            const $main = $('main');
            const $sidebar = $('.left-col');
            const $edge = $('#edge-scrollbar');
            const $thumb = $('#edge-thumb');

            const MIN_THUMB = 48; // px minimum size
            let dragging = false;
            let trackTop = 0;
            let trackHeight = 0;
            let startY = 0;
            let startScroll = 0;

            function updateThumb(){
                // Only operate if element present
                if ($edge.length === 0) return;
                const scrollEl = $main.get(0);
                const scrollH = scrollEl.scrollHeight;
                const clientH  = scrollEl.clientHeight;
                const maxScroll = Math.max(1, scrollH - clientH);
                const trackRect = $edge.get(0).getBoundingClientRect();
                trackTop = trackRect.top + (window.innerHeight * 0.04); // 4vh top offset to match ::before
                trackHeight = window.innerHeight * 0.92; // 92vh like CSS

                // Thumb size proportional to viewport/total
                let thumbH = Math.max(MIN_THUMB, (clientH / scrollH) * trackHeight);
                $thumb.css('height', thumbH + 'px');

                const ratio = $main.scrollTop() / maxScroll;
                const maxY = trackHeight - thumbH;
                const y = trackTop + (ratio * maxY);
                $thumb.css('top', y + 'px');
            }

            function setScrollFromThumb(pageY){
                const scrollEl = $main.get(0);
                const scrollH = scrollEl.scrollHeight;
                const clientH  = scrollEl.clientHeight;
                const maxScroll = Math.max(1, scrollH - clientH);

                const thumbH = $thumb.outerHeight();
                const maxY = trackHeight - thumbH;
                let localY = pageY - trackTop - (thumbH/2);
                localY = Math.max(0, Math.min(maxY, localY));
                const ratio = localY / maxY;
                $main.scrollTop(ratio * maxScroll);
            }

            function showEdgeIfCollapsed(){
                if ($sidebar.hasClass('collapsed')) {
                    $edge.addClass('visible').removeClass('hidden');
                    updateThumb();
                } else {
                    $edge.removeClass('visible').addClass('hidden');
                }
            }

            // Sync on load and on changes
            $(function(){
                showEdgeIfCollapsed();
                updateThumb();
                // Update on main scroll & resize
                $main.on('scroll', updateThumb);
                $(window).on('resize', updateThumb);
            });

            // Tie into existing sidebar toggle
            $('#sidebar-toggle').on('click', function(){
                // Delay to allow class toggle to settle
                setTimeout(showEdgeIfCollapsed, 0);
                setTimeout(updateThumb, 0);
            });

            // Drag handling (mouse + touch) on the thumb
            function onMove(e){
                if (!dragging) return;
                const pageY = (e.touches && e.touches[0] ? e.touches[0].clientY : e.clientY);
                setScrollFromThumb(pageY);
                e.preventDefault();
            }
            function onUp(){
                dragging = false;
                $(document).off('mousemove touchmove', onMove);
                $(document).off('mouseup touchend touchcancel', onUp);
            }
            $thumb.on('mousedown touchstart', function(e){
                dragging = true;
                $(document).on('mousemove touchmove', onMove);
                $(document).on('mouseup touchend touchcancel', onUp);
                e.preventDefault();
            });

            // Clicking the track jumps the thumb to that position
            $edge.on('mousedown touchstart', function(e){
                if (e.target === $thumb.get(0)) return; // handled by thumb
                const pageY = (e.touches && e.touches[0] ? e.touches[0].clientY : e.clientY);
                setScrollFromThumb(pageY);
            });

            // Also update when content visibility changes (navigation)
            const originalShow = window.show;
            if (typeof originalShow === 'function') {
                window.show = function(view){
                    originalShow(view);
                    // after view switch, update thumb position
                    setTimeout(function(){
                        showEdgeIfCollapsed();
                        updateThumb();
                    }, 0);
                }
            }
        })();

    </script>
    <script>
        (function() {
            var ua = navigator.userAgent || navigator.vendor || window.opera;
            var isiOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            if (isiOS) {
                document.documentElement.classList.add('ios');
            }
        })();
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
    <style>
        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed; /* Prevents panning/scrolling on touch devices */
        }
        
        #app {
            height: 100%;
            display: flex;
        }

        /* --- FIX: Correctly enables scrolling on touch devices when PDF viewer is open --- */
        body.doc-viewer-active {
            position: static; /* Revert to default positioning to allow scrolling */
            overflow: auto !important;   /* Explicitly allow scrolling on the body */
        }

        .doc-viewer-active #app {
            display: none; /* Hide the main app UI to prevent interaction and layout shifts */
        }
        
        .doc-view-fullscreen {
            overflow: hidden; /* Prevent scrollbars on the main viewer, child will scroll */
        }

        /* --- FIX: Smooth sidebar collapse transition for main content --- */
        main {
            transition: all 0.4s ease-in-out;
        }
        
        .sortable {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .draggable {
            cursor: move;
        }
        
        /* Subtle placeholder for sorting */
        .sortable-placeholder {
            background-color: #e5e7eb;
            border: 1px dashed #9ca3af;
            opacity: 0.5;
            height: 60px;
            margin-bottom: 1px;
            border-radius: 0.5rem;
        }
        .dark .sortable-placeholder {
            background-color: #374151;
            border-color: #6b7280;
        }

        /* Style for the actual item being sorted */
        .is-sorting {
            background: #2563eb !important; /* Record Show button blue */
            color: white !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        .is-sorting * {
            color: white !important;
        }
        .is-sorting .song-details-container {
            display: none; /* Hide inputs while sorting songs */
        }
        .is-sorting .delete-genre, .is-sorting .delete-venue {
            display: none; /* Hide delete button while sorting genres/venues */
        }


        /* Unified selected style for sidebar items */
        .selected {
            background-color: #3b82f6 !important;
            color: white !important;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
        }

        .selected .genre-name, .selected .venue-name {
             color: white !important;
        }

        /* Simple hover class for dragging over a setlist */
        .drag-hover-setlist {
            background-color: #3b82f6 !important;
            color: white !important;
        }
        
        /* Multiple selection highlight */
        .item-selected {
            background-color: #3b82f6 !important;
            color: white !important;
        }
        .dark .item-selected {
            background-color: #2563eb !important;
            color: white !important;
        }


        /* Consistent Add Button Style */
        .btn-add {
            background-color: #3b82f6;
            color: white;
            border: none;
            transition: background-color 0.2s;
            flex-shrink: 0; /* Prevent button from shrinking */
        }
        .btn-add:hover {
            background-color: #2563eb;
        }

        /* Genre dot and viewed indicator unified size */
        .genre-dot, .index-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Prevent shrinking */
            font-size: 1.125rem; /* Bigger numbers */
            font-weight: 600; /* Bolder numbers */
        }

        /* Fullscreen viewer styles */
        .doc-view-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 100;
            background: #333; /* Dark background for page turn effect */
        }
        .dark .doc-view-fullscreen {
            background: #111827;
        }
        
        /* --- Page Turn Animation --- */
        #doc-iframe-wrapper {
            width: 100%;
            height: 100%;
            perspective: 2500px; /* Enable 3D space for a more dramatic effect */
        }
        .doc-iframe-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            backface-visibility: hidden; /* Hide the back of the page */
            transition: transform 0.8s cubic-bezier(0.6, 0.0, 0.2, 1); /* Smoother animation curve */
            transform-origin: left center; /* For turning left-to-right */
            overflow: auto; /* Allow this container to scroll */
            -webkit-overflow-scrolling: touch; /* For iOS */
        }
        /* Page states */
        .doc-iframe-container.current {
            transform: rotateY(0deg);
            z-index: 101;
        }
        .doc-iframe-container.next {
            transform: rotateY(180deg);
            z-index: 100;
        }
        .doc-iframe-container.prev {
            transform: rotateY(-180deg);
            z-index: 100;
        }
        /* Animation classes */
        .turning-next { /* Current page turns away to the left */
            transform: rotateY(-180deg);
        }
        .turning-prev { /* Current page turns away to the right */
            transform-origin: right center;
            transform: rotateY(180deg);
        }
        /* New page coming in from the right */
        .incoming-next {
            transform-origin: left center;
            transform: rotateY(0deg);
        }
        /* New page coming in from the left */
        .incoming-prev {
            transform-origin: right center;
            transform: rotateY(0deg);
        }


        #doc-object {
            width: 100%;
            min-height: 100%; /* Ensure it fills the scrollable area */
            border: 0;
            display: block; /* Fix potential extra space */
        }
        
        /* === NEW Redesigned Viewer Controls === */
        #viewer-controls {
            /* Gradient background for better text visibility over content */
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
            /* Don't show by default */
            display: none;
        }
        /* Show controls only when a viewer is active */
        body.doc-viewer-active #viewer-controls,
        html.pdf-overlay-active #viewer-controls {
            display: flex;
        }

        .viewer-btn {
            /* Frosted glass effect */
            background-color: rgba(30, 41, 59, 0.75); /* slate-800 with opacity */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            will-change: transform, background-color; /* Perf hint */
        }

        .viewer-btn:not(:disabled):hover {
            background-color: rgba(59, 130, 246, 0.8); /* blue-500 with opacity */
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .viewer-btn:disabled {
            background-color: rgba(75, 85, 99, 0.5); /* gray-600 with opacity */
            transform: none;
            box-shadow: none;
        }

        .viewer-btn-close {
            background-color: rgba(239, 68, 68, 0.75); /* red-500 with opacity */
        }

        .viewer-btn-close:hover {
            background-color: rgba(220, 38, 38, 0.8); /* red-600 with opacity */
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        .del-setlist {
            background: #ef4444;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
        }

        .del-setlist svg {
            width: 14px;
            height: 14px;
            fill: white;
        }

        .del-setlist:hover {
            background: #dc2626;
        }

        .setlist-item {
            display: flex;
            align-items: center;
            transition: all 0.2s ease-out;
        }

        .setlist-name {
            flex: 1;
            min-width: 0; /* Prevent overflow */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #setlist-details-toggle {
            padding: 0.5rem 0.75rem;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        .dark #setlist-details-toggle {
            background-color: #374151;
        }
        #setlist-details-toggle .toggle-arrow {
            transition: transform 0.2s ease-in-out;
        }
        #setlist-details-toggle.open .toggle-arrow {
            transform: rotate(180deg);
        }

        #setlist-details-content {
            display: none; /* Initial state */
            flex-direction: row; /* Force horizontal layout */
            align-items: flex-end; /* Align items at the bottom */
            gap: 1rem;
            padding: 1rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            flex-wrap: wrap;
        }
        #setlist-details-content > div {
            display: flex;
            flex-direction: column; /* Stack label/input vertically within their group */
            gap: 0.25rem;
        }
        .dark #setlist-details-content {
            background-color: #374151;
        }
        .dark #setlist-details-content label,
        .dark #setlist-details-content input,
        .dark #setlist-details-content select {
            color: #f9fafb !important;
        }
       
        #setlist-details-content input, #setlist-details-content select {
            box-sizing: border-box;
            border: 1px solid #d1d5db;
        }
        .dark #setlist-details-content input, .dark #setlist-details-content select {
            border-color: #4b5563;
        }
       
        /* --- FIX: Consistent size for setlist detail inputs & placeholder styling --- */
        #setlist-date, #setlist-venue, #setlist-sort-filter-dropdown {
            width: 176px; /* 11rem, w-44 */
            padding: 0.25rem 0.5rem; /* Add consistent padding */
            height: 34px; /* Consistent height */
        }
        #setlist-date-container {
            position: relative;
        }
        #date-placeholder {
            position: absolute;
            top: 28px;
            left: 6px;
            pointer-events: none;
            color: #9ca3af; /* Light mode placeholder color */
        }
        .dark #date-placeholder {
            color: #ffffff;
        }
        .dark #setlist-venue::placeholder {
             color: #ffffff;
        }
        .dark #setlist-date {
            color: #f9fafb; /* Ensure text is white */
        }
        .dark #setlist-date::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }


        .drag-highlight {
            background-color: #dbeafe;
            border: 2px dashed #3b82f6;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
        }

        .dark .drag-highlight {
            background-color: #1e3a8a;
        }

        .app-header {
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            transition: background 0.3s ease;
            cursor: pointer;
        }
        .app-header-selected {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .app-header-unselected {
            background: #374151;
        }
        .app-header-unselected:hover {
            background: #4b5563;
        }

        .stats-container {
            background-color: #f3f4f6;
            border-radius: 0.75rem;
            color: #1f2937;
            max-height: 200px;
            overflow-y: auto;
            margin-top: auto; /* Pushes to bottom */
            flex-shrink: 0; /* Prevent shrinking */
            padding: 0.5rem;
        }

        .dark .stats-container {
            background-color: #374151;
            color: #d1d5db;
        }

        .stats-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1e40af;
        }

        .dark .stats-title {
            color: #60a5fa;
        }
        
        .left-col {
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: width 0.4s ease-in-out, padding 0.4s ease-in-out;
            position: relative;
            padding: 1rem;
        }

        /* --- FIX: Wider, styled scrollbars moved to the edge --- */
        .left-col-main-content {
            margin-right: -1rem; /* Pull scrollbar to the edge */
            padding-right: 1rem; /* Add padding to compensate for margin */
            /* Add transition for smooth fade out */
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
.stats-container {
            /* Match the width of other sidebar blocks: no negative margins */
            margin-right: 0;
            padding-right: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .left-col-main-content::-webkit-scrollbar,
        .stats-container::-webkit-scrollbar {
            width: 16px; /* Wider track for a larger touch target */
        }
        .left-col-main-content::-webkit-scrollbar-track,
        .stats-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .left-col-main-content::-webkit-scrollbar-thumb,
        .stats-container::-webkit-scrollbar-thumb {
            background-color: #6b7280;
            border-radius: 8px;
            border: 4px solid transparent; /* Keep thumb wide */
            background-clip: content-box; /* Makes the border an invisible padding */
        }
        .left-col-main-content::-webkit-scrollbar-thumb:hover,
        .stats-container::-webkit-scrollbar-thumb:hover {
            background-color: #9ca3af;
        }
        
        .left-col-main-content {
            overflow-y: auto;
            overflow-x: hidden; /* PREVENT HORIZONTAL SCROLL */
            flex-grow: 1;
            margin-bottom: 1rem; /* Gap between venues and stats */
        }

        .left-col.collapsed {
            width: 0;
            padding: 0; /* Ensures no leftover space */
            overflow: hidden; /* Hides content fully */
        }
        
        /* New rule to hide sidebar content during collapse */
        .left-col.collapsed .left-col-main-content,
        .left-col.collapsed .stats-container {
            opacity: 0;
            visibility: hidden;
        }

        #sidebar-toggle {
            background-color: #1f2937;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px; /* Increased width */
            height: 60px;
            border-radius: 0 8px 8px 0;
            flex-shrink: 0;
            transition: all 0.3s ease-in-out;
        }

        #sidebar-toggle:hover {
            background-color: #374151;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-radius: 0.5rem;
            margin-bottom: 4px;
            background: #374151;
            cursor: pointer;
            color: #e5e7eb;
            transition: background-color 0.2s;
            overflow: hidden; /* Fix width issues */
        }
        .sidebar-item:hover {
            background: #4b5563;
        }

        /* Reverted Genre/Venue Creation Style */
        .item-creation {
            display: flex;
            gap: 8px;
            align-items: center;
            background-color: #1f2937;
            padding: 8px;
            border-radius: 8px;
            margin-top: 8px;
        }
        .item-creation .item-name-input {
             flex-grow: 1;
             background-color: #374151;
             border: 1px solid #4b5563;
             padding: 4px 8px;
             border-radius: 4px;
             color: white;
             min-width: 0; /* FIX: Allows input to shrink to fit */
        }
        /* Wrapper for custom color input */
        .color-picker-wrapper {
            position: relative;
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        #genre-color-display {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-image: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);
            transition: background 0.2s;
        }
        #genre-color {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }


        .genre-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
            min-width: 0; /* Prevent overflow */
        }
        .genre-name, .venue-name {
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-genre,
        .delete-venue {
            color: #ef4444;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .delete-genre:hover,
        .delete-venue:hover {
            background-color: #fee2e2;
        }

        .dark .delete-genre:hover,
        .dark .delete-venue:hover {
            background-color: #991b1b;
        }
        
        /* CORRECTED Dark Mode Toggle Visual */
        .dark-mode-toggle+div {
            transition: all 0.3s ease;
        }
        .dark-mode-toggle+div .dot {
            transition: all 0.3s ease;
        }
        /* Dark mode on (checked) */
        .dark-mode-toggle:checked+div {
            background-color: #22c55e;
        }
        .dark-mode-toggle:checked+div .dot {
            transform: translateX(1px); /* Ball is on the LEFT */
        }
        /* Light mode on (not checked) */
        .dark-mode-toggle:not(:checked)+div {
            background-color: #1f2937; /* Black */
        }
        .dark-mode-toggle:not(:checked)+div .dot {
            transform: translateX(20px); /* Ball is on the RIGHT */
        }

        /* Highly specific selector for viewed number color */
        #setlist-list li .index-number.viewed-index {
            background-color: white;
            color: #3b82f6 !important; /* Blue button color */
            border: 1px solid #3b82f6;
            font-weight: bold;
            font-size: 1.125rem; /* Even bigger when viewed */
        }
        
        /* === Redesigned Responsive Controls for Master View === */
        #master-view-controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        #search-container {
            position: relative;
        }
        #search {
            padding-right: 120px; /* Make space for the toggle */
        }
        #dark-mode-container {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
        }
        /* Sort dropdown width fix */
        #controls-row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap; /* Allow controls to wrap on small screens */
        }
        #filters-group {
            display: flex;
            flex-grow: 1; /* Allows this to expand */
            gap: 0.5rem;
            padding: 0.25rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            min-width: 200px;
        }
        #sort-dropdown {
            flex-grow: 1; /* The dropdown itself expands */
        }
        .dark #filters-group {
            background-color: #1f2937;
        }

        #master-view-buttons {
            flex-shrink: 0; /* Prevent buttons from shrinking */
        }

        #master-view-buttons .btn-master {
            width: 90px; /* Reduced button size */
        }
        .filter-select, #genre-filter-button {
            border: none;
            background: none;
            appearance: none;
            padding: 0.5rem;
        }
        #genre-filter-button {
            width: auto;
            min-width: 100px; /* Reduced min-width */
        }
        
        /* === Redesigned Grid Layout for Song Item Details === */
        .song-details-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            flex-shrink: 0; /* Prevent from being overlapped */
        }
        .song-details-container input, .song-details-container .delete-btn {
            width: 96px; /* Reduced width */
            text-align: center; /* Center text in inputs */
        }
        .song-details-container .delete-btn {
            width: 72px; /* Reduced width */
        }
        
        .left-col:not(.collapsed) ~ main .song-details-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            width: 220px; /* Reduced width */
            gap: 0.5rem;
            align-items: stretch; /* Ensures items fill the cell height */
        }
        .left-col:not(.collapsed) ~ main .song-details-container input,
        .left-col:not(.collapsed) ~ main .song-details-container button {
            width: 100%; /* Make items fill the grid cell */
            height: 100%;
        }
        
        /* === Setlist View 1-Column Layout === */
        .setlist-view-container {
            display: flex;
            flex-direction: column; /* Stack panels vertically */
            gap: 1rem;
            height: calc(100% - 150px); /* Adjust based on controls height */
            min-height: 0;
        }
        .setlist-panel {
            display: flex;
            flex-direction: column;
            min-height: 0;
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.1);
            overflow: hidden;
            flex: 1; /* Allow panels to share space */
        }
        .dark .setlist-panel {
            background-color: #1f2937;
        }
        .setlist-panel > .panel-header {
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            background-color: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        .dark .setlist-panel > .panel-header {
            background-color: #374151;
            border-bottom-color: #4b5563;
        }
        .setlist-panel > ul {
            overflow-y: auto;
            flex-grow: 1;
        }
        
        /* Add Songs panel with custom checkboxes */
        .add-song-item {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
        }
        .dark .add-song-item {
            border-bottom-color: #374151;
        }
        .add-song-item > label {
            display: flex;
            align-items: center;
            width: 100%;
            cursor: pointer;
            padding: 0.75rem 0.5rem;
        }
        .add-song-item > label:hover .custom-checkbox-box {
            background-color: #2563eb; /* Darker blue on hover */
        }
        .custom-checkbox-input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        .custom-checkbox-box {
            width: 1.25rem;
            height: 1.25rem;
            background-color: #3b82f6; /* Blue */
            border-radius: 0.25rem;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .custom-checkbox-box svg {
            opacity: 0;
            transition: opacity 0.2s;
            width: 1rem;
            height: 1rem;
            stroke: white;
            stroke-width: 2.5;
        }
        .custom-checkbox-input:checked ~ .custom-checkbox-box svg {
            opacity: 1;
        }


        /* Consistent border on all song list items */
        #master-list > li, #setlist-list > li, #favorites-list > li, #genre-song-list > li, #plays-list > li, .add-song-item {
            border-bottom-width: 1px;
        }
        #master-list, #setlist-list, #favorites-list, #genre-song-list, #plays-list, #setlist-add-songs-list {
            border-color: #e5e7eb;
        }
        .dark #master-list, .dark #setlist-list, .dark #favorites-list, .dark #genre-song-list, .dark #plays-list, .dark #setlist-add-songs-list {
            border-color: #374151;
        }
        
        /* Touch Device Enhancements */
        main.overflow-auto,
        .setlist-songs-container,
        #genre-filter-dropdown {
            -webkit-overflow-scrolling: touch;
        }

        #master-list > li, #setlist-list > li, #favorites-list > li, #plays-list > li, #genre-song-list > li {
            padding-top: 1rem;
            padding-bottom: 1rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        #plays-list > li {
            padding-left: 1rem;
        }

        /* Single Favorite Star Fix */
        .favorite-star-container svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: #9ca3af; /* Gray outline */
            stroke-width: 1.5;
            transition: all 0.2s;
        }
        .favorite-star-container.favorited svg {
            fill: white;
            stroke: #4b5563; /* Dark outline for visibility on light backgrounds */
        }
        .dark .favorite-star-container.favorited svg {
            stroke: white; /* White outline on dark backgrounds */
        }
    
        /* === iOS PDF scrolling fix: disable 3D transforms around iframe/object so all pages scroll === */
        html.ios #doc-iframe-wrapper { perspective: none !important; }
        html.ios .doc-iframe-container { 
            transform: none !important;
            transition: none !important;
            backface-visibility: visible !important;
            overflow: auto !important;
        }
        html.ios .doc-iframe-container.current,
        html.ios .doc-iframe-container.next,
        html.ios .doc-iframe-container.prev {
            transform: none !important;
        }
        html.ios .turning-next,
        html.ios .turning-prev,
        html.ios .incoming-next,
        html.ios .incoming-prev {
            transform: none !important;
        }
        /* Ensure embedded document fills available space and scrolls smoothly on iPad */
        html.ios #doc-object,
        html.ios .doc-iframe-container iframe,
        html.ios .doc-iframe-container embed,
        html.ios .doc-iframe-container object {
            width: 100% !important;
            height: 100% !important;
            display: block !important;
        }
        html.ios .doc-view-fullscreen {
            overflow: hidden;
        }
        html.ios .doc-iframe-container {
            -webkit-overflow-scrolling: touch;
        }
        /* === Fix All Songs scroll and clipping === */
        /* Let MAIN be the only scroll container; don't constrain the white card */
        #master-view > .bg-white {
            overflow: visible; /* don't clip last item inside rounded container */
        }
        /* Smooth iOS momentum and bottom padding so the last row isn't cut off */
        #master-list { 
            -webkit-overflow-scrolling: touch;
            padding-bottom: 1rem;
        }
        /* Momentum scrolling for setlist lists */
        #setlist-list,
        #setlist-add-songs-list {
            -webkit-overflow-scrolling: touch;
        }
        /* === Scrolling quality improvements === */
        main {
            overflow-y: auto; /* main is the scroll container */
            -webkit-overflow-scrolling: touch;
        }
        /* Hint to the browser: vertical pans are scrolls, not drags */
        #master-list, #setlist-list, #setlist-add-songs-list, #favorites-list, #genre-song-list, #plays-list {
            touch-action: pan-y;
        }
        /* === Left-edge custom scrollbar for collapsed sidebar === */
        #edge-scrollbar {
            position: fixed;
            left: 0;
            top: 0;
            width: 18px;              /* track width */
            height: 100vh;
            z-index: 120;             /* above app content, below nav buttons */
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;     /* let pointer events pass except on the thumb */
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        /* Subtle dark translucent track, centered line */
        #edge-scrollbar::before {
            content: "";
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 92vh;
            top: 4vh;
            border-radius: 9999px;
            background: rgba(0,0,0,0.25);
        }
        .dark #edge-scrollbar::before {
            background: rgba(255,255,255,0.12);
        }
        #edge-thumb {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;               /* white line */
            height: 60px;             /* will be sized by JS */
            border-radius: 9999px;    /* soft edges */
            background: #ffffff;
            box-shadow: 0 0 8px rgba(255,255,255,0.8), 0 0 2px rgba(0,0,0,0.2);
            pointer-events: auto;     /* interactive */
            touch-action: none;       /* we manage drag */
        }
        .dark #edge-thumb {
            background: #ffffff;
            box-shadow: 0 0 8px rgba(255,255,255,0.8), 0 0 2px rgba(0,0,0,0.4);
        }
        /* Visible state */
        #edge-scrollbar.visible {
            opacity: 1;
            pointer-events: none; /* only thumb is interactive */
        }
        /* Twinkle animation for energy level 3 sparks */
        @keyframes energy-twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.95); }
            50%      { opacity: 1; transform: scale(1.05); }
        }
        .energy-svg-3 .energy-spark {
            animation: energy-twinkle 1.2s ease-in-out infinite;
        }
        .energy-svg-3 .energy-spark:nth-child(2) { animation-delay: 0.2s; }
        .energy-svg-3 .energy-spark:nth-child(3) { animation-delay: 0.4s; }
        .energy-svg-3 .energy-spark:nth-child(4) { animation-delay: 0.6s; }
        .energy-svg-3 .energy-spark:nth-child(5) { animation-delay: 0.8s; }
        /* === Smooth sidebar closing/opening with curtain cover === */
        .left-col {
            position: relative;
            z-index: 20;              /* ensure it sits above main while animating */
            overflow: hidden;         /* hide inner content during slide */
        }
        main {
            position: relative;
            z-index: 10;
        }
        /* Curtain overlay that sweeps over options while closing */
        .left-col::after {
            content: "";
            position: absolute;
            inset: 0;
            background: #1f2937;      /* matches .left-col dark bg */
            opacity: 0;
            transform: translateX(-10%);
            transition: transform 0.35s ease, opacity 0.25s ease;
            pointer-events: none;
        }
        .dark .left-col::after {
            background: #000000;
        }
        /* When closing, fade in the curtain and sweep it right to cover items smoothly */
        .left-col.closing::after {
            opacity: 1;
            transform: translateX(0);
        }
        /* Optional subtle blur of inner items when closing */
        .left-col.closing .left-col-main-content,
        .left-col.closing .stats-container {
            filter: blur(1px);
        }
        /* Keep width/padding transitions already present; improve easing */
        .left-col {
            transition: width 0.4s cubic-bezier(0.4, 0.0, 0.2, 1), padding 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        main {
            transition: margin 0.4s cubic-bezier(0.4, 0.0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

    

/* === External scrollbar for Top/Least Played (non-intrusive box size) === */
.stats-container {
    /* Keep size exactly the same but hide native scrollbar */
    scrollbar-width: none; /* Firefox */
}
.stats-container::-webkit-scrollbar { width: 0 !important; height: 0 !important; } /* WebKit/iPad */

/* External scrollbar rail positioned on the black sidebar edge */
#stats-external-scroll {
    position: absolute;
    right: 0;                /* far-right, same lane as main sidebar scrollbar */
    width: 12px;             /* visual width */
    background: transparent; /* no background, sits on black */
    display: none;           /* toggled on when stats container is found */
    z-index: 2;
}

#stats-external-scroll .track {
    position: absolute;
    left: 0; top: 0; right: 0; bottom: 0;
    border-radius: 8px;
}

#stats-thumb {
    position: absolute;
    left: 2px;
    width: 8px;
    border-radius: 8px;
    background: rgba(255,255,255,0.5);
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    touch-action: none;
}
#stats-external-scroll:hover #stats-thumb { background: rgba(255,255,255,0.7); }


/* inline-rename */
.song-name.renaming { contain: layout paint; } /* isolate to avoid shifts */
.edit-input { font-size: 0.95rem; font-weight: 600; }
@media (prefers-color-scheme: dark) {
  .edit-input { background: #111827; color: #e5e7eb; border-color: #2563eb; }
}

/* inline-rename v2 */
.song-name.renaming { contain: layout paint; position: relative; }
.song-name.renaming .edit-input { font-family: inherit; font-size: 0.95rem; font-weight: 600; }
@media (prefers-color-scheme: dark) {
  .song-name.renaming .edit-input { background: #111827; color: #e5e7eb; border-color: #2563eb; }
}

/* magic-square exact-fit */
.song-name.renaming .edit-magic-square {
  padding: 0 !important;
  box-sizing: border-box !important;
  background: #ffffff !important;
  color: #2563eb !important;
  border: 2px solid #2563eb !important;
}

/* magic-square contenteditable */
.song-name.renaming .edit-magic-square {
  padding: 0 !important;
  box-sizing: border-box !important;
  background: #ffffff !important;
  color: #2563eb !important;
  border: 2px solid #2563eb !important;
  outline: none !important;
}
/* Keep siblings from shifting during edit */
.song-name.renaming { position: relative; }

        /* === iPad multipage viewer (Option B) === */
        html.doc-viewer-active, body.doc-viewer-active {
            position: static !important;
            overflow: auto !important;
            height: 100% !important;
        }
        /* Make the document wrapper the scroller while viewer is open */
        .doc-viewer-active #doc-iframe-wrapper {
            overflow: auto !important;
            -webkit-overflow-scrolling: touch !important;
        }
        /* Remove transforms/perspective in viewer ancestry on iOS (prevents single-page snapshot) */
        html.ios.doc-viewer-active #doc-view,
        html.ios.doc-viewer-active #doc-iframe-wrapper,
        html.ios.doc-viewer-active .doc-iframe-container,
        html.ios.doc-viewer-active .incoming-next,
        html.ios.doc-viewer-active .incoming-prev,
        html.ios.doc-viewer-active .turning-next,
        html.ios.doc-viewer-active .turning-prev {
            transform: none !important;
            perspective: none !important;
            backface-visibility: visible !important;
            will-change: auto !important;
            filter: none !important;
        }
        /* PDF.js container styles */
        .pdfjs-container { position:absolute; inset:0; overflow:auto; -webkit-overflow-scrolling:touch; padding: 8px; }
        .pdfjs-page { margin: 0 auto 10px auto; }
        .pdfjs-page canvas { display:block; width:100% !important; height:auto !important; background:#fff; border-radius:6px; }


        /* === Top-level PDF overlay (outside all transforms) === */
        #pdf-overlay {
          position: fixed; inset: 0; z-index: 999999;
          background: #000;
          display: none;
        }
        html.pdf-overlay-active, body.pdf-overlay-active {
          position: static !important;
          overflow: auto !important;
          height: 100% !important;
        }
        html.ios #pdf-overlay, html.ios #pdf-overlay * {
          transform: none !important;
          perspective: none !important;
          backface-visibility: visible !important;
          will-change: auto !important;
          filter: none !important;
        }
        #pdf-overlay .pdfjs-scroll {
          position: absolute; inset: 0;
          overflow: auto; -webkit-overflow-scrolling: touch;
          padding: 12px 12px 72px;
        }
        #pdf-overlay .pdfjs-page { margin: 0 auto 12px; }
        #pdf-overlay .pdfjs-page canvas {
          display: block; width: 100% !important; height: auto !important;
          background: #fff; border-radius: 6px;
        }

        /* === Setlist Details: unified centered placeholders (Date, Venue, Order) === */
        #setlist-details-content input,
        #setlist-details-content select {
          height: 34px;
          font-size: 14px;
          font-weight: 600;
          text-align: center;          /* center typed text */
        }

        /* Centered white placeholder for Venue */
        #setlist-venue::placeholder {
          color: #ffffff !important;
          opacity: 1;
          text-align: center;
        }

        /* Date "placeholder" is a sibling span because date inputs don't support ::placeholder reliably */
        #setlist-date-container {
          position: relative;
        }
        #date-placeholder {
          position: absolute;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          font-size: 14px;
          font-weight: 600;
          color: #ffffff !important;   /* always white */
          pointe...(truncated 118937 characters)...el) el.value = val; else el.innerText = val;
        try { el.dispatchEvent(new Event('input', { bubbles:true })); el.dispatchEvent(new Event('change', { bubbles:true })); } catch(e){}
      }
      pop.style.display = 'none';
      overlay.style.display = 'none';
      document.documentElement.classList.remove('notes-popover-open');
      document.body.classList.remove('notes-popover-open');
      window.__notesActiveSource = null;
    });
    close && close.addEventListener('click', function(){
      // Save on close
      var val = area.value;
      if (window.__notesActiveSource) {
        var el = window.__notesActiveSource;
        if ('value' in el) el.value = val; else el.innerText = val;
        try { el.dispatchEvent(new Event('input', { bubbles:true })); el.dispatchEvent(new Event('change', { bubbles:true })); } catch(e){}
      }
      pop.style.display = 'none';
      overlay.style.display = 'none';
      document.documentElement.classList.remove('notes-popover-open');
      document.body.classList.remove('notes-popover-open');
      window.__notesActiveSource = null;
    });
  }

  fastHook('.notes-input', function(ev, el){
    // Open instantly and suppress the input's own focus/flash
    ev.preventDefault();
    window.__notesActiveSource = el;
    openNotesFrom(el);
  });
})();

/* --- 2) Setlist dragging: switch to name-only when leaving setlist box; do not reorder outside --- */
(function(){
  if (window.__SetlistDragNameOnly_v1) return;
  window.__SetlistDragNameOnly_v1 = true;

  function getSetlistRect(){
    var el = document.getElementById('setlist-list');
    return el ? el.getBoundingClientRect() : null;
  }

  function isInsideRect(pt, rect){
    return rect && pt.x >= rect.left && pt.x <= rect.right && pt.y >= rect.top && pt.y <= rect.bottom;
  }

  // Attach a jQuery UI draggable specifically for setlist items, without touching existing sortables
  function init(){
    var $list = window.jQuery && window.jQuery('#setlist-list');
    if (!$list || !$list.length) return;

    // Delegate to dynamic items
    $list.on('mousedown touchstart', '.setlist-item', function(){
      var $item = window.jQuery(this);
      if ($item.data('hasExportDrag')) return; // only once
      $item.data('hasExportDrag', true);

      $item.draggable({
        helper: function(){
          var name = ($item.find('.song-name-text').text() || $item.text() || '').trim();
          var $h = window.jQuery('<div class="drag-helper drag-name-only draggable">'+name+'</div>');
          $h.data('name', name);
          return $h;
        },
        appendTo: 'body',
        containment: 'document',
        distance: 4;
        zIndex: 2147483645,
        start: function(e, ui){
          $item.data('exporting', false);
          $item.addClass('dragging-from-setlist');
          $list.sortable('enable'); // ensure enabled at start
          $item.data('setlistRect', getSetlistRect());
        },
        drag: function(e, ui){
          var rect = $item.data('setlistRect') || getSetlistRect();
          var pt = { x: (e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX) || ui.position.left),
                     y: (e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY) || ui.position.top) };
          var inside = isInsideRect(pt, rect);
          if (!inside && !$item.data('exporting')){
            // Leaving setlist: switch to name-only visual and DISABLE reordering
            $item.data('exporting', true);
            try { $list.sortable('disable'); } catch(err){}
            ui.helper.addClass('drag-name-only');
          } else if (inside && $item.data('exporting')){
            // Back inside: allow reordering again
            $item.data('exporting', false);
            try { $list.sortable('enable'); } catch(err){}
            ui.helper.removeClass('drag-name-only').text(ui.helper.data('name'));
          }
        },
        stop: function(e, ui){
          // Always re-enable sortable to keep in-list reordering perfect
          try { $list.sortable('enable'); } catch(err){}
          $item.removeClass('dragging-from-setlist').data('exporting', false);
        }
      });
    });
  }

  // Try now and retry a few times for late DOM
  init();
  var tries = 0, t = setInterval(function(){ tries++; init(); if (tries>20) clearInterval(t); }, 200);
})();
</script>


<style id="setlist-export-chip-styles">
/* Blue name-only ghost chip (separate overlay that follows cursor) */
#setlist-export-ghost{
  position:fixed; top:0; left:0;
  transform:translate(-9999px,-9999px);
  padding:6px 10px; border-radius:8px;
  background:rgba(59,130,246,.95); color:#fff;
  font-size:14px; line-height:1.2;
  box-shadow:0 6px 16px rgba(0,0,0,.25);
  border:1px solid rgba(59,130,246,1);
  max-width:50vw; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;
  pointer-events:none; z-index:2147483646; opacity:0; transition:opacity 50ms linear;
}
/* Keep placeholder from jumping while exporting */
.ui-sortable-placeholder.setlist-exporting{
  visibility:hidden!important; height:0!important; margin:0!important; padding:0!important; border:0!important;
}
/* Freeze the big helper at the edge (dont let it move outside) */
.ui-sortable-helper.setlist-helper-frozen{
  position:fixed !important; pointer-events:none !important; z-index:2147483645 !important;
}
</style>

<script>
/* Setlist export behavior (v12  dual-visual + frozen helper, non-destructive)
   - Inside setlist: normal reorder + full-size helper (unchanged).
   - When pointer leaves the setlist box: show BLUE name-only ghost that follows cursor; freeze the big helper at the boundary.
   - While outside: keep sortable responsive; pin placeholder at the original index so the order doesnt change.
   - Re-enter: hide ghost + unfreeze helper.
   - Stop: cleanup so nothing remains name-only or frozen.
*/
(function(){
  if (window.__SetlistExportBehavior_v12) return;
  window.__SetlistExportBehavior_v12 = true;

  function $jq(){ return window.jQuery || window.$; }
  var $ = $jq(); if (!$) return;

  // Single reusable ghost
  var ghost = document.createElement('div');
  ghost.id = 'setlist-export-ghost';
  document.body.appendChild(ghost);

  function setGhost(text){ ghost.textContent = text || ''; }
  function showGhostAt(cx, cy){
    ghost.style.transform = 'translate(' + (cx + 8) + 'px,' + (cy + 8) + 'px)';
    if (ghost.style.opacity !== '1') ghost.style.opacity = '1';
  }
  function hideGhost(){
    ghost.style.opacity = '0';
    ghost.style.transform = 'translate(-9999px,-9999px)';
  }

  function getItemName($item){
    var name = '';
    try{
      var $name = $item.find('.song-name, .song-name-text, .file-name, [data-role=\"song-name\"]').first();
      name = ($name.text()||'').trim(); if (!name) name = ($item.text()||'').trim();
    }catch(e){}
    return name || 'Untitled';
  }

  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

  function attach($list){
    var inst = $list.data('ui-sortable') || $list.data('sortable');
    if (!inst) return;

    var exporting = false;
    var $placeholder = null, $currentItem = null;
    var startIndex = null;
    var rect = null;
    var frozenAt = null; // client coords at boundary

    // Preserve existing callbacks
    var orig = {
      start:  $list.sortable('option','start'),
      sort:   $list.sortable('option','sort'),
      change: $list.sortable('option','change'),
      over:   $list.sortable('option','over'),
      out:    $list.sortable('option','out'),
      stop:   $list.sortable('option','stop')
    };

    function updateRect(){
      var box = $list.get(0).getBoundingClientRect();
      rect = { left: box.left, top: box.top, right: box.right, bottom: box.bottom };
    }
    function inside(cx, cy){ return cx >= rect.left && cx <= rect.right && cy >= rect.top && cy <= rect.bottom; }

    function eventClientXY(e){
      var oe = (e && e.originalEvent) || e;
      var t = (oe && oe.touches && oe.touches[0]) || (oe && oe.changedTouches && oe.changedTouches[0]);
      if (t) return { x: t.clientX, y: t.clientY };
      if (typeof e.clientX === 'number') return { x: e.clientX, y: e.clientY };
      return { x: rect.left, y: rect.top };
    }

    function freezeHelperAtEdge(cx, cy){
      var $helper = $('.ui-sortable-helper');
      if (!$helper.length) return;
      // Freeze at nearest edge point
      var fx = clamp(cx, rect.left, rect.right);
      var fy = clamp(cy, rect.top, rect.bottom);
      if (cx < rect.left)  fx = rect.left;
      if (cx > rect.right) fx = rect.right;
      if (cy < rect.top)   fy = rect.top;
      if (cy > rect.bottom)fy = rect.bottom;
      frozenAt = { x: fx, y: fy };
      var w = $helper.outerWidth(), h = $helper.outerHeight();
      $helper.addClass('setlist-helper-frozen')
             .css({ left: (fx - Math.round(w/2)) + 'px', top: (fy - Math.round(h/2)) + 'px' });
    }

    function updateFrozenHelper(){
      if (!frozenAt) return;
      var $helper = $('.ui-sortable-helper');
      if ($helper.length && $helper.hasClass('setlist-helper-frozen')){
        var w = $helper.outerWidth(), h = $helper.outerHeight();
        $helper.css({ left: (frozenAt.x - Math.round(w/2)) + 'px', top: (frozenAt.y - Math.round(h/2)) + 'px' });
      }
    }

    function unfreezeHelper(){
      var $helper = $('.ui-sortable-helper');
      if ($helper.length){
        $helper.removeClass('setlist-helper-frozen').css({ left:'', top:'' });
      }
      frozenAt = null;
    }

    function toExportMode(cx, cy){
      if (exporting) return;
      exporting = true;
      setGhost(getItemName($currentItem)); showGhostAt(cx, cy);
      if ($placeholder) $placeholder.addClass('setlist-exporting');
      freezeHelperAtEdge(cx, cy);
    }

    function toReorderMode(){
      if (!exporting) return;
      exporting = false;
      hideGhost();
      if ($placeholder) $placeholder.removeClass('setlist-exporting');
      unfreezeHelper();
    }

    function hardCleanup(){
      exporting = false; hideGhost(); unfreezeHelper();
      if ($placeholder) $placeholder.removeClass('setlist-exporting');
      $placeholder = null; $currentItem = null; startIndex = null; rect = null; frozenAt = null;
    }

    function keepPlaceholderPinned(){
      if (!exporting || !$placeholder || startIndex == null) return;
      var $children = $list.children(':visible');
      if (!$children.length) return;
      var idx = Math.max(0, Math.min(startIndex, $children.length - 1));
      var $anchor = $children.eq(idx);
      if ($anchor.length && !$placeholder.is($anchor.next())){ $placeholder.insertAfter($anchor); }
      $placeholder.addClass('setlist-exporting');
    }

    $list.sortable('option','start', function(e, ui){
      exporting = false;
      $placeholder = ui.placeholder; $currentItem = ui.item; startIndex = ui.item.index();
      updateRect(); hideGhost(); unfreezeHelper();
      if (orig.start) orig.start.call(this, e, ui);
    });

    $list.sortable('option','sort', function(e, ui){
      if (!rect) updateRect();
      var p = eventClientXY(e);
      if (inside(p.x, p.y)){
        toReorderMode();
      } else {
        if (!exporting) toExportMode(p.x, p.y);
        showGhostAt(p.x, p.y);
        updateFrozenHelper();
        keepPlaceholderPinned();
      }
      if (orig.sort) orig.sort.call(this, e, ui);
    });

    $list.sortable('option','over', function(e, ui){
      toReorderMode();
      if (orig.over) orig.over.call(this, e, ui);
    });

    $list.sortable('option','out', function(e, ui){
      var p = eventClientXY(e);
      if (!rect) updateRect();
      toExportMode(p.x, p.y);
      if (orig.out) orig.out.call(this, e, ui);
    });

    $list.sortable('option','change', function(e, ui){
      keepPlaceholderPinned();
      if (orig.change) orig.change.call(this, e, ui);
    });

    $list.sortable('option','stop', function(e, ui){
      hardCleanup();
      if (orig.stop) orig.stop.call(this, e, ui);
    });

    window.addEventListener('scroll', function(){ if ($currentItem) updateRect(); }, { passive:true });
    window.addEventListener('resize', function(){ if ($currentItem) updateRect(); }, { passive:true });
  }

  function init(){
    var $list = $('#setlist-list'); // adjust if your setlist uses a different selector
    if ($list.length){ attach($list); }
  }

  init();
  var tries = 0, t = setInterval(function(){ tries++; init(); if (tries>20) clearInterval(t); }, 200);
})();
</script>


<style id="setlist-export-chip-styles">
#setlist-export-ghost{
  position:fixed; top:0; left:0;
  transform:translate(-9999px,-9999px);
  padding:6px 10px; border-radius:8px;
  background:rgba(59,130,246,.95); color:#fff;
  font-size:14px; line-height:1.2;
  box-shadow:0 6px 16px rgba(0,0,0,.25);
  border:1px solid rgba(59,130,246,1);
  max-width:50vw; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;
  pointer-events:none; z-index:2147483646; opacity:0; transition:opacity 50ms linear;
}
.ui-sortable-placeholder.setlist-exporting{
  visibility:hidden!important; height:0!important; margin:0!important; padding:0!important; border:0!important;
}
.ui-sortable-helper.setlist-helper-frozen{
  position:fixed !important; pointer-events:none !important; z-index:2147483645 !important;
}
</style>
<script>
(function(){
  if (window.__SetlistExportBehavior_v13) return;
  window.__SetlistExportBehavior_v13 = true;
  function $jq(){ return window.jQuery || window.$; }
  var $ = $jq(); if (!$) return;

  var ghost = document.createElement('div');
  ghost.id = 'setlist-export-ghost';
  document.body.appendChild(ghost);

  function setGhost(text){ ghost.textContent = text || ''; }
  function showGhostAt(cx, cy){ ghost.style.transform = 'translate('+(cx+8)+'px,'+(cy+8)+'px)'; ghost.style.opacity = '1'; }
  function hideGhost(){ ghost.style.opacity = '0'; ghost.style.transform = 'translate(-9999px,-9999px)'; }

  function getItemName($item){
    var n=''; try{ var $n=$item.find('.song-name, .song-name-text, .file-name, [data-role="song-name"]').first();
      n = ($n.text()||'').trim(); if(!n) n=($item.text()||'').trim(); }catch(e){}
    return n || 'Untitled';
  }
  function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

  function attach($list){
    var inst = $list.data('ui-sortable') || $list.data('sortable'); if(!inst) return;
    var exporting=false, $ph=null, $item=null, startIndex=null, rect=null, frozenAt=null;

    var orig = {
      start:$list.sortable('option','start'),
      sort:$list.sortable('option','sort'),
      change:$list.sortable('option','change'),
      over:$list.sortable('option','over'),
      out:$list.sortable('option','out'),
      stop:$list.sortable('option','stop'),
      update:$list.sortable('option','update'),
      receive:$list.sortable('option','receive')
    };

    function updateRect(){ var r=$list.get(0).getBoundingClientRect(); rect={left:r.left, top:r.top, right:r.right, bottom:r.bottom}; }
    function inside(x,y){ return x>=rect.left && x<=rect.right && y>=rect.top && y<=rect.bottom; }
    function evtXY(e){
      var oe=(e&&e.originalEvent)||e, t=(oe&&oe.touches&&oe.touches[0])||(oe&&oe.changedTouches&&oe.changedTouches[0]);
      if(t) return {x:t.clientX,y:t.clientY}; if(typeof e.clientX==='number') return {x:e.clientX,y:e.clientY};
      return {x:rect.left,y:rect.top};
    }

    function freezeAtEdge(cx,cy){
      var $h=$('.ui-sortable-helper'); if(!$h.length) return;
      var fx=clamp(cx,rect.left,rect.right), fy=clamp(cy,rect.top,rect.bottom);
      if(cx<rect.left)fx=rect.left; if(cx>rect.right)fx=rect.right; if(cy<rect.top)fy=rect.top; if(cy>rect.bottom)fy=rect.bottom;
      frozenAt={x:fx,y:fy};
      var w=$h.outerWidth(), h=$h.outerHeight();
      $h.addClass('setlist-helper-frozen').css({ left:(fx-Math.round(w/2))+'px', top:(fy-Math.round(h/2))+'px' });
    }
    function updateFrozen(){
      if(!frozenAt) return; var $h=$('.ui-sortable-helper');
      if($h.length && $h.hasClass('setlist-helper-frozen')){
        var w=$h.outerWidth(), h=$h.outerHeight();
        $h.css({ left:(frozenAt.x-Math.round(w/2))+'px', top:(frozenAt.y-Math.round(h/2))+'px' });
      }
    }
    function unfreeze(){ var $h=$('.ui-sortable-helper'); if($h.length){ $h.removeClass('setlist-helper-frozen').css({left:'',top:''}); } frozenAt=null; }

    function toExport(cx,cy){
      if(exporting) return; exporting=true;
      setGhost(getItemName($item)); showGhostAt(cx,cy);
      if($ph) $ph.addClass('setlist-exporting');
      freezeAtEdge(cx,cy);
    }
    function toReorder(){ if(!exporting) return; exporting=false; hideGhost(); if($ph) $ph.removeClass('setlist-exporting'); unfreeze(); }
    function keepPinned(){
      if(!exporting||!$ph||startIndex==null) return;
      var kids=$list.children(':visible'); if(!kids.length) return;
      var idx=Math.max(0,Math.min(startIndex,kids.length-1)), $a=kids.eq(idx);
      if($a.length && !$ph.is($a.next())) $ph.insertAfter($a);
      $ph.addClass('setlist-exporting');
    }
    function cleanup(){ exporting=false; hideGhost(); unfreeze(); if($ph) $ph.removeClass('setlist-exporting'); $ph=null; $item=null; startIndex=null; rect=null; frozenAt=null; }

    $list.sortable('option','start', function(e,ui){
      exporting=false; $ph=ui.placeholder; $item=ui.item; startIndex=ui.item.index(); updateRect(); hideGhost(); unfreeze();
      if(orig.start) orig.start.call(this,e,ui);
    });
    $list.sortable('option','sort', function(e,ui){
      if(!rect) updateRect(); var p=evtXY(e);
      if(inside(p.x,p.y)){ toReorder(); }
      else { if(!exporting) toExport(p.x,p.y); showGhostAt(p.x,p.y); updateFrozen(); keepPinned(); }
      if(orig.sort) orig.sort.call(this,e,ui);
    });
    $list.sortable('option','over', function(e,ui){ toReorder(); if(orig.over) orig.over.call(this,e,ui); });
    $list.sortable('option','out', function(e,ui){ var p=evtXY(e); if(!rect) updateRect(); toExport(p.x,p.y); if(orig.out) orig.out.call(this,e,ui); });
    $list.sortable('option','change', function(e,ui){ keepPinned(); if(orig.change) orig.change.call(this,e,ui); });

    // Prevent reorder when outside: cancel on update/receive
    $list.sortable('option','update', function(e,ui){ if(exporting){ try{$list.sortable('cancel');}catch(_){ } return; } if(orig.update) orig.update.call(this,e,ui); });
    $list.sortable('option','receive', function(e,ui){ if(exporting){ try{$list.sortable('cancel');}catch(_){ } return; } if(orig.receive) orig.receive.call(this,e,ui); });

    $list.sortable('option','stop', function(e,ui){
      if(exporting){ try{$list.sortable('cancel');}catch(_){ } }
      cleanup(); if(orig.stop) orig.stop.call(this,e,ui);
    });

    window.addEventListener('scroll', function(){ if($item) updateRect(); }, {passive:true});
    window.addEventListener('resize', function(){ if($item) updateRect(); }, {passive:true});
  }

  function init(){ var $list=$('#setlist-list'); if($list.length) attach($list); }
  init(); var tries=0, t=setInterval(function(){ tries++; init(); if(tries>20) clearInterval(t); }, 200);
})();
</script>
<script>

        // === Simple View toggles: sync + body class ===
        (function(){
            function setSimple(on){
                document.body.classList.toggle('simple-view-on', !!on);
                var a=document.getElementById('simple-view-toggle');
                var b=document.getElementById('simple-view-toggle-setlist');
                if(a) a.checked=!!on; if(b) b.checked=!!on;
            }
            function init(){
                var a=document.getElementById('simple-view-toggle');
                var b=document.getElementById('simple-view-toggle-setlist');
                function onChange(e){ setSimple((e.target||a||b).checked); }
                if(a) a.addEventListener('change', onChange);
                if(b) b.addEventListener('change', onChange);
                setSimple(document.body.classList.contains('simple-view-on'));
            }
            if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);}else{init();}
        })();

        // === Drag-to-toggle behavior for Simple + Dark/Light ===
        (function(){
            function makeDraggableToggle(input){
                if(!input) return;
                var track=input.nextElementSibling, dot=track?track.nextElementSibling:null;
                var dragging=false,startX=0;
                function down(e){ dragging=true; startX=(e.touches?e.touches[0].clientX:e.clientX);
                    document.addEventListener('pointermove',move);document.addEventListener('pointerup',up);
                    document.addEventListener('touchmove',move,{passive:false});document.addEventListener('touchend',up);
                }
                function move(e){ if(!dragging) return; var x=(e.touches?e.touches[0].clientX:e.clientX); var dx=x-startX;
                    if(Math.abs(dx)>10){ input.checked = dx>0; input.dispatchEvent(new Event('change',{bubbles:true})); }
                    if(e.cancelable) e.preventDefault();
                }
                function up(){ dragging=false;
                    document.removeEventListener('pointermove',move);document.removeEventListener('pointerup',up);
                    document.removeEventListener('touchmove',move);document.removeEventListener('touchend',up);
                }
                if(track){ track.style.cursor='pointer'; track.addEventListener('pointerdown',down); track.addEventListener('touchstart',down,{passive:true}); }
                if(dot){ dot.style.cursor='pointer'; dot.addEventListener('pointerdown',down); dot.addEventListener('touchstart',down,{passive:true}); }
            }
            function init(){
                var a=document.getElementById('simple-view-toggle');
                var b=document.getElementById('simple-view-toggle-setlist');
                var d=document.getElementById('dark-mode-toggle') || document.querySelector('#dark-mode-container input[type="checkbox"]');
                [a,b,d].forEach(makeDraggableToggle);
            }
            if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);}else{init();}
        })();

        // === Enforce exact empty state for All Songs ===
        (function(){
            var LINE1='No songs yet';
            var LINE2='Drag & drop PDF files onto this page or use the Add files button';
            function enforce(){
                var ul=document.getElementById('master-list');
                if(!ul) return;
                var hasItems=ul.querySelector('li');
                if(hasItems) return;
                ul.innerHTML = '<li class="p-4 text-center text-gray-500 dark:text-gray-400">'+LINE1+'</li>' +
                               '<li class="pb-6 -mt-2 text-center text-sm text-gray-400 dark:text-gray-500">'+LINE2+'</li>';
            }
            function start(){
                var ul=document.getElementById('master-list');
                if(ul){ new MutationObserver(enforce).observe(ul,{childList:true}); }
                enforce(); setTimeout(enforce,50); setTimeout(enforce,200); setTimeout(enforce,600);
            }
            if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',start);}else{start();}
        })();

</script>
<script>

        // === PATCH: Homepage Sort dropdown & Genre flyout (precise targeting) ===
        (function(){
            function el(id){ return document.getElementById(id); }
            function once(fn){ var ran=false; return function(){ if(ran) return; ran=true; fn(); }; }
            function initSort(){
                var select = el('sort-dropdown');
                if (!select) return;
                // Rename "Sort by Name" -> "Sort By" inside this select only
                Array.from(select.options).forEach(function(opt){
                    if ((opt.textContent||'').trim().toLowerCase()==='sort by name'){ opt.textContent='Sort By'; }
                });
                // Remove "Last played" option
                Array.from(select.options).forEach(function(opt){
                    var t=(opt.textContent||'').trim().toLowerCase();
                    if (t==='sort by last played' || opt.value==='lastPlayed'){ opt.remove(); }
                });
                // Ensure "Genre" option exists
                var hasGenre = !!select.querySelector('option[value="genre"]');
                if (!hasGenre){
                    var opt = document.createElement('option');
                    opt.value='genre'; opt.textContent='Genre';
                    // Insert after Energy if present, else append
                    var after = select.querySelector('option[value="energy"]');
                    if (after && after.nextSibling){ select.insertBefore(opt, after.nextSibling); }
                    else { select.appendChild(opt); }
                }
                // Prepare flyout
                var fly = el('sort-genre-flyout');
                var slot = el('sort-genre-slot');
                var rightContainer = el('genre-list-container') || el('genre-filter-container') || (el('genre-view') && el('genre-view').parentElement);
                var dropdown = el('genre-filter-dropdown');
                // If there's no standalone dropdown, try the common ID pattern
                if (!dropdown){ dropdown = el('genre-list') || el('genre-sort-dropdown'); }
                if (!fly || !slot || !dropdown) return;
                // Mount dropdown into fly slot (without changing width elsewhere)
                if (!slot.contains(dropdown)){ slot.appendChild(dropdown); }
                // Hide the original right-side container *visually* only when genre is chosen
                function setRightContainerHidden(hide){
                    if (!rightContainer) return;
                    if (hide){
                        rightContainer.style.visibility = 'hidden';
                        rightContainer.style.pointerEvents = 'none';
                    } else {
                        rightContainer.style.visibility = '';
                        rightContainer.style.pointerEvents = '';
                    }
                }
                function update(){
                    if (select.value==='genre'){
                        fly.style.display='block';
                        dropdown.classList.remove('hidden');
                        setRightContainerHidden(true);
                    } else {
                        fly.style.display='none';
                        dropdown.classList.add('hidden');
                        setRightContainerHidden(false);
                    }
                }
                select.addEventListener('change', update);
                if (!select.value) select.value='name';
                update();
            }
            if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', initSort); } else { initSort(); }
        })();

        // === PATCH: Sidebar open fade-in only (no overlays; no layout changes) ===
        (function(){
            function initSidebarFade(){
                var sb = document.querySelector('.left-col');
                if (!sb || typeof ResizeObserver==='undefined') return;
                var lastW = sb.getBoundingClientRect().width;
                var ro = new ResizeObserver(function(){
                    var w = sb.getBoundingClientRect().width;
                    var delta = w - lastW;
                    if (Math.abs(delta) < 0.5){ lastW = w; return; }
                    if (delta > 0){ // opening
                        sb.classList.add('opening-fade');
                        sb.classList.remove('ready');
                        // allow layout to settle, then fade in
                        requestAnimationFrame(function(){ sb.classList.add('ready'); });
                        setTimeout(function(){
                            sb.classList.remove('opening-fade');
                            sb.classList.remove('ready');
                        }, 260);
                    }
                    lastW = w;
                });
                try{ ro.observe(sb); }catch(e){}
            }
            if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', initSidebarFade); } else { initSidebarFade(); }
        })();

</script>

<!-- === DROPIN GENRE FILTER PATCH (DOMonly, safe) === -->
<script>
/*
  Dropin Genre Filter Patch (DOMonly)
  Purpose: When a sidebar genre is clicked, show a page listing files tagged with the same COLOR.
  How it works: Pure DOM scan (no reliance on your app's internal JS). Nondestructive.
  Scope: Adds a minimal 'genre-view' section if missing. Hides other main views while showing results.
*/
(function(){
  // ---- helpers ----
  const NAMED_TO_HEX = { black:'#000000', white:'#ffffff', red:'#ff0000', green:'#008000', blue:'#0000ff', yellow:'#ffff00', orange:'#ffa500', purple:'#800080', gray:'#808080', grey:'#808080' };
  const HEX_RE = /^#([0-9a-f]{3}|[0-9a-f]{6})$/i;
  function toHex(c){
    if(!c) return '';
    c = String(c).trim().toLowerCase();
    if (NAMED_TO_HEX[c]) return NAMED_TO_HEX[c];
    if (HEX_RE.test(c)) return c.length===4 ? '#' + c.slice(1).split('').map(ch=>ch+ch).join('') : c;
    const m = c.match(/rgba?\(([^)]+)\)/i);
    if (m){
      const parts = m[1].split(',').map(x=>parseFloat(x));
      if (parts.length>=3){
        const [r,g,b] = parts.map(n=>Math.max(0,Math.min(255,Math.round(n))));
        const h = (n)=>n.toString(16).padStart(2,'0');
        return ('#'+h(r)+h(g)+h(b)).toLowerCase();
      }
    }
    return '';
  }
  function uniq(arr){ return Array.from(new Set(arr.filter(Boolean))); }

  // Resolve color(s) from a DOM node representing a file card
  function colorsFromFileEl(el){
    const out = [];
    const candAttrs = ['color','colors','genreColor','genre','tags'];
    candAttrs.forEach(k=>{
      const v = el.getAttribute('data-'+k) || (el.dataset && el.dataset[k]);
      if (!v) return;
      String(v).split(/[,\\s]+/).forEach(tok=>{ const hex = toHex(tok); if (hex) out.push(hex); });
    });
    el.querySelectorAll('.color-chip,.genre-color,.color-dot,[data-color]').forEach(dot=>{
      const v = dot.getAttribute('data-color') || getComputedStyle(dot).backgroundColor || (dot.style && dot.style.backgroundColor);
      const hex = toHex(v);
      if (hex) out.push(hex);
    });
    return uniq(out);
  }

  // Guess file cards in the current page
  function allFileEls(){
    const sels = ['.file-card','.song-file','.file','.song','.fileItem','.songItem','[data-file]','[data-type="file"]'];
    const nodes = new Set();
    sels.forEach(sel=>document.querySelectorAll(sel).forEach(n=>nodes.add(n)));
    if (nodes.size===0) document.querySelectorAll('li').forEach(n=>{ if(n.matches('[data-id], [data-file]')) nodes.add(n); });
    return Array.from(nodes);
  }

  // Build/ensure the genre results page
  function ensureGenreView(){
    let view = document.getElementById('genre-view');
    if (!view){
      view = document.createElement('section');
      view.id = 'genre-view';
      view.style.padding = '12px';
      view.style.display = 'none';
      view.innerHTML = '<h2 id="genre-title" style="margin:0 0 8px 0;">Genre</h2>\\n<ul id="genre-song-list" style="list-style:none;padding:0;margin:0;display:grid;gap:8px;"></ul>';
      document.body.appendChild(view);
    } else {
      if (!view.querySelector('#genre-song-list')){
        const ul = document.createElement('ul'); ul.id='genre-song-list'; ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='0'; ul.style.display='grid'; ul.style.gap='8px';
        view.appendChild(ul);
      }
      if (!view.querySelector('#genre-title')){
        const h = document.createElement('h2'); h.id='genre-title'; h.textContent='Genre'; view.prepend(h);
      }
    }
    return view;
  }

  // Hide other primary views (best effort, nondestructive)
  function hideOtherViews(showEl){
    const candidates = document.querySelectorAll('section, main, [data-view], .view');
    candidates.forEach(el=>{ if (el!==showEl && el.id!=='__genre_shim_keep') el.style.display='none'; });
  }

  function showGenrePage(){
    const v = ensureGenreView();
    hideOtherViews(v);
    v.style.display = '';
    return v;
  }

  // Render matches
  function renderMatches(hex, label){
    const view = showGenrePage();
    const ul = view.querySelector('#genre-song-list');
    const title = view.querySelector('#genre-title');
    title.textContent = label + ' (' + hex + ')';
    ul.innerHTML = '';

    const files = allFileEls();
    const matched = [];
    files.forEach(el=>{
      const cols = colorsFromFileEl(el);
      if (cols.includes(hex)) matched.push(el);
    });

    if (matched.length===0){
      const li = document.createElement('li');
      li.textContent = 'No files found with color ' + hex + '. (Scanned '+files.length+' items.)';
      ul.appendChild(li);
      return;
    }

    matched.forEach(el=>{
      const li = document.createElement('li');
      const clone = el.cloneNode(true);
      clone.removeAttribute('id');
      clone.style.opacity=''; clone.style.pointerEvents='auto'; clone.style.transform='';
      li.appendChild(clone);
      ul.appendChild(li);
    });
  }

  // Resolve color from a sidebar genre item element
  function colorFromGenreItem(el){
    let v = el.getAttribute('data-color') || (el.dataset && el.dataset.color);
    if (!v){
      const dot = el.querySelector('.color-dot,.genre-color,[data-color]');
      if (dot) v = dot.getAttribute('data-color') || getComputedStyle(dot).backgroundColor || dot.style.backgroundColor;
    }
    if (!v){
      const m = (el.textContent||'').match(/#([0-9a-f]{3}|[0-9a-f]{6})/i);
      if (m) v = m[0];
    }
    return toHex(v);
  }

  function labelFromGenreItem(el){
    return (el.getAttribute('data-name') || (el.dataset && el.dataset.name) || (el.textContent||'').trim() || 'Genre');
  }

  // Hook up sidebar clicks (broad selectors to be resilient)
  const sidebar = document.querySelector('.sidebar, #sidebar, [data-role="sidebar"]') || document;
  sidebar.addEventListener('click', function(e){
    const item = e.target.closest && e.target.closest('.genre-item, [data-genre], .sidebar-genre, li.genre, .genre');
    if (!item) return;
    const hex = colorFromGenreItem(item);
    const label = labelFromGenreItem(item);
    if (!hex){
      const view = showGenrePage();
      const ul = view.querySelector('#genre-song-list');
      const title = view.querySelector('#genre-title');
      title.textContent = label;
      ul.innerHTML = '<li>Could not detect a color for this genre. Add a <code>data-color</code> attribute or a swatch element with a background color.</li>';
      return;
    }
    renderMatches(hex, label);
  }, true);

  // Optional programmatic API
  window.__GenreFilterPatch = { renderByHex: renderMatches };
})();
</script>
<!-- === /DROPIN GENRE FILTER PATCH === -->
<script>
/* ========================= GENRE BY COLOR  MEGA PATCH =========================
   This patch guarantees that clicking a sidebar genre shows every file tagged
   with that genre's COLOR, and that tagging/dragging persists the song color.
   It is self-contained and robust even if prior bindings are missing.
================================================================================= */
(function(){
  try{
    // ---------- Canonical color tools ----------
    function __toHex(c){
      if (!c) return '';
      try{
        c = String(c).trim();
        if (!c) return '';
        // "#abc" or "#aabbcc"
        if (/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(c)) {
          if (c.length === 4) {
            // expand #abc -> #aabbcc
            return ("#" + c[1]+c[1] + c[2]+c[2] + c[3]+c[3]).toLowerCase();
          }
          return c.toLowerCase();
        }
        // rgb/rgba -> hex
        var m = c.match(/rgba?\s*\(\s*(\d+)[,\s]+(\d+)[,\s]+(\d+)/i);
        if (m){
          var r = Math.max(0, Math.min(255, parseInt(m[1],10)));
          var g = Math.max(0, Math.min(255, parseInt(m[2],10)));
          var b = Math.max(0, Math.min(255, parseInt(m[3],10)));
          var h = '#' + [r,g,b].map(function(x){ return x.toString(16).padStart(2,'0'); }).join('');
          return h.toLowerCase();
        }
        return c.toLowerCase();
      }catch(_){ return ''; }
    }
    function __buildGenreMaps(){
      var mapByName = {}, mapByHex = {};
      var genres = window.genres;
      if (!Array.isArray(genres) || genres.length === 0) {
        genres = [];
        document.querySelectorAll('#genre-list .genre-item, .sidebar-item[data-name]').forEach(function(el){
          var name = el.dataset.name || (el.querySelector('.genre-name') ? el.querySelector('.genre-name').textContent.trim() : '');
          var colorEl = el.querySelector('.genre-dot, .color-dot');
          var color = colorEl ? __toHex(getComputedStyle(colorEl).backgroundColor) : '';
          if (name && color) {
            genres.push({name: name, color: color});
          }
        });
      }
      genres.forEach(function(g){
        if (!g || !g.name) return;
        var hex = __toHex(g.color || '');
        if (hex){
          mapByName[g.name.toLowerCase()] = hex;
          mapByHex[hex] = g.name;
        }
      });
      return { byName: mapByName, byHex: mapByHex };
    }
    function __resolveSongColor(song, maps){
      if (!song) return '';
      if (song.color) return __toHex(song.color);
      if (song.genre && maps && maps.byName && maps.byName[song.genre.toLowerCase()]) return maps.byName[song.genre.toLowerCase()];
      if (typeof getGenreColor === 'function'){
        try{ return __toHex(getGenreColor(song.genre)); }catch(_){}
      }
      return '';
    }
    function __persistSongColor(songId, hex){
      try{
        hex = __toHex(hex);
        if (!hex || !Array.isArray(window.masterSongs)) return;
        var s = window.masterSongs.find(function(x){ return String(x.id)===String(songId); });
        if (!s) return;
        s.color = hex;
        if (typeof save==='function') save();
      }catch(_){}
    }

    // ---------- Robust renderer (always color-based) ----------
    function renderGenreByColor(genreName){
      var maps = __buildGenreMaps();
      var target = maps.byName[genreName.toLowerCase()];
      var $ul = $('#genre-song-list');
      if ($('#genre-view-title').length) $('#genre-view-title').text(genreName||'Genre');
      if (!$ul.length){
        console.warn('renderGenreByColor: #genre-song-list not found');
        return;
      }
      $ul.empty();
      if (!target || !Array.isArray(window.masterSongs) || !window.masterSongs.length){
        $ul.append('<li class="p-6 text-center text-gray-500 italic">No songs tagged with this color yet.</li>');
        return;
      }
      var list = window.masterSongs.filter(function(s){
        return __resolveSongColor(s, maps) === target;
      });

      // Optional sort support
      var sortMode = ($('#genre-sort-dropdown').val() || 'name');
      list.sort(function(a,b){
        if (sortMode === 'artist') return (a.artist||'').localeCompare(b.artist||'');
        if (sortMode === 'lastPlayed'){
          var ta = a.lastPlayed ? new Date(a.lastPlayed).getTime() : 0;
          var tb = b.lastPlayed ? new Date(b.lastPlayed).getTime() : 0;
          return tb - ta;
        }
        if (sortMode === 'energy') return (b.energy||0) - (a.energy||0);
        return (a.name||'').localeCompare(b.name||'');
      });

      if (!list.length){
        $ul.append('<li class="p-6 text-center text-gray-500 italic">No songs tagged with this color yet.</li>');
        return;
      }
      if (typeof createSongItem !== 'function'){
        $ul.append('<li class="p-6 text-center text-red-500">createSongItem() missing.</li>');
        return;
      }
      list.forEach(function(s,i){ $ul.append(createSongItem(s,i,'genre')); });

      // Draggable enablement
      try{
        var draggableOptions = {appendTo:'body',revert:'invalid',cursorAt:{left:10,top:10},helper:'clone',
          start:function(e,ui){
            var $i=$(this), count=$i.parent().children('.item-selected').length;
            var label = count>1?('Dragging '+count+' items'):$i.find('.song-name').text();
            ui.helper.empty().html(label).css({'background-color':'#3b82f6','color':'white','padding':'0.5rem 1rem',
                'height':'auto','width':'auto','white-space':'nowrap','box-shadow':'0 5px 15px rgba(0,0,0,0.3)',
                'z-index':9999,'border-radius':'0.5rem','font-weight':'600'});
          }
        };
        $('#genre-song-list .draggable').draggable(draggableOptions);
      }catch(_){}
    }

    // ---------- Override renderGenreView safely ----------
    if (typeof window.__orig_renderGenreView !== 'function' && typeof window.renderGenreView === 'function'){
      window.__orig_renderGenreView = window.renderGenreView;
    }
    window.renderGenreView = function(name){
      window.currentGenre = name;
      renderGenreByColor(name);
    };

    // ---------- Persist color when tagging by dot ----------
    $(document).off('click.__persistDotColor').on('click.__persistDotColor', '.genre-dot', function(){
      try{
        var $li = $(this).closest('li');
        var songId = $li.attr('id') || $li.data('id');
        if (!songId) return;
        var color = '';
        var inline = (this.getAttribute('style') || '').match(/background-color\s*:\s*([^;]+)/i);
        if (inline && inline[1]) color = inline[1];
        if (!color){
          var css = getComputedStyle(this).backgroundColor;
          if (css) color = css;
        }
        var hex = __toHex(color);
        if (!hex){
          // Fall back to genre -> color if the song already has a genre name
          var maps = __buildGenreMaps();
          var s = Array.isArray(window.masterSongs) ? window.masterSongs.find(function(x){ return String(x.id)===String(songId); }) : null;
          if (s && s.genre) hex = (maps.byName||{})[s.genre.toLowerCase()] || '';
        }
        if (hex) __persistSongColor(songId, hex);

        // Live refresh if viewing that genre
        var maps2 = __buildGenreMaps();
        var gName = (maps2.byHex||{})[hex];
        if (gName && gName === window.currentGenre){
          renderGenreByColor(gName);
        }
      }catch(_){}
    });

    // ---------- Persist color when dropping onto a genre ----------
    $(document).off('drop.__persistDropColor').on('drop.__persistDropColor','[data-name]', function(){
      try{
        var genreName = $(this).data('name');
        var maps = __buildGenreMaps();
        var hex = (maps.byName||{})[genreName.toLowerCase()] || '';
        var $drag = $('.ui-draggable-dragging');
        var songId = $drag.attr('id') || $drag.data('id');
        if (!songId){
          var $sel = $('li.draggable.item-selected').first();
          songId = $sel.attr('id') || $sel.data('id');
        }
        if (hex && songId) __persistSongColor(songId, hex);

        // Always repaint the clicked genre page
        setTimeout(function(){
          renderGenreByColor(genreName);
        }, 0);
      }catch(_){}
    });

    // ---------- Re-render on view switch or genre list mutation ----------
    $(document).off('view:genre.__repaint').on('view:genre.__repaint', function(){
      if (window.currentGenre) renderGenreByColor(window.currentGenre);
    });
    // If the app re-renders the sidebar genres dynamically, repaint the open page
    var sidebar = document.querySelector('#genre-list');
    if (sidebar && typeof MutationObserver!=='undefined'){
      var mo = new MutationObserver(function(){
        if (window.currentGenre) renderGenreByColor(window.currentGenre);
      });
      mo.observe(sidebar, {childList:true, subtree:true});
    }

  }catch(e){
    console.error('GENRE BY COLOR  MEGA PATCH init error:', e);
  }
})();
/* ====================== END GENRE BY COLOR  MEGA PATCH ====================== */
</script>
</body>
</html>
