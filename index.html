<DOCUMENT filename="decentapp_details_placeholder_fix_v2 (2).txt">
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<script data-ios-detect-early>
(function(){
try{
var isiOS = /AppleWebKit/.test(navigator.userAgent||'') && (navigator.maxTouchPoints||0) > 1;
if (isiOS) document.documentElement.classList.add('ios');
}catch(e){}
})();
</script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>Setlist Manager - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
        // === Long-press (1s) before dragging files ===
        let dragTimer = null;
        $(document).on('mousedown touchstart', 'li.draggable', function(e) {
            const item = $(this);
            dragTimer = setTimeout(() => {
                item.draggable('enable');
            }, 1000); // 1 second hold
            // disable dragging immediately until timer completes
            item.draggable('disable');
        }).on('mouseup mouseleave touchend touchcancel', 'li.draggable', function(e) {
            clearTimeout(dragTimer);
            // re-disable dragging so it requires hold again next time
            $(this).draggable('disable');
        });
        // Initially disable all draggables until long-press
        $(function() {
            $('li.draggable').draggable('disable');
        });
        // === Refined long-press-to-drag with movement threshold ===
        (function(){
            let dragTimer = null;
            let startX = 0, startY = 0;
            const THRESHOLD = 8; // px
            const HOLD_MS = 1100;
            function getPoint(e){
                if (e.touches && e.touches.length) return {x: e.touches[0].clientX, y: e.touches[0].clientY};
                if (e.changedTouches && e.changedTouches.length) return {x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY};
                return {x: e.clientX || 0, y: e.clientY || 0};
            }
            function cancelTimer(){
                if (dragTimer){ clearTimeout(dragTimer); dragTimer = null; }
            }
            $(document).on('mousedown touchstart', 'li.draggable', function(e) {
                const item = $(this);
                const p = getPoint(e);
                startX = p.x; startY = p.y;
                item.draggable('disable'); // always start disabled
                cancelTimer();
                dragTimer = setTimeout(() => {
                    // Only enable if we haven't moved too much during the hold
                    item.draggable('enable');
                }, HOLD_MS);
            });
            $(document).on('mousemove touchmove', 'li.draggable', function(e) {
                if (!dragTimer) return; // already enabled or canceled
                const p = getPoint(e);
                const dx = Math.abs(p.x - startX);
                const dy = Math.abs(p.y - startY);
                if (dx > THRESHOLD || dy > THRESHOLD) {
                    // User is scrolling or moving: cancel drag enabling
                    cancelTimer();
                    $(this).draggable('disable');
                }
            });
            $(document).on('mouseup mouseleave touchend touchcancel', 'li.draggable', function(e) {
                cancelTimer();
                // Require long-press again next time
                $(this).draggable('disable');
            });
            // On load, add a small distance requirement for extra safety
            $(function(){
                try {
                    $('li.draggable').draggable('option', 'distance', 12);
                } catch(e) {}
            });
        })();
        // === Left-edge custom scrollbar logic (shown when sidebar is collapsed) ===
        (function(){
            const $main = $('main');
            const $sidebar = $('.left-col');
            const $edge = $('#edge-scrollbar');
            const $thumb = $('#edge-thumb');
const MIN_THUMB = 48; // px minimum size
let dragging = false;
let trackTop = 0;
let trackHeight = 0;
let startY = 0;
let startScroll = 0;
function updateThumb(){
// Only operate if element present
if ($edge.length === 0) return;
const scrollEl = $main.get(0);
const scrollH = scrollEl.scrollHeight;
const clientH  = scrollEl.clientHeight;
const maxScroll = Math.max(1, scrollH - clientH);
const trackRect = $edge.get(0).getBoundingClientRect();
trackTop = trackRect.top + (window.innerHeight * 0.04); // 4vh top offset to match ::before
trackHeight = window.innerHeight * 0.92; // 92vh like CSS
// Thumb size proportional to viewport/total
let thumbH = Math.max(MIN_THUMB, (clientH / scrollH) * trackHeight);
$thumb.css('height', thumbH + 'px');
const ratio = $main.scrollTop() / maxScroll;
const maxY = trackHeight - thumbH;
const y = trackTop + (ratio * maxY);
$thumb.css('top', y + 'px');
}
function setScrollFromThumb(pageY){
const scrollEl = $main.get(0);
const scrollH = scrollEl.scrollHeight;
const clientH  = scrollEl.clientHeight;
const maxScroll = Math.max(1, scrollH - clientH);
const thumbH = $thumb.outerHeight();
const maxY = trackHeight - thumbH;
let localY = pageY - trackTop - (thumbH/2);
localY = Math.max(0, Math.min(maxY, localY));
const ratio = localY / maxY;
$main.scrollTop(ratio * maxScroll);
}
function showEdgeIfCollapsed(){
if ($sidebar.hasClass('collapsed')) {
$edge.addClass('visible').removeClass('hidden');
updateThumb();
} else {
$edge.removeClass('visible').addClass('hidden');
}
}
// Sync on load and on changes
$(function(){
showEdgeIfCollapsed();
updateThumb();
// Update on main scroll & resize
$main.on('scroll', updateThumb);
$(window).on('resize', updateThumb);
});
// Tie into existing sidebar toggle
$('#sidebar-toggle').on('click', function(){
// Delay to allow class toggle to settle
setTimeout(showEdgeIfCollapsed, 0);
setTimeout(updateThumb, 0);
});
// Drag handling (mouse + touch) on the thumb
function onMove(e){
if (!dragging) return;
const pageY = (e.touches && e.touches[0] ? e.touches[0].clientY : e.clientY);
setScrollFromThumb(pageY);
e.preventDefault();
}
function onUp(){
dragging = false;
$(document).off('mousemove touchmove', onMove);
$(document).off('mouseup touchend touchcancel', onUp);
}
$thumb.on('mousedown touchstart', function(e){
dragging = true;
$(document).on('mousemove touchmove', onMove);
$(document).on('mouseup touchend touchcancel', onUp);
e.preventDefault();
});
// Clicking the track jumps the thumb to that position
$edge.on('mousedown touchstart', function(e){
if (e.target === $thumb.get(0)) return; // handled by thumb
const pageY = (e.touches && e.touches[0] ? e.touches[0].clientY : e.clientY);
setScrollFromThumb(pageY);
});
// Also update when content visibility changes (navigation)
const originalShow = window.show;
if (typeof originalShow === 'function') {
window.show = function(view){
originalShow(view);
// after view switch, update thumb position
setTimeout(function(){
showEdgeIfCollapsed();
updateThumb();
}, 0);
}
}
})();
    </script>
    <script>
        (function() {
            var ua = navigator.userAgent || navigator.vendor || window.opera;
            var isiOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            if (isiOS) {
                document.documentElement.classList.add('ios');
            }
        })();
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
    <style>
        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed; /* Prevents panning/scrolling on touch devices */
        }
        
        #app {
            height: 100%;
            display: flex;
        }

        /* --- FIX: Correctly enables scrolling on touch devices when PDF viewer is open --- */
        body.doc-viewer-active {
            position: static; /* Revert to default positioning to allow scrolling */
            overflow: auto !important;   /* Explicitly allow scrolling on the body */
        }

        .doc-viewer-active #app {
            display: none; /* Hide the main app UI to prevent interaction and layout shifts */
        }
        
        .doc-view-fullscreen {
            overflow: hidden; /* Prevent scrollbars on the main viewer, child will scroll */
        }

        /* --- FIX: Smooth sidebar collapse transition for main content --- */
        main {
            transition: all 0.4s ease-in-out;
        }
        
        .sortable {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .draggable {
            cursor: move;
        }
        
        /* Subtle placeholder for sorting */
        .sortable-placeholder {
            background-color: #e5e7eb;
            border: 1px dashed #9ca3af;
            opacity: 0.5;
            height: 60px;
            margin-bottom: 1px;
            border-radius: 0.5rem;
        }
        .dark .sortable-placeholder {
            background-color: #374151;
            border-color: #6b7280;
        }

        /* Style for the actual item being sorted */
        .is-sorting {
            background: #2563eb !important; /* Record Show button blue */
            color: white !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        .is-sorting * {
            color: white !important;
        }
        .is-sorting .song-details-container {
            display: none; /* Hide inputs while sorting songs */
        }
        .is-sorting .delete-genre, .is-sorting .delete-venue {
            display: none; /* Hide delete button while sorting genres/venues */
        }


        /* Unified selected style for sidebar items */
        .selected {
            background-color: #3b82f6 !important;
            color: white !important;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
        }

        .selected .genre-name, .selected .venue-name {
             color: white !important;
        }

        /* Simple hover class for dragging over a setlist */
        .drag-hover-setlist {
            background-color: #3b82f6 !important;
            color: white !important;
        }
        
        /* Multiple selection highlight */
        .item-selected {
            background-color: #3b82f6 !important;
            color: white !important;
        }
        .dark .item-selected {
            background-color: #2563eb !important;
            color: white !important;
        }


        /* Consistent Add Button Style */
        .btn-add {
            background-color: #3b82f6;
            color: white;
            border: none;
            transition: background-color 0.2s;
            flex-shrink: 0; /* Prevent button from shrinking */
        }
        .btn-add:hover {
            background-color: #2563eb;
        }

        /* Genre dot and viewed indicator unified size */
        .genre-dot, .index-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Prevent shrinking */
            font-size: 1.125rem; /* Bigger numbers */
            font-weight: 600; /* Bolder numbers */
        }

        /* Fullscreen viewer styles */
        .doc-view-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 100;
            background: #333; /* Dark background for page turn effect */
        }
        .dark .doc-view-fullscreen {
            background: #111827;
        }
        
        /* --- Page Turn Animation --- */
        #doc-iframe-wrapper {
            width: 100%;
            height: 100%;
            perspective: 2500px; /* Enable 3D space for a more dramatic effect */
        }
        .doc-iframe-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            backface-visibility: hidden; /* Hide the back of the page */
            transition: transform 0.8s cubic-bezier(0.6, 0.0, 0.2, 1); /* Smoother animation curve */
            transform-origin: left center; /* For turning left-to-right */
            overflow: auto; /* Allow this container to scroll */
            -webkit-overflow-scrolling: touch; /* For iOS */
        }
        /* Page states */
        .doc-iframe-container.current {
            transform: rotateY(0deg);
            z-index: 101;
        }
        .doc-iframe-container.next {
            transform: rotateY(180deg);
            z-index: 100;
        }
        .doc-iframe-container.prev {
            transform: rotateY(-180deg);
            z-index: 100;
        }
        /* Animation classes */
        .turning-next { /* Current page turns away to the left */
            transform: rotateY(-180deg);
        }
        .turning-prev { /* Current page turns away to the right */
            transform-origin: right center;
            transform: rotateY(180deg);
        }
        /* New page coming in from the right */
        .incoming-next {
            transform-origin: left center;
            transform: rotateY(0deg);
        }
        /* New page coming in from the left */
        .incoming-prev {
            transform-origin: right center;
            transform: rotateY(0deg);
        }


        #doc-object {
            width: 100%;
            min-height: 100%; /* Ensure it fills the scrollable area */
            border: 0;
            display: block; /* Fix potential extra space */
        }
        
        .doc-nav-buttons {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            z-index: 103;
            opacity: 1;
            transition: opacity 0.3s;
            background: rgba(30,30,30, 0.8);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .doc-nav-buttons.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .doc-nav-button {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            border: none;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            user-select: none;
        }

        .doc-nav-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .doc-nav-close {
            background: #ef4444;
        }

        .doc-nav-button:not(:disabled):hover {
            background-color: #2563eb;
        }

        .doc-nav-close:hover {
            background-color: #dc2626;
        }
        
        .del-setlist {
            background: #ef4444;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
        }

        .del-setlist svg {
            width: 14px;
            height: 14px;
            fill: white;
        }

        .del-setlist:hover {
            background: #dc2626;
        }

        .setlist-item {
            display: flex;
            align-items: center;
            transition: all 0.2s ease-out;
        }

        .setlist-name {
            flex: 1;
            min-width: 0; /* Prevent overflow */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #setlist-details-toggle {
            padding: 0.5rem 0.75rem;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        .dark #setlist-details-toggle {
            background-color: #374151;
        }
        #setlist-details-toggle .toggle-arrow {
            transition: transform 0.2s ease-in-out;
        }
        #setlist-details-toggle.open .toggle-arrow {
            transform: rotate(180deg);
        }

        #setlist-details-content {
            display: none; /* Initial state */
            flex-direction: row; /* Force horizontal layout */
            align-items: flex-end; /* Align items at the bottom */
            gap: 1rem;
            padding: 1rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            flex-wrap: wrap;
        }
        #setlist-details-content > div {
            display: flex;
            flex-direction: column; /* Stack label/input vertically within their group */
            gap: 0.25rem;
        }
        .dark #setlist-details-content {
            background-color: #374151;
        }
        .dark #setlist-details-content label,
        .dark #setlist-details-content input,
        .dark #setlist-details-content select {
            color: #f9fafb !important;
        }
       
        #setlist-details-content input, #setlist-details-content select {
            box-sizing: border-box;
            border: 1px solid #d1d5db;
        }
        .dark #setlist-details-content input, .dark #setlist-details-content select {
            border-color: #4b5563;
        }
       
        /* --- FIX: Consistent size for setlist detail inputs & placeholder styling --- */
        #setlist-date, #setlist-venue, #setlist-sort-filter-dropdown {
            width: 176px; /* 11rem, w-44 */
            padding: 0.25rem 0.5rem; /* Add consistent padding */
            height: 34px; /* Consistent height */
        }
        #setlist-date-container {
            position: relative;
        }
        #date-placeholder {
            position: absolute;
            top: 28px;
            left: 6px;
            pointer-events: none;
            color: #9ca3af; /* Light mode placeholder color */
        }
        .dark #date-placeholder {
            color: #ffffff;
        }
        .dark #setlist-venue::placeholder {
             color: #ffffff;
        }
        .dark #setlist-date {
            color: #f9fafb; /* Ensure text is white */
        }
        .dark #setlist-date::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }


        .drag-highlight {
            background-color: #dbeafe;
            border: 2px dashed #3b82f6;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
        }

        .dark .drag-highlight {
            background-color: #1e3a8a;
        }

        .app-header {
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            transition: background 0.3s ease;
            cursor: pointer;
        }
        .app-header-selected {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .app-header-unselected {
            background: #374151;
        }
        .app-header-unselected:hover {
            background: #4b5563;
        }

        .stats-container {
            background-color: #f3f4f6;
            border-radius: 0.75rem;
            color: #1f2937;
            max-height: 200px;
            overflow-y: auto;
            margin-top: auto; /* Pushes to bottom */
            flex-shrink: 0; /* Prevent shrinking */
            padding: 0.5rem;
        }

        .dark .stats-container {
            background-color: #374151;
            color: #d1d5db;
        }

        .stats-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1e40af;
        }

        .dark .stats-title {
            color: #60a5fa;
        }
        
        .left-col {
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: width 0.4s ease-in-out, padding 0.4s ease-in-out;
            position: relative;
            padding: 1rem;
        }

        /* --- FIX: Wider, styled scrollbars moved to the edge --- */
        .left-col-main-content {
            margin-right: -1rem; /* Pull scrollbar to the edge */
            padding-right: 1rem; /* Add padding to compensate for margin */
            /* Add transition for smooth fade out */
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
.stats-container {
            /* Match the width of other sidebar blocks: no negative margins */
            margin-right: 0;
            padding-right: 0;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .left-col-main-content::-webkit-scrollbar,
        .stats-container::-webkit-scrollbar {
            width: 16px; /* Wider track for a larger touch target */
        }
        .left-col-main-content::-webkit-scrollbar-track,
        .stats-container::-webkit-scrollbar-track {
            background: transparent;
        }
        .left-col-main-content::-webkit-scrollbar-thumb,
        .stats-container::-webkit-scrollbar-thumb {
            background-color: #6b7280;
            border-radius: 8px;
            border: 4px solid transparent; /* Keep thumb wide */
            background-clip: content-box; /* Makes the border an invisible padding */
        }
        .left-col-main-content::-webkit-scrollbar-thumb:hover,
        .stats-container::-webkit-scrollbar-thumb:hover {
            background-color: #9ca3af;
        }
        
        .left-col-main-content {
            overflow-y: auto;
            overflow-x: hidden; /* PREVENT HORIZONTAL SCROLL */
            flex-grow: 1;
            margin-bottom: 1rem; /* Gap between venues and stats */
        }

        .left-col.collapsed {
            width: 0;
            padding: 0; /* Ensures no leftover space */
            overflow: hidden; /* Hides content fully */
        }
        
        /* New rule to hide sidebar content during collapse */
        .left-col.collapsed .left-col-main-content,
        .left-col.collapsed .stats-container {
            opacity: 0;
            visibility: hidden;
        }

        #sidebar-toggle {
            background-color: #1f2937;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px; /* Increased width */
            height: 60px;
            border-radius: 0 8px 8px 0;
            flex-shrink: 0;
            transition: all 0.3s ease-in-out;
        }

        #sidebar-toggle:hover {
            background-color: #374151;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-radius: 0.5rem;
            margin-bottom: 4px;
            background: #374151;
            cursor: pointer;
            color: #e5e7eb;
            transition: background-color 0.2s;
            overflow: hidden; /* Fix width issues */
        }
        .sidebar-item:hover {
            background: #4b5563;
        }

        /* Reverted Genre/Venue Creation Style */
        .item-creation {
            display: flex;
            gap: 8px;
            align-items: center;
            background-color: #1f2937;
            padding: 8px;
            border-radius: 8px;
            margin-top: 8px;
        }
        .item-creation .item-name-input {
             flex-grow: 1;
             background-color: #374151;
             border: 1px solid #4b5563;
             padding: 4px 8px;
             border-radius: 4px;
             color: white;
             min-width: 0; /* FIX: Allows input to shrink to fit */
        }
        /* Wrapper for custom color input */
        .color-picker-wrapper {
            position: relative;
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        #genre-color-display {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-image: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);
            transition: background 0.2s;
        }
        #genre-color {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }


        .genre-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
            min-width: 0; /* Prevent overflow */
        }
        .genre-name, .venue-name {
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-genre,
        .delete-venue {
            color: #ef4444;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .delete-genre:hover,
        .delete-venue:hover {
            background-color: #fee2e2;
        }

        .dark .delete-genre:hover,
        .dark .delete-venue:hover {
            background-color: #991b1b;
        }
        
        /* CORRECTED Dark Mode Toggle Visual */
        .dark-mode-toggle+div {
            transition: all 0.3s ease;
        }
        .dark-mode-toggle+div .dot {
            transition: all 0.3s ease;
        }
        /* Dark mode on (checked) */
        .dark-mode-toggle:checked+div {
            background-color: #22c55e;
        }
        .dark-mode-toggle:checked+div .dot {
            transform: translateX(1px); /* Ball is on the LEFT */
        }
        /* Light mode on (not checked) */
        .dark-mode-toggle:not(:checked)+div {
            background-color: #1f2937; /* Black */
        }
        .dark-mode-toggle:not(:checked)+div .dot {
            transform: translateX(20px); /* Ball is on the RIGHT */
        }

        /* Highly specific selector for viewed number color */
        #setlist-list li .index-number.viewed-index {
            background-color: white;
            color: #3b82f6 !important; /* Blue button color */
            border: 1px solid #3b82f6;
            font-weight: bold;
            font-size: 1.125rem; /* Even bigger when viewed */
        }
        
        /* === Redesigned Responsive Controls for Master View === */
        #master-view-controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        #search-container {
            position: relative;
        }
        #search {
            padding-right: 120px; /* Make space for the toggle */
        }
        #dark-mode-container {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
        }
        /* Sort dropdown width fix */
        #controls-row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap; /* Allow controls to wrap on small screens */
        }
        #filters-group {
            display: flex;
            flex-grow: 1; /* Allows this to expand */
            gap: 0.5rem;
            padding: 0.25rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            min-width: 200px;
        }
        #sort-dropdown {
            flex-grow: 1; /* The dropdown itself expands */
        }
        .dark #filters-group {
            background-color: #1f2937;
        }

        #master-view-buttons {
            flex-shrink: 0; /* Prevent buttons from shrinking */
        }

        #master-view-buttons .btn-master {
            width: 90px; /* Reduced button size */
        }
        .filter-select, #genre-filter-button {
            border: none;
            background: none;
            appearance: none;
            padding: 0.5rem;
        }
        #genre-filter-button {
            width: auto;
            min-width: 100px; /* Reduced min-width */
        }
        
        /* === Redesigned Grid Layout for Song Item Details === */
        .song-details-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            flex-shrink: 0; /* Prevent from being overlapped */
        }
        .song-details-container input, .song-details-container .delete-btn {
            width: 96px; /* Reduced width */
            text-align: center; /* Center text in inputs */
        }
        .song-details-container .delete-btn {
            width: 72px; /* Reduced width */
        }
        
        .left-col:not(.collapsed) ~ main .song-details-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            width: 220px; /* Reduced width */
            gap: 0.5rem;
            align-items: stretch; /* Ensures items fill the cell height */
        }
        .left-col:not(.collapsed) ~ main .song-details-container input,
        .left-col:not(.collapsed) ~ main .song-details-container button {
            width: 100%; /* Make items fill the grid cell */
            height: 100%;
        }
        
        /* === Setlist View 1-Column Layout === */
        .setlist-view-container {
            display: flex;
            flex-direction: column; /* Stack panels vertically */
            gap: 1rem;
            height: calc(100% - 150px); /* Adjust based on controls height */
            min-height: 0;
        }
        .setlist-panel {
            display: flex;
            flex-direction: column;
            min-height: 0;
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.1);
            overflow: hidden;
            flex: 1; /* Allow panels to share space */
        }
        .dark .setlist-panel {
            background-color: #1f2937;
        }
        .setlist-panel > .panel-header {
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            background-color: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        .dark .setlist-panel > .panel-header {
            background-color: #374151;
            border-bottom-color: #4b5563;
        }
        .setlist-panel > ul {
            overflow-y: auto;
            flex-grow: 1;
        }
        
        /* Add Songs panel with custom checkboxes */
        .add-song-item {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
        }
        .dark .add-song-item {
            border-bottom-color: #374151;
        }
        .add-song-item > label {
            display: flex;
            align-items: center;
            width: 100%;
            cursor: pointer;
            padding: 0.75rem 0.5rem;
        }
        .add-song-item > label:hover .custom-checkbox-box {
            background-color: #2563eb; /* Darker blue on hover */
        }
        .custom-checkbox-input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        .custom-checkbox-box {
            width: 1.25rem;
            height: 1.25rem;
            background-color: #3b82f6; /* Blue */
            border-radius: 0.25rem;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .custom-checkbox-box svg {
            opacity: 0;
            transition: opacity 0.2s;
            width: 1rem;
            height: 1rem;
            stroke: white;
            stroke-width: 2.5;
        }
        .custom-checkbox-input:checked ~ .custom-checkbox-box svg {
            opacity: 1;
        }


        /* Consistent border on all song list items */
        #master-list > li, #setlist-list > li, #favorites-list > li, #genre-song-list > li, #plays-list > li, .add-song-item {
            border-bottom-width: 1px;
        }
        #master-list, #setlist-list, #favorites-list, #genre-song-list, #plays-list, #setlist-add-songs-list {
            border-color: #e5e7eb;
        }
        .dark #master-list, .dark #setlist-list, .dark #favorites-list, .dark #genre-song-list, .dark #plays-list, .dark #setlist-add-songs-list {
            border-color: #374151;
        }
        
        /* Touch Device Enhancements */
        main.overflow-auto,
        .setlist-songs-container,
        #genre-filter-dropdown {
            -webkit-overflow-scrolling: touch;
        }

        #master-list > li, #setlist-list > li, #favorites-list > li, #plays-list > li, #genre-song-list > li {
            padding-top: 1rem;
            padding-bottom: 1rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        #plays-list > li {
            padding-left: 1rem;
        }

        /* Single Favorite Star Fix */
        .favorite-star-container svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: #9ca3af; /* Gray outline */
            stroke-width: 1.5;
            transition: all 0.2s;
        }
        .favorite-star-container.favorited svg {
            fill: white;
            stroke: #4b5563; /* Dark outline for visibility on light backgrounds */
        }
        .dark .favorite-star-container.favorited svg {
            stroke: white; /* White outline on dark backgrounds */
        }
    
        /* === iOS PDF scrolling fix: disable 3D transforms around iframe/object so all pages scroll === */
        html.ios #doc-iframe-wrapper { perspective: none !important; }
        html.ios .doc-iframe-container { 
            transform: none !important;
            transition: none !important;
            backface-visibility: visible !important;
            overflow: auto !important;
        }
        html.ios .doc-iframe-container.current,
        html.ios .doc-iframe-container.next,
        html.ios .doc-iframe-container.prev {
            transform: none !important;
        }
        html.ios .turning-next,
        html.ios .turning-prev,
        html.ios .incoming-next,
        html.ios .incoming-prev {
            transform: none !important;
        }
        /* Ensure embedded document fills available space and scrolls smoothly on iPad */
        html.ios #doc-object,
        html.ios .doc-iframe-container iframe,
        html.ios .doc-iframe-container embed,
        html.ios .doc-iframe-container object {
            width: 100% !important;
            height: 100% !important;
            display: block !important;
        }
        html.ios .doc-view-fullscreen {
            overflow: hidden;
        }
        html.ios .doc-iframe-container {
            -webkit-overflow-scrolling: touch;
        }
        /* === Fix All Songs scroll and clipping === */
        /* Let MAIN be the only scroll container; don't constrain the white card */
        #master-view > .bg-white {
            overflow: visible; /* don't clip last item inside rounded container */
        }
        /* Smooth iOS momentum and bottom padding so the last row isn't cut off */
        #master-list { 
            -webkit-overflow-scrolling: touch;
            padding-bottom: 1rem;
        }
        /* Momentum scrolling for setlist lists */
        #setlist-list,
        #setlist-add-songs-list {
            -webkit-overflow-scrolling: touch;
        }
        /* === Scrolling quality improvements === */
        main {
            overflow-y: auto; /* main is the scroll container */
            -webkit-overflow-scrolling: touch;
        }
        /* Hint to the browser: vertical pans are scrolls, not drags */
        #master-list, #setlist-list, #setlist-add-songs-list, #favorites-list, #genre-song-list, #plays-list {
            touch-action: pan-y;
        }
        /* === Left-edge custom scrollbar for collapsed sidebar === */
        #edge-scrollbar {
            position: fixed;
            left: 0;
            top: 0;
            width: 18px;              /* track width */
            height: 100vh;
            z-index: 120;             /* above app content, below nav buttons */
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;     /* let pointer events pass except on the thumb */
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        /* Subtle dark translucent track, centered line */
        #edge-scrollbar::before {
            content: "";
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 92vh;
            top: 4vh;
            border-radius: 9999px;
            background: rgba(0,0,0,0.25);
        }
        .dark #edge-scrollbar::before {
            background: rgba(255,255,255,0.12);
        }
        #edge-thumb {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;               /* white line */
            height: 60px;             /* will be sized by JS */
            border-radius: 9999px;    /* soft edges */
            background: #ffffff;
            box-shadow: 0 0 8px rgba(255,255,255,0.8), 0 0 2px rgba(0,0,0,0.2);
            pointer-events: auto;     /* interactive */
            touch-action: none;       /* we manage drag */
        }
        .dark #edge-thumb {
            background: #ffffff;
            box-shadow: 0 0 8px rgba(255,255,255,0.8), 0 0 2px rgba(0,0,0,0.4);
        }
        /* Visible state */
        #edge-scrollbar.visible {
            opacity: 1;
            pointer-events: none; /* only thumb is interactive */
        }
        /* Twinkle animation for energy level 3 sparks */
        @keyframes energy-twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.95); }
            50%      { opacity: 1; transform: scale(1.05); }
        }
        .energy-svg-3 .energy-spark {
            animation: energy-twinkle 1.2s ease-in-out infinite;
        }
        .energy-svg-3 .energy-spark:nth-child(2) { animation-delay: 0.2s; }
        .energy-svg-3 .energy-spark:nth-child(3) { animation-delay: 0.4s; }
        .energy-svg-3 .energy-spark:nth-child(4) { animation-delay: 0.6s; }
        .energy-svg-3 .energy-spark:nth-child(5) { animation-delay: 0.8s; }
        /* === Smooth sidebar closing/opening with curtain cover === */
        .left-col {
            position: relative;
            z-index: 20;              /* ensure it sits above main while animating */
            overflow: hidden;         /* hide inner content during slide */
        }
        main {
            position: relative;
            z-index: 10;
        }
        /* Curtain overlay that sweeps over options while closing */
        .left-col::after {
            content: "";
            position: absolute;
            inset: 0;
            background: #1f2937;      /* matches .left-col dark bg */
            opacity: 0;
            transform: translateX(-10%);
            transition: transform 0.35s ease, opacity 0.25s ease;
            pointer-events: none;
        }
        .dark .left-col::after {
            background: #000000;
        }
        /* When closing, fade in the curtain and sweep it right to cover items smoothly */
        .left-col.closing::after {
            opacity: 1;
            transform: translateX(0);
        }
        /* Optional subtle blur of inner items when closing */
        .left-col.closing .left-col-main-content,
        .left-col.closing .stats-container {
            filter: blur(1px);
        }
        /* Keep width/padding transitions already present; improve easing */
        .left-col {
            transition: width 0.4s cubic-bezier(0.4, 0.0, 0.2, 1), padding 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        main {
            transition: margin 0.4s cubic-bezier(0.4, 0.0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

    

/* === External scrollbar for Top/Least Played (non-intrusive box size) === */
.stats-container {
    /* Keep size exactly the same but hide native scrollbar */
    scrollbar-width: none; /* Firefox */
}
.stats-container::-webkit-scrollbar { width: 0 !important; height: 0 !important; } /* WebKit/iPad */

/* External scrollbar rail positioned on the black sidebar edge */
#stats-external-scroll {
    position: absolute;
    right: 0;                /* far-right, same lane as main sidebar scrollbar */
    width: 12px;             /* visual width */
    background: transparent; /* no background, sits on black */
    display: none;           /* toggled on when stats container is found */
    z-index: 2;
}

#stats-external-scroll .track {
    position: absolute;
    left: 0; top: 0; right: 0; bottom: 0;
    border-radius: 8px;
}

#stats-thumb {
    position: absolute;
    left: 2px;
    width: 8px;
    border-radius: 8px;
    background: rgba(255,255,255,0.5);
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    touch-action: none;
}
#stats-external-scroll:hover #stats-thumb { background: rgba(255,255,255,0.7); }


/* inline-rename */
.song-name.renaming { contain: layout paint; } /* isolate to avoid shifts */
.edit-input { font-size: 0.95rem; font-weight: 600; }
@media (prefers-color-scheme: dark) {
  .edit-input { background: #111827; color: #e5e7eb; border-color: #2563eb; }
}

/* inline-rename v2 */
.song-name.renaming { contain: layout paint; position: relative; }
.song-name.renaming .edit-input { font-family: inherit; font-size: 0.95rem; font-weight: 600; }
@media (prefers-color-scheme: dark) {
  .song-name.renaming .edit-input { background: #111827; color: #e5e7eb; border-color: #2563eb; }
}

/* magic-square exact-fit */
.song-name.renaming .edit-magic-square {
  padding: 0 !important;
  box-sizing: border-box !important;
  background: #ffffff !important;
  color: #2563eb !important;
  border: 2px solid #2563eb !important;
}

/* magic-square contenteditable */
.song-name.renaming .edit-magic-square {
  padding: 0 !important;
  box-sizing: border-box !important;
  background: #ffffff !important;
  color: #2563eb !important;
  border: 2px solid #2563eb !important;
  outline: none !important;
}
/* Keep siblings from shifting during edit */
.song-name.renaming { position: relative; }

        /* === iPad multipage viewer (Option B) === */
        html.doc-viewer-active, body.doc-viewer-active {
            position: static !important;
            overflow: auto !important;
            height: 100% !important;
        }
        /* Make the document wrapper the scroller while viewer is open */
        .doc-viewer-active #doc-iframe-wrapper {
            overflow: auto !important;
            -webkit-overflow-scrolling: touch !important;
        }
        /* Remove transforms/perspective in viewer ancestry on iOS (prevents single-page snapshot) */
        html.ios.doc-viewer-active #doc-view,
        html.ios.doc-viewer-active #doc-iframe-wrapper,
        html.ios.doc-viewer-active .doc-iframe-container,
        html.ios.doc-viewer-active .incoming-next,
        html.ios.doc-viewer-active .incoming-prev,
        html.ios.doc-viewer-active .turning-next,
        html.ios.doc-viewer-active .turning-prev {
            transform: none !important;
            perspective: none !important;
            backface-visibility: visible !important;
            will-change: auto !important;
            filter: none !important;
        }
        /* PDF.js container styles */
        .pdfjs-container { position:absolute; inset:0; overflow:auto; -webkit-overflow-scrolling:touch; padding: 8px; }
        .pdfjs-page { margin: 0 auto 10px auto; }
        .pdfjs-page canvas { display:block; width:100% !important; height:auto !important; background:#fff; border-radius:6px; }


        /* === Top-level PDF overlay (outside all transforms) === */
        #pdf-overlay {
          position: fixed; inset: 0; z-index: 999999;
          background: #000;
          display: none;
        }
        html.pdf-overlay-active, body.pdf-overlay-active {
          position: static !important;
          overflow: auto !important;
          height: 100% !important;
        }
        html.ios #pdf-overlay, html.ios #pdf-overlay * {
          transform: none !important;
          perspective: none !important;
          backface-visibility: visible !important;
          will-change: auto !important;
          filter: none !important;
        }
        #pdf-overlay .pdfjs-scroll {
          position: absolute; inset: 0;
          overflow: auto; -webkit-overflow-scrolling: touch;
          padding: 12px 12px 72px;
        }
        #pdf-overlay .pdfjs-page { margin: 0 auto 12px; }
        #pdf-overlay .pdfjs-page canvas {
          display: block; width: 100% !important; height: auto !important;
          background: #fff; border-radius: 6px;
        }


/* === Overlay-integrated original nav (non-intrusive) === */
html.pdf-overlay-active #doc-view { display: block !important; } /* unhide the section so nav exists */
html.pdf-overlay-active #doc-iframe-wrapper { display: none !important; } /* keep old wrapper hidden to avoid any layout/scroll changes */
html.pdf-overlay-active #doc-nav-buttons {
  position: fixed !important;
  top: 0; left: 0; right: 0;
  z-index: 1000001 !important; /* above #pdf-overlay (999999) */
 ...(truncated 100006 characters)...  }
  }
  var sc = scroller();
  if (sc){
    sc.addEventListener('scroll', onScroll, {passive:true});
    // Initial top check
    setTimeout(onScroll, 0);
  }

  // At top: pull down (scroll up gesture) closes the file
  var startY = null;
  function onTouchStart(e){
    var t = e.touches && e.touches[0];
    if (!t) return;
    startY = t.clientY;
  }
  function onTouchMove(e){
    var t = e.touches && e.touches[0];
    if (!t) return;
    var sc = scroller();
    if (!sc) return;
    var atTop = sc.scrollTop <= 2;
    var dy = t.clientY - (startY==null? t.clientY : startY);
    // if at top and user pulls down > 40px, close
    if (atTop && dy > 40){
      forward('close-doc', ['closeDocViewer','hideOverlay','closeViewer'], true);
      startY = t.clientY; // reset to avoid repeat
    }
  }
  if (sc){
    sc.addEventListener('touchstart', onTouchStart, {passive:true});
    sc.addEventListener('touchmove', onTouchMove, {passive:true});
  }

  // Keep state in sync
  var prevOrig = $('prev-doc'), nextOrig = $('next-doc'), origNav = $('doc-nav-buttons');
  [prevOrig, nextOrig, origNav].forEach(function(node){
    if (!node) return;
    try {
      var mo = new MutationObserver(function(){ setTimeout(syncState, 0); setTimeout(syncState, 200); });
      mo.observe(node, { attributes: true, attributeFilter: ['class', 'style', 'disabled', 'aria-disabled'], childList: false, subtree: false });
    } catch(e){}
  });
  document.addEventListener('click', function(){
    setTimeout(syncState, 60);
    setTimeout(syncState, 300);
  }, true);

  // Initial sync
  setTimeout(syncState, 0);
  setTimeout(syncState, 400);
})();
</script>
<script>
(function(){
if (window.__pdfBtnsInstalled_v5) return;
window.__pdfBtnsInstalled_v5 = true;

var $ = function(id){ return document.getElementById(id); };
var bar   = $('pdf-btn-bar');
var hit   = $('pdf-btn-hit');
var prevB = $('pdf-btn-prev');
var nextB = $('pdf-btn-next');
var closeB= $('pdf-btn-close');
var hideTimer = null;

function scroller(){ return $('pdf-overlay-scroll'); }

function canPrev(){ try { return (window.currentViewerIndex > 0); } catch(e){ return false; } }
function canNext(){ try { return (window.currentViewerList && window.currentViewerIndex < window.currentViewerList.length - 1); } catch(e){ return false; } }

function callPrev() {
try {
if (window.openSongInContext && window.currentViewerList && window.currentViewerIndex > 0) {
var idx = window.currentViewerIndex - 1;
var id = window.currentViewerList[idx].id;
window.openSongInContext(id, window.currentViewerContext, idx, 'prev');
return true;
}
} catch(e){}
// fallback: click original
try { var el = $('prev-doc'); if (el) { el.click(); return true; } } catch(e){}
// fallback: jQuery trigger
try { if (window.$) { $('#prev-doc').trigger('click'); return true; } } catch(e){}
return false;
}
function callNext() {
try {
if (window.openSongInContext && window.currentViewerList && window.currentViewerIndex < window.currentViewerList.length - 1) {
var idx = window.currentViewerIndex + 1;
var id = window.currentViewerList[idx].id;
window.openSongInContext(id, window.currentViewerContext, idx, 'next');
return true;
}
} catch(e){}
try { var el = $('next-doc'); if (el) { el.click(); return true; } } catch(e){}
try { if (window.$) { $('#next-doc').trigger('click'); return true; } } catch(e){}
return false;
}
function callClose() {
var ok = false;
try { var el = $('close-doc'); if (el) { el.click(); ok = true; } } catch(e){}
try { if (window.$) { $('#close-doc').trigger('click'); ok = true; } } catch(e){}
// force overlay teardown
try { if (typeof window.destroyPdfOverlay === 'function') { window.destroyPdfOverlay(); ok = true; } } catch(e){}
try { document.documentElement.classList.remove('pdf-overlay-active'); ok = true; } catch(e){}
return ok;
}

function isInactive(el){
if (!el) return true;
try {
var s = window.getComputedStyle(el);
var cls = (el.className||'').toLowerCase();
return !!( el.hasAttribute('disabled')
|| el.getAttribute('aria-disabled') === 'true'
|| /disabled|inactive|hidden/.test(cls)
|| s.display === 'none'
|| s.visibility === 'hidden'
|| s.pointerEvents === 'none');
} catch(e){ return false; }
}

function syncState(){
try {
var prevDis = !canPrev() || isInactive($('prev-doc'));
var nextDis = !canNext() || isInactive($('next-doc'));
prevB.classList.toggle('disabled', prevDis);
nextB.classList.toggle('disabled', nextDis);
prevB.tabIndex = prevDis ? -1 : 0;
nextB.tabIndex = nextDis ? -1 : 0;
} catch(e){}
}

function showBar(){
var sc = scroller();
if (sc && sc.scrollTop > 2) return; // only at top
bar && bar.classList.add('visible');
syncState();
if (hideTimer) clearTimeout(hideTimer);
hideTimer = setTimeout(function(){ bar && bar.classList.remove('visible'); }, 2000);
}
function hideBarNow(){
bar && bar.classList.remove('visible');
if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
}

prevB && prevB.addEventListener('click', function(e){
e.stopPropagation();
if (prevB.classList.contains('disabled')) return;
callPrev();
});
nextB && nextB.addEventListener('click', function(e){
e.stopPropagation();
if (nextB.classList.contains('disabled')) return;
callNext();
});
closeB && closeB.addEventListener('click', function(e){
e.stopPropagation();
callClose();
});

function onTopTap(){
var sc = scroller();
if (!sc || sc.scrollTop <= 2) showBar();
}
var hit = $('pdf-btn-hit');
if (hit){
hit.addEventListener('touchstart', onTopTap, {passive:true});
hit.addEventListener('mousedown', onTopTap);
hit.addEventListener('pointerdown', onTopTap, {passive:true});
}

var wasActive = document.documentElement.classList.contains('pdf-overlay-active');
if (wasActive) setTimeout(showBar, 0);
var moRoot = new MutationObserver(function(){
var active = document.documentElement.classList.contains('pdf-overlay-active');
if (active && !wasActive) setTimeout(showBar, 0);
else if (!active && wasActive) hideBarNow();
wasActive = active;
});
moRoot.observe(document.documentElement, {attributes:true, attributeFilter:['class']});

var lastTopState = null;
function onScroll(){
var sc = scroller();
if (!sc) return;
var atTop = sc.scrollTop <= 2;
if (atTop !== lastTopState){
lastTopState = atTop;
if (atTop) showBar(); else hideBarNow();
}
}
var sc = scroller();
if (sc){
sc.addEventListener('scroll', onScroll, {passive:true});
setTimeout(onScroll, 0);
}

// Pull-down to close at top
var startY = null;
function onTouchStart(e){ var t = e.touches && e.touches[0]; if (t) startY = t.clientY; }
function onTouchMove(e){
var t = e.touches && e.touches[0];
if (!t) return;
var sc = scroller();
if (!sc) return;
var atTop = sc.scrollTop <= 2;
var dy = t.clientY - (startY==null? t.clientY : startY);
if (atTop && dy > 40){ callClose(); startY = t.clientY; }
}
if (sc){
sc.addEventListener('touchstart', onTouchStart, {passive:true});
sc.addEventListener('touchmove', onTouchMove, {passive:true});
}

// Keep state in sync after internal updates
['prev-doc','next-doc','doc-nav-buttons'].forEach(function(id){
var node = $(id); if (!node) return;
try {
var mo = new MutationObserver(function(){ setTimeout(syncState, 0); setTimeout(syncState, 200); });
mo.observe(node, { attributes: true, attributeFilter: ['class', 'style', 'disabled', 'aria-disabled'] });
} catch(e){}
});
document.addEventListener('click', function(){
setTimeout(syncState, 60);
setTimeout(syncState, 300);
}, true);

setTimeout(syncState, 0);
setTimeout(syncState, 400);
})();
</script>
<script>
(function(){
if (window.__wrapOpenSongInContext_v1) return;
window.__wrapOpenSongInContext_v1 = true;

function installWrapper(){
if (!window.openSongInContext) return false;
if (window.openSongInContext.__wrapped) return true;

var original = window.openSongInContext;
function wrappedOpenSongInContext(songId, context, index, dir){
try {
// Ensure globals are always up to date for overlay nav across the app
if (typeof context !== 'undefined') window.currentViewerContext = context;
if (typeof index === 'number') window.currentViewerIndex = index;
// If list exists on context, mirror it to the expected global shape
try {
if (context && context.list && Array.isArray(context.list)) {
window.currentViewerList = context.list;
}
} catch(e){}
} catch(e){}
return original.apply(this, arguments);
}
wrappedOpenSongInContext.__wrapped = true;
window.openSongInContext = wrappedOpenSongInContext;
return true;
}

// Try immediately, then again after load, and once when user first opens something
if (!installWrapper()){
document.addEventListener('DOMContentLoaded', installWrapper);
setTimeout(installWrapper, 500);
setTimeout(installWrapper, 1500);
}
})();
</script>
<script>
(function(){
if (window.__bindPdfScroller_v2) return;
window.__bindPdfScroller_v2 = true;

function bind(){
var sc = document.getElementById('pdf-overlay-scroll');
if (!sc) return false;
if (sc.__overlayBound) return true;
sc.__overlayBound = true;

// Reuse existing bar logic if present
var bar = document.getElementById('pdf-btn-bar');
function showBar(){
if (!bar) return;
if (sc.scrollTop > 2) return;
bar.classList.add('visible');
setTimeout(function(){ bar.classList.remove('visible'); }, 2000);
}
function onScroll(){
if (sc.scrollTop <= 2) showBar(); else bar && bar.classList.remove('visible');
}
sc.addEventListener('scroll', onScroll, {passive:true});
setTimeout(onScroll, 0);
return true;
}

// Bind now and observe DOM changes to bind later too
var ok = bind();
var mo = new MutationObserver(function(){
if (!bind()) return;
});
mo.observe(document.body, { childList: true, subtree: true });
})();
</script>
<script>
(function(){
if (window.__pdfBtnWire_v6) return;
window.__pdfBtnWire_v6 = true;

function $(id){ return document.getElementById(id); }
var prevB = $('pdf-prev');
var nextB = $('pdf-next');
var closeB= $('pdf-close');

function callPrev(){
try {
if (window.openSongInContext && window.currentViewerList && window.currentViewerIndex > 0){
var idx = window.currentViewerIndex - 1;
var id  = window.currentViewerList[idx].id;
window.openSongInContext(id, window.currentViewerContext, idx, 'prev');
return true;
}
} catch(e){}
try { var el = $('prev-doc'); if (el) { el.click(); return true; } } catch(e){}
try { if (window.$) { $('#prev-doc').trigger('click'); return true; } } catch(e){}
return false;
}
function callNext(){
try {
if (window.openSongInContext && window.currentViewerList && window.currentViewerIndex < window.currentViewerList.length - 1){
var idx = window.currentViewerIndex + 1;
var id  = window.currentViewerList[idx].id;
window.openSongInContext(id, window.currentViewerContext, idx, 'next');
return true;
}
} catch(e){}
try { var el = $('next-doc'); if (el) { el.click(); return true; } } catch(e){}
try { if (window.$) { $('#next-doc').trigger('click'); return true; } } catch(e){}
return false;
}
function callClose(){
var ok = false;
try { var el = $('close-doc'); if (el) { el.click(); ok = true; } } catch(e){}
try { if (window.$) { $('#close-doc').trigger('click'); ok = true; } } catch(e){}
try { if (typeof window.destroyPdfOverlay === 'function') { window.destroyPdfOverlay(); ok = true; } } catch(e){}
try { document.documentElement.classList.remove('pdf-overlay-active'); ok = true; } catch(e){}
return ok;
}

prevB && prevB.addEventListener('click', function(e){ e.stopPropagation(); callPrev(); });
nextB && nextB.addEventListener('click', function(e){ e.stopPropagation(); callNext(); });
closeB && closeB.addEventListener('click', function(e){ e.stopPropagation(); callClose(); });
})();
</script>



  <button id="pdf-prev" class="btn" type="button">PREVIOUS</button>
  <button id="pdf-next" class="btn" type="button">NEXT</button>
  <button id="pdf-close" class="btn" type="button">CLOSE</button>


<script>
/* Universal viewer wiring so buttons work on Songs, Setlists, Favorites */
(function wrapOpenSongInContext(){
if (window.__wrapOpenSongInContext_v1) return; window.__wrapOpenSongInContext_v1 = true;
function install(){
if (!window.openSongInContext || window.openSongInContext.__wrapped) return;
var orig = window.openSongInContext;
function wrapped(songId, context, index, dir){
try {
if (typeof context !== 'undefined') window.currentViewerContext = context;
if (typeof index   === 'number')     window.currentViewerIndex   = index;
if (context && Array.isArray(context.list)) window.currentViewerList = context.list;
} catch(e){}
return orig.apply(this, arguments);
}
wrapped.__wrapped = true;
window.openSongInContext = wrapped;
}
install(); document.addEventListener('DOMContentLoaded', install); setTimeout(install, 500); setTimeout(install, 1500);
})();

/* Top bar behavior (no scroll changes) */
(function(){
if (window.__TopBarV7) return; window.__TopBarV7 = true;
var $ = function(id){ return document.getElementById(id); };
var bar = $('pdf-topbar'), hit = $('pdf-top-hit');
var prevB = $('pdf-prev'), nextB = $('pdf-next'), closeB = $('pdf-close');
var hideTimer = null;

function scroller(){ return document.getElementById('pdf-overlay-scroll'); }

function canPrev(){
try {
if (typeof window.currentViewerIndex === 'number' && window.currentViewerIndex > 0) return true;
var el = document.getElementById('prev-doc');
if (el){ var s = getComputedStyle(el); if (s.display!=='none' && s.visibility!=='hidden' && !el.disabled) return true; }
} catch(e){}
return false;
} catch(e){ return false; } }
function canNext(){
try {
if (window.currentViewerList && typeof window.currentViewerIndex === 'number' && window.currentViewerIndex < window.currentViewerList.length - 1) return true;
var el = document.getElementById('next-doc');
if (el){ var s = getComputedStyle(el); if (s.display!=='none' && s.visibility!=='hidden' && !el.disabled) return true; }
} catch(e){}
return false;
} catch(e){ return false; } }

function syncState(){
try {
prevB.classList.toggle('disabled', !canPrev());
nextB.classList.toggle('disabled', !canNext());
prevB.tabIndex = prevB.classList.contains('disabled') ? -1 : 0;
nextB.tabIndex = nextB.classList.contains('disabled') ? -1 : 0;
} catch(e){}
}

function showBar(){
if (!bar) return;
if (!atTop()) return;
bar.classList.add('visible');
syncState();
if (hideTimer) clearTimeout(hideTimer);
hideTimer = setTimeout(function(){ bar.classList.remove('visible'); }, 2000);
}
function hideBarNow(){
bar && bar.classList.remove('visible');
if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
}

function callPrev(){
try {
if (window.openSongInContext && window.currentViewerList && window.currentViewerIndex > 0){
var idx = window.currentViewerIndex - 1, id = window.currentViewerList[idx].id;
window.openSongInContext(id, window.currentViewerContext, idx, 'prev'); return;
}
} catch(e){}
var el = document.getElementById('prev-doc'); if (el) { el.click(); return; }
if (window.$) try { $('#prev-doc').trigger('click'); } catch(e){}
}
function callNext(){
try {
if (window.openSongInContext && window.currentViewerList && window.currentViewerIndex < window.currentViewerList.length - 1){
var idx = window.currentViewerIndex + 1, id = window.currentViewerList[idx].id;
window.openSongInContext(id, window.currentViewerContext, idx, 'next'); return;
}
} catch(e){}
var el = document.getElementById('next-doc'); if (el) { el.click(); return; }
if (window.$) try { $('#next-doc').trigger('click'); } catch(e){}
}
function callClose(){
var ok = false;
var el = document.getElementById('close-doc'); if (el) { el.click(); ok = true; }
if (window.$) try { $('#close-doc').trigger('click'); ok = true; } catch(e){}
try { if (typeof window.destroyPdfOverlay === 'function') { window.destroyPdfOverlay(); ok = true; } } catch(e){}
try { document.documentElement.classList.remove('pdf-overlay-active'); ok = true; } catch(e){}
return ok;
}

prevB.addEventListener('click', function(e){ e.stopPropagation(); if (!prevB.classList.contains('disabled')) callPrev(); });
nextB.addEventListener('click', function(e){ e.stopPropagation(); if (!nextB.classList.contains('disabled')) callNext(); });
closeB.addEventListener('click', function(e){ e.stopPropagation(); callClose(); });

function onTopTap(){ if (atTop()) showBar(); }
hit.addEventListener('touchstart', onTopTap, {passive:true});
hit.addEventListener('mousedown', onTopTap);
hit.addEventListener('pointerdown', onTopTap, {passive:true});

var wasActive = document.documentElement.classList.contains('pdf-overlay-active');
if (wasActive) setTimeout(showBar, 0);
new MutationObserver(function(){
var active = document.documentElement.classList.contains('pdf-overlay-active');
if (active && !wasActive) setTimeout(showBar, 0);
else if (!active && wasActive) hideBarNow();
wasActive = active;
}).observe(document.documentElement, {attributes:true, attributeFilter:['class']});

function bindScroller(sc){
if (!sc || sc.__tbBound) return;
sc.__tbBound = true;
var lastTop = null, startY = null;

function onScroll(){
var top = sc.scrollTop <= 2;
if (top !== lastTop){ lastTop = top; if (top) showBar(); else hideBarNow(); }
}
sc.addEventListener('scroll', onScroll, {passive:true});
setTimeout(onScroll, 0);

function onTS(e){ var t = e.touches && e.touches[0]; if (t) startY = t.clientY; }
function onTM(e){
var t = e.touches && e.touches[0]; if (!t) return;
if (sc.scrollTop <= 2 && startY != null && (t.clientY - startY) > 90){ callClose(); startY = t.clientY; }
}
sc.addEventListener('touchstart', onTS, {passive:true});
sc.addEventListener('touchmove',  onTM, {passive:true});
}
bindScroller(scroller());
new MutationObserver(function(){ bindScroller(scroller()); })
.observe(document.body, {childList:true, subtree:true});

['prev-doc','next-doc','doc-nav-buttons'].forEach(function(id){
var n = document.getElementById(id); if (!n) return;
try {
new MutationObserver(function(){ setTimeout(syncState, 0); setTimeout(syncState, 200); })
.observe(n, {attributes:true, attributeFilter:['class','style','disabled','aria-disabled']});
} catch(e){}
});
document.addEventListener('click', function(){ setTimeout(syncState, 60); setTimeout(syncState, 300); }, true);

setTimeout(syncState, 0);
setTimeout(syncState, 400);
})();

window.addEventListener('pdfTopbarSync', function(){ try { syncState(); } catch(e){} });
</script>

<script>
(function(){
if (window.__wrapOpenDocViewer_v1) return; window.__wrapOpenDocViewer_v1 = true;
function install(){
if (!window.openDocViewer || window.openDocViewer.__wrapped) return;
var orig = window.openDocViewer;
function wrapped(/* songId or docId, maybe context */){
try {
var args = Array.prototype.slice.call(arguments);
var ctx = (args.length > 1 && typeof args[1] === 'object') ? args[1] : (window.currentViewerContext || null);
if (ctx) window.currentViewerContext = ctx;
try { if (ctx && ctx.list && Array.isArray(ctx.list)) window.currentViewerList = ctx.list; } catch(e){}
for (var i=0;i<args.length;i++){ if (typeof args[i] === 'number') { window.currentViewerIndex = args[i]; break; } }
} catch(e){}
return orig.apply(this, arguments);
}
wrapped.__wrapped = true;
window.openDocViewer = wrapped;
}
install(); document.addEventListener('DOMContentLoaded', install); setTimeout(install, 500); setTimeout(install, 1500);
})();
</script>

<script>
(function(){
try {
if (document.documentElement.classList.contains('pdf-overlay-active')) {
var e=new Event('pdfTopbarSync'); window.dispatchEvent(e);
}
} catch(e){}
})();
</script>

<button id="pdf-prev" class="fixed left-4 top-1/2 transform -translate-y-1/2 bg-blue-500 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 z-50 hidden" type="button">
<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
</button>
<button id="pdf-next" class="fixed right-4 top-1/2 transform -translate-y-1/2 bg-blue-500 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 z-50 hidden" type="button">
<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
</button>
<button id="pdf-close" class="fixed top-4 right-4 bg-red-500 text-white p-3 rounded-full shadow-lg hover:bg-red-700 z-50 hidden" type="button">
<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
</button>

<script>
/* Keep viewer globals in sync across all open paths */
(function(){
if (window.__wrapViewers_final) return; window.__wrapViewers_final = true;

function wrapOpen(name){
try {
var fn = window[name];
if (!fn || fn.__wrapped_final) return;
var orig = fn;
function wrapped(/* dynamic args */){
try {
var args = Array.prototype.slice.call(arguments);
// try to find context object & index in args
for (var i=0;i<args.length;i++){
var a = args[i];
if (a && typeof a === 'object' && (a.list || a.context || a.type)) { window.currentViewerContext = a; break; }
}
for (var j=0;j<args.length;j++){
var b = args[j];
if (typeof b === 'number') { window.currentViewerIndex = b; break; }
}
// if context has a list, mirror to global
try { if (window.currentViewerContext && Array.isArray(window.currentViewerContext.list)) window.currentViewerList = window.currentViewerContext.list; } catch(_){}
} catch(_){}
return orig.apply(this, arguments);
}
wrapped.__wrapped_final = true;
window[name] = wrapped;
} catch(_){}
}

['openSongInContext', 'openDocViewer'].forEach(wrapOpen);
// Retry after load in case functions are defined later
document.addEventListener('DOMContentLoaded', function(){ ['openSongInContext','openDocViewer'].forEach(wrapOpen); });
setTimeout(function(){ ['openSongInContext','openDocViewer'].forEach(wrapOpen); }, 500);
setTimeout(function(){ ['openSongInContext','openDocViewer'].forEach(wrapOpen); }, 1500);
})();

/* Top bar behavior (no scroll modifications) */
(function(){
if (window.__TopBar_final) return; window.__TopBar_final = true;
var $ = function(id){ return document.getElementById(id); };
var prevB = $('pdf-prev'), nextB = $('pdf-next'), closeB = $('pdf-close');

function scroller(){ return document.getElementById('pdf-overlay-scroll'); }

// Robust ID normalization for list items across app sections
function getDocId(item){
if (!item || typeof item !== 'object') return null;
return item.id ?? item.docId ?? item.songId ?? item.fileId ?? item.pdfId ?? null;
}

function canPrev(){
try {
if (typeof window.currentViewerIndex === 'number' && window.currentViewerIndex > 0) return true;
var el = document.getElementById('prev-doc');
if (el){ var s = getComputedStyle(el); if (s.display!=='none' && s.visibility!=='hidden' && !el.disabled) return true; }
} catch(_){}
return false;
}
function canNext(){
try {
if (window.currentViewerList && typeof window.currentViewerIndex === 'number' && window.currentViewerIndex < window.currentViewerList.length - 1) return true;
var el = document.getElementById('next-doc');
if (el){ var s = getComputedStyle(el); if (s.display!=='none' && s.visibility!=='hidden' && !el.disabled) return true; }
} catch(_){}
return false;
}
function syncState(){
try {
prevB.classList.toggle('disabled', !canPrev());
nextB.classList.toggle('disabled', !canNext());
prevB.tabIndex = prevB.classList.contains('disabled') ? -1 : 0;
nextB.tabIndex = nextB.classList.contains('disabled') ? -1 : 0;
} catch(_){}
}

function callPrev(){
try {
var list = window.currentViewerList || [];
var i = Number(window.currentViewerIndex || 0);
var item = list[i - 1];
var id = getDocId(item);
if (id != null && typeof window.openSongInContext === 'function'){
window.currentViewerIndex = i - 1;
return window.openSongInContext(id, window.currentViewerContext, i - 1, 'prev');
}
} catch(_){}
var el = document.getElementById('prev-doc'); if (el) { try { el.click(); return; } catch(_){ } }
if (window.$) try { $('#prev-doc').trigger('click'); } catch(_){}
}
function callNext(){
try {
var list = window.currentViewerList || [];
var i = Number(window.currentViewerIndex || 0);
var item = list[i + 1];
var id = getDocId(item);
if (id != null && typeof window.openSongInContext === 'function'){
window.currentViewerIndex = i + 1;
return window.openSongInContext(id, window.currentViewerContext, i + 1, 'next');
}
} catch(_){}
var el = document.getElementById('next-doc'); if (el) { try { el.click(); return; } catch(_){ } }
if (window.$) try { $('#next-doc').trigger('click'); } catch(_){}
}
function callClose(){
var ok = false;
var el = document.getElementById('close-doc'); if (el) { try { el.click(); ok = true; } catch(_){} }
if (window.$) try { $('#close-doc').trigger('click'); ok = true; } catch(_){}
try { if (typeof window.destroyPdfOverlay === 'function') { window.destroyPdfOverlay(); ok = true; } } catch(_){}
try { document.documentElement.classList.remove('pdf-overlay-active'); ok = true; } catch(_){}
return ok;
}

prevB && prevB.addEventListener('click', function(e){ e.stopPropagation(); if (!prevB.classList.contains('disabled')) callPrev(); });
nextB && nextB.addEventListener('click', function(e){ e.stopPropagation(); if (!nextB.classList.contains('disabled')) callNext(); });
closeB && closeB.addEventListener('click', function(e){ e.stopPropagation(); callClose(); });

var wasActive = document.documentElement.classList.contains('pdf-overlay-active');
if (wasActive) setTimeout(syncState, 0);
new MutationObserver(function(){
var active = document.documentElement.classList.contains('pdf-overlay-active');
if (active && !wasActive) setTimeout(syncState, 0);
wasActive = active;
}).observe(document.documentElement, {attributes:true, attributeFilter:['class']});

function bindScroller(sc){
if (!sc || sc.__tbBoundFinal) return;
sc.__tbBoundFinal = true;
var startY = null;

function onTS(e){ var t = e.touches && e.touches[0]; if (t) startY = t.clientY; }
function onTM(e){
var t = e.touches && e.touches[0]; if (!t) return;
// Require intentional pull: 90px
if (sc.scrollTop <= 2 && startY != null && (t.clientY - startY) > 90){ callClose(); startY = t.clientY; }
}
sc.addEventListener('touchstart', onTS, {passive:true});
sc.addEventListener('touchmove',  onTM, {passive:true});
}
bindScroller(scroller());
new MutationObserver(function(){ bindScroller(scroller()); })
.observe(document.body, {childList:true, subtree:true});

// Allow other parts of app to force a state refresh if needed
window.addEventListener('pdfTopbarSync', function(){ try { syncState(); } catch(_){ } });

// Initial sync
setTimeout(syncState, 0);
setTimeout(syncState, 400);
})();
</script>

<script>
(function(){
if (window.__venueSizeMatch) return; window.__venueSizeMatch = true;
function matchVenueSize(){
try {
var genre = document.getElementById('genre-name');
var venue = document.getElementById('venue-name');
if (!genre || !venue) return;
var gs = window.getComputedStyle(genre);
// Copy width/height exactly as rendered
var w = genre.getBoundingClientRect().width;
var h = genre.getBoundingClientRect().height;
venue.style.width  = w + 'px';
venue.style.height = h + 'px';
// Match padding/border/font for perfect symmetry
venue.style.paddingLeft   = gs.paddingLeft;
venue.style.paddingRight  = gs.paddingRight;
venue.style.paddingTop    = gs.paddingTop;
venue.style.paddingBottom = gs.paddingBottom;
venue.style.borderWidth   = gs.borderWidth;
venue.style.borderStyle   = gs.borderStyle;
venue.style.borderColor   = gs.borderColor;
venue.style.borderRadius  = gs.borderRadius;
venue.style.font          = gs.font;
venue.style.boxSizing     = gs.boxSizing || 'border-box';
} catch(e){}
}
// Run on load and after small delay to catch Tailwind/layout
window.addEventListener('load', function(){ setTimeout(matchVenueSize, 0); setTimeout(matchVenueSize, 250); });
// If sidebar opens/closes, layout may change; observe size changes
var ro = new ResizeObserver(function(){ matchVenueSize(); });
window.addEventListener('DOMContentLoaded', function(){
var g = document.getElementById('genre-name');
var v = document.getElementById('venue-name');
if (g) ro.observe(g);
if (v) ro.observe(v);
});
})();
</script>

<script>
(function () {
if (window.__UniversalClose_v1) return;
window.__UniversalClose_v1 = true;

function universalCloseViewer() {
var closed = false;

try {
var nativeBtn = document.getElementById('close-doc');
if (nativeBtn && typeof nativeBtn.click === 'function') {
nativeBtn.click();
closed = true;
}
if (window.$ && !closed) { try { $('#close-doc').trigger('click'); closed = true; } catch(_){} }
} catch(_) {}

try { if (typeof window.destroyPdfOverlay === 'function') { window.destroyPdfOverlay(); closed = true; } } catch(_) {}

try {
var roots = [
document.getElementById('pdf-overlay'),
document.querySelector('.pdf-overlay'),
document.getElementById('pdf-viewer'),
document.querySelector('.viewer-overlay')
].filter(Boolean);
roots.forEach(function (el) { el.style.display = 'none'; });
if (roots.length) closed = true;
} catch(_) {}

try { document.documentElement.classList.remove('pdf-overlay-active'); closed = true; } catch(_) {}
try { document.body.classList.remove('pdf-overlay-active'); closed = true; } catch(_) {}

try {
var bar = document.getElementById('pdf-topbar') || document.getElementById('pdf-btn-bar');
if (bar) bar.classList.remove('visible');
} catch(_) {}

return !!closed;
}

function onDocClick(e) {
var t = e.target;
var isClose = (t && t.id === 'pdf-close') || (t && t.closest && (t.closest('#pdf-close') || t.closest('#pdf-btn-close')));
if (isClose) {
e.stopPropagation();
e.preventDefault();
universalCloseViewer();
}
}
document.addEventListener('click', onDocClick, true);

document.addEventListener('keydown', function (e) {
if (e.key === 'Escape' || e.keyCode === 27) {
if (document.documentElement.classList.contains('pdf-overlay-active')) {
e.stopPropagation();
universalCloseViewer();
}
}
}, true);

new MutationObserver(function () {}).observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });

window.universalCloseViewer = universalCloseViewer;
})();
</script>

<style>
#genre-name::placeholder, #venue-name::placeholder { text-align: center; }
#genre-name, #venue-name { text-align: center; } /* helps iOS Safari */
.pdf-overlay-active #pdf-prev, .pdf-overlay-active #pdf-next, .pdf-overlay-active #pdf-close {
  display: block;
}
</style>
<script>
(function(){
if (window.__GenreVenueSync_v2) return; window.__GenreVenueSync_v2 = true;

function setImportant(el, prop, value){
try { el.style.setProperty(prop, value, 'important'); } catch(_){}
}

function syncVenueToGenre(){
try {
var g = document.getElementById('genre-name');
var v = document.getElementById('venue-name');
if (!g || !v) return;

var rect = g.getBoundingClientRect();
var gs = getComputedStyle(g);

// Match box model and typography
setImportant(v, 'box-sizing', gs.boxSizing || 'border-box');
setImportant(v, 'padding-left', gs.paddingLeft);
setImportant(v, 'padding-right', gs.paddingRight);
setImportant(v, 'padding-top', gs.paddingTop);
setImportant(v, 'padding-bottom', gs.paddingBottom);
setImportant(v, 'border-width', gs.borderWidth);
setImportant(v, 'border-style', gs.borderStyle);
setImportant(v, 'border-color', gs.borderColor);
setImportant(v, 'border-radius', gs.borderRadius);
setImportant(v, 'font', gs.font);

// Ensure layout constraints don't override width
setImportant(v, 'display', gs.display || 'block');
setImportant(v, 'flex', '0 0 auto');
setImportant(v, 'max-width', rect.width + 'px');
setImportant(v, 'min-width', rect.width + 'px');
setImportant(v, 'width', rect.width + 'px');
setImportant(v, 'height', rect.height + 'px');
} catch(_){}
}

function schedule(){
setTimeout(syncVenueToGenre, 0);
setTimeout(syncVenueToGenre, 250);
setTimeout(syncVenueToGenre, 800);
setTimeout(syncVenueToGenre, 1500);
}

window.addEventListener('load', schedule);
window.addEventListener('resize', function(){ setTimeout(syncVenueToGenre, 0); });

// Observe genre size changes (e.g., theme/sidebar width changes)
try {
var gObsTarget = document.getElementById('genre-name');
if (gObsTarget && window.ResizeObserver) {
var ro = new ResizeObserver(function(){ syncVenueToGenre(); });
ro.observe(gObsTarget);
}
} catch(_){}
})();
</script>

<script>
(function(){
/* =====  A) Perfect horizontal alignment for Genre/Venue rows  =====
We don't change widths/heights (already matched). We just align left-x
of the Venue input and Venue Add button to equal the Genre row's left-x.
*/
if (!window.__AlignGenreVenue_v1){
window.__AlignGenreVenue_v1 = true;

function alignVenueRow(){
try {
var gInput = document.getElementById('genre-name');
var vInput = document.getElementById('venue-name');
// Attempt to find the "Add" buttons near each input; adjust selectors to your markup if needed
var gAdd   = document.getElementById('add-genre-btn')  || document.querySelector('[data-add="genre"], #add-genre, .add-genre-btn');
var vAdd   = document.getElementById('add-venue-btn')  || document.querySelector('[data-add="venue"], #add-venue, .add-venue-btn');

if (!gInput || !vInput) return;

// compute current left positions
var gx = gInput.getBoundingClientRect().left;
var vx = vInput.getBoundingClientRect().left;

// We adjust only the venue input's margin-left to match genre's left edge
var deltaInput = gx - vx;
if (Math.abs(deltaInput) > 0.5) {
// apply margin-left delta without affecting layout above it
var current = parseFloat(getComputedStyle(vInput).marginLeft) || 0;
vInput.style.marginLeft = (current + deltaInput) + "px";
}

// If we have genre/venue add buttons, align them too
if (gAdd && vAdd) {
var gxB = gAdd.getBoundingClientRect().left;
var vxB = vAdd.getBoundingClientRect().left;
var deltaBtn = gxB - vxB;
if (Math.abs(deltaBtn) > 0.5) {
var currentBtn = parseFloat(getComputedStyle(vAdd).marginLeft) || 0;
vAdd.style.marginLeft = (currentBtn + deltaBtn) + "px";
}
}
} catch(_){}
}

// Run after layout + a few retries for dynamic UI
function schedule(){
setTimeout(alignVenueRow, 0);
setTimeout(alignVenueRow, 200);
setTimeout(alignVenueRow, 600);
setTimeout(alignVenueRow, 1200);
}
window.addEventListener('load', schedule);
window.addEventListener('resize', function(){ setTimeout(alignVenueRow, 0); });
// Observe venue/genre nodes for size/position changes and re-align
var obsTargets = ['genre-name','venue-name'];
if (window.ResizeObserver){
obsTargets.forEach(function(id){
var el = document.getElementById(id);
if (el){
try {
var ro = new ResizeObserver(function(){ alignVenueRow(); });
ro.observe(el);
} catch(_){}
}
});
}
// If sidebar open/close toggles classes on html/body, re-run
new MutationObserver(function(){ alignVenueRow(); })
.observe(document.documentElement, {attributes:true, attributeFilter:['class']});
}

/* =====  B) Pull-to-close v4: downward pull only, stronger threshold, must release  ===== */
if (!window.__PullToClose_v4){
window.__PullToClose_v4 = true;

function scroller(){ return document.getElementById('pdf-overlay-scroll'); }
var startY = null;
var maxPullDown = 0;
var active = false;
var THRESHOLD_DOWN = 150;  // stronger than v3 (prevents accidental close on slight gestures)

function onTouchStart(e){
var t = e.touches && e.touches[0];
var sc = scroller();
if (!t || !sc) return;
// only arm at absolute top
active = (sc.scrollTop <= 2);
startY = t.clientY;
maxPullDown = 0;
}
function onTouchMove(e){
if (!active) return;
var t = e.touches && e.touches[0];
var sc = scroller();
if (!t || !sc) return;
var dy = t.clientY - (startY == null ? t.clientY : startY);
// Only count downward pulls
if (dy > maxPullDown) maxPullDown = dy;
}
function onTouchEnd(){
try {
if (!active) return;
var sc = scroller(); if (!sc) return;
// Close ONLY if at top and downward pull exceeded strong threshold
if (sc.scrollTop <= 2 && maxPullDown > THRESHOLD_DOWN) {
if (typeof window.universalCloseViewer === 'function') {
window.universalCloseViewer();
} else {
var btn = document.getElementById('close-doc');
if (btn && typeof btn.click === 'function') btn.click();
if (window.$) try { $('#close-doc').trigger('click'); } catch(_){}
}
}
} finally {
active = false;
startY = null;
maxPullDown = 0;
}
}

function bind(){
var sc = scroller();
if (!sc || sc.__pullCloseV4Bound) return;
sc.__pullCloseV4Bound = true;
sc.addEventListener('touchstart', onTouchStart, {passive:true});
sc.addEventListener('touchmove',  onTouchMove,  {passive:true});
sc.addEventListener('touchend',   onTouchEnd,   {passive:true});
}

bind();
new MutationObserver(function(){ bind(); })
.observe(document.body, {childList:true, subtree:true});
}
})();
</script>
<script>
// === Drag into Genres: blue hover + assign song to genre ===
(function(){
function attachGenreDroppables(){
var $items = $('#genre-list .genre-item');
if (!$items.length) return;
$items.each(function(){
var $el = $(this);
if ($el.data('genreDropReady')) return;
$el.data('genreDropReady', true);
$el.droppable({
accept: '.draggable',
tolerance: 'pointer',
hoverClass: 'drag-hover-setlist', // blue highlight to match favorites/setlists
drop: function(event, ui){
try {
var songId = $(ui.draggable).attr('id');
var genreName = $(this).data('name');
if (!songId || !genreName) return;
// Find song and genre objects
var s = masterSongs.find(function(x){ return String(x.id) === String(songId); });
if (!s) return;
s.genre = genreName;
var g = (typeof genres!=='undefined') ? genres.find(function(x){ return x.name === genreName; }) : null;
if (g && !s.color) { s.color = g.color; } // keep color in sync if app uses it
// Persist and refresh views
if (typeof save === 'function') save();
if ($('#genre-view').is(':visible')) {
if (typeof currentGenre !== 'undefined' && currentGenre === genreName && typeof renderGenreView === 'function') {
renderGenreView(genreName);
}
}
if ($('#master-view').is(':visible') && typeof renderMaster === 'function') {
renderMaster();
}
if ($('#setlist-view').is(':visible') && typeof renderSetlist === 'function') {
renderSetlist();
}
} catch(e){ console.error('Genre drop error:', e); }
}
});
});
}

// Observe dynamic changes to the genre list so droppable stays attached
$(function(){
attachGenreDroppables();
var gl = document.getElementById('genre-list');
if (gl && window.MutationObserver) {
var obs = new MutationObserver(function(){ attachGenreDroppables(); });
obs.observe(gl, {childList:true});
}
// Re-attach after any known re-renders
$(document).on('app:renderGenres app:navigate', function(){ attachGenreDroppables(); });
});
})();
</script>
<script>
// === Override: ensure Genre view shows songs dropped into that genre ===
(function(){
function safeEscape(t){ try { return (typeof escapeHtml==='function') ? escapeHtml(t) : String(t||'').replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); } catch(e){ return String(t||''); } }
window.renderGenreView = function(n){
try{
currentGenre = n;
$('#genre-view-title').text(n);
var list = $('#genre-song-list').empty();
var songs = (masterSongs||[]).filter(function(s){ return (s.genre||'').toLowerCase() === String(n||'').toLowerCase(); });
// Build compact, consistent list items that remain draggable + clickable
songs.forEach(function(s, i){
var g = (typeof genres!=='undefined') ? genres.find(function(x){ return x.name === n; }) : null;
var color = g ? g.color : (s.color||'');
var dot = '<span class="genre-dot inline-block w-2.5 h-2.5 rounded-full mr-2 align-middle" style="background:'+ (color||'transparent') +';"></span>';
var fav = s.favorite ? '<span class="favorite-star-container ml-2">★</span>' : '<span class="favorite-star-container ml-2">☆</span>';
var $li = $('<li/>', {
id: String(s.id),
class: 'draggable flex items-center px-2 py-1 hover:bg-gray-50 dark:hover:bg-gray-800 rounded'
}).append(dot)
.append('<span class="truncate flex-1">'+ safeEscape(s.name||'Untitled') +'</span>')
.append(fav);
list.append($li);
});
// Re-enable dragging with your existing options
if (typeof draggableOptions !== 'undefined') {
$('#genre-song-list .draggable').draggable(draggableOptions);
}
// Make sure the view is visible
if (typeof show === 'function') show('genre');
}catch(e){ console.error('renderGenreView override error', e); }
};
})();
</script>
<script>
// === Setlist Details: keep the date placeholder span visible only when empty ===
(function(){
function updateDatePlaceholder(){
var $date = $('#setlist-date');
var $ph = $('#date-placeholder');
if ($date.length && $ph.length){
if (!$date.val()) { $ph.show(); } else { $ph.hide(); }
}
}
$(document).on('change input', '#setlist-date', updateDatePlaceholder);
$(document).on('click', '#setlist-details-toggle', function(){
// When expanding/collapsing, re-evaluate placeholder visibility
setTimeout(updateDatePlaceholder, 0);
});
$(function(){ updateDatePlaceholder(); });
})();
</script>
<script>
(function(){
function positionDatePlaceholder(){
var cont = document.getElementById('setlist-date-container');
var input = document.getElementById('setlist-date');
var ph = document.getElementById('date-placeholder');
if (!cont || !input || !ph) return;
var r = input.getBoundingClientRect();
var c = cont.getBoundingClientRect();
// Compute center of INPUT relative to container
var cx = (r.left - c.left) + (r.width / 2);
var cy = (r.top - c.top) + (r.height / 2);
ph.style.left = cx + 'px';
ph.style.top  = cy + 'px';
ph.style.transform = 'translate(-50%, -50%)';
// Match width to input so long strings stay centered visually
ph.style.width = r.width + 'px';
ph.style.textAlign = 'center';
}

function toggleDatePlaceholder(){
var input = document.getElementById('setlist-date');
var ph = document.getElementById('date-placeholder');
if (!input || !ph) return;
ph.style.display = input.value ? 'none' : 'block';
}

function syncAll(){
toggleDatePlaceholder();
positionDatePlaceholder();
}

// Reposition on resize, orientation change, open/close of details
window.addEventListener('resize', positionDatePlaceholder);
window.addEventListener('orientationchange', positionDatePlaceholder);
document.addEventListener('click', function(e){
if (e.target && (e.target.id === 'setlist-details-toggle' || e.target.closest && e.target.closest('#setlist-details-toggle'))) {
setTimeout(syncAll, 0);
}
}, true);
document.addEventListener('input', function(e){
if (e.target && e.target.id === 'setlist-date') toggleDatePlaceholder();
});
document.addEventListener('change', function(e){
if (e.target && e.target.id === 'setlist-date') toggleDatePlaceholder();
});

// Initial
document.addEventListener('DOMContentLoaded', function(){
syncAll();
// Also run once more after layout settles
setTimeout(syncAll, 0);
});
})();
</script>
</body>
</html></DOCUMENT>
