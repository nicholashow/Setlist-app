<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>Setlist Manager - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
    <style>
        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed; /* Prevents panning/scrolling on touch devices */
        }
        
        #app {
            height: 100%;
        }

        body.doc-viewer-active {
            position: relative; /* Revert fixed position to allow scrolling for doc viewer */
            overflow: visible !important;
        }

        .sortable {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .draggable {
            cursor: move;
        }
        
        .sortable-placeholder {
            background-color: #dbeafe;
            border: 2px dashed #3b82f6;
            height: 60px; /* Match item height */
            margin-bottom: 1px;
            border-radius: 0.5rem;
        }

        /* Unified selected style for sidebar items */
        .selected {
            background-color: #3b82f6 !important;
            color: white !important;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
        }

        .selected .genre-name, .selected .venue-name {
             color: white !important;
        }
        
        /* Multiple selection highlight */
        .item-selected {
            background-color: #93c5fd !important;
            border-left: 4px solid #2563eb;
        }
        .dark .item-selected {
            background-color: #1e40af !important;
            border-left: 4px solid #60a5fa;
        }


        /* Consistent Add Button Style */
        .btn-add {
            background-color: #3b82f6;
            color: white;
            border: none;
            transition: background-color 0.2s;
            flex-shrink: 0; /* Prevent button from shrinking */
        }
        .btn-add:hover {
            background-color: #2563eb;
        }

        /* Genre dot and viewed indicator unified size */
        .genre-dot, .index-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Prevent shrinking */
        }

        /* Fullscreen viewer styles */
        .doc-view-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 100;
            background: white;
        }

        .dark .doc-view-fullscreen {
            background: #111827;
        }

        .doc-nav-buttons {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            z-index: 103;
            opacity: 1;
            transition: opacity 0.3s;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dark .doc-nav-buttons {
            background: rgba(31, 41, 55, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .doc-nav-buttons.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .doc-nav-button {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            border: none;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            user-select: none;
        }

        .doc-nav-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .doc-nav-close {
            background: #ef4444;
        }

        .doc-nav-button:not(:disabled):hover {
            background-color: #2563eb;
        }

        .doc-nav-close:hover {
            background-color: #dc2626;
        }
        
        #doc-iframe-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }


        #doc-object {
            width: 100%;
            height: 100%;
            border: 0;
        }

        .del-setlist {
            background: #ef4444;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
        }

        .del-setlist svg {
            width: 14px;
            height: 14px;
            fill: white;
        }

        .del-setlist:hover {
            background: #dc2626;
        }

        .setlist-item {
            display: flex;
            align-items: center;
            transition: all 0.2s ease-out;
        }

        .setlist-name {
            flex: 1;
            min-width: 0; /* Prevent overflow */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #setlist-details-toggle {
            padding: 0.5rem 0.75rem;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        .dark #setlist-details-toggle {
            background-color: #374151;
        }
        #setlist-details-toggle .toggle-arrow {
            transition: transform 0.2s ease-in-out;
        }
        #setlist-details-toggle.open .toggle-arrow {
            transform: rotate(180deg);
        }
        /* FINAL CORRECTED HORIZONTAL Setlist Details Layout */
        #setlist-details-content {
            display: none; /* Initial state */
            flex-direction: row; /* Force horizontal layout */
            align-items: flex-end; /* Align items at the bottom */
            gap: 1rem;
            padding: 1rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            flex-wrap: wrap;
        }
        #setlist-details-content > div {
            display: flex;
            flex-direction: column; /* Stack label/input vertically within their group */
            gap: 0.25rem;
        }
        .dark #setlist-details-content {
            background-color: #374151;
        }
        .dark #setlist-details-content label {
            color: #f9fafb !important; /* Force white color */
        }
       
        .drag-highlight {
            background-color: #dbeafe;
            border: 2px dashed #3b82f6;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
        }

        .dark .drag-highlight {
            background-color: #1e3a8a;
        }

        .app-header {
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            transition: background 0.3s ease;
            cursor: pointer;
        }
        .app-header-selected {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .app-header-unselected {
            background: #374151;
        }
        .app-header-unselected:hover {
            background: #4b5563;
        }

        .stats-container {
            background-color: #f3f4f6;
            border-radius: 0.75rem;
            padding: 1rem;
            color: #1f2937;
            max-height: 200px;
            overflow-y: auto;
            margin-top: auto; /* Pushes to bottom */
            flex-shrink: 0; /* Prevent shrinking */
        }

        .dark .stats-container {
            background-color: #374151;
            color: #d1d5db;
        }

        .stats-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1e40af;
        }

        .dark .stats-title {
            color: #60a5fa;
        }
        
        .left-col {
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: width 0.4s ease-in-out, padding 0.4s ease-in-out;
            position: relative;
        }
        /* Sidebar scrolling fix */
        .left-col-main-content {
            overflow-y: auto;
            overflow-x: hidden; /* PREVENT HORIZONTAL SCROLL */
            flex-grow: 1;
            padding-right: 4px;
            margin-bottom: 0.5rem; /* Gap between venues and stats */
        }

        .left-col.collapsed {
            width: 0;
            padding: 0; /* Ensures no leftover space */
            overflow: hidden; /* Hides content fully */
        }

        #sidebar-toggle {
            background-color: #1f2937;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 60px;
            border-radius: 0 8px 8px 0;
            flex-shrink: 0;
            transition: all 0.3s ease-in-out;
        }

        #sidebar-toggle:hover {
            background-color: #374151;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-radius: 0.5rem;
            margin-bottom: 4px;
            background: #374151;
            cursor: pointer;
            color: #e5e7eb;
            transition: background-color 0.2s;
            overflow: hidden; /* Fix width issues */
        }
        .sidebar-item:hover {
            background: #4b5563;
        }

        /* Reverted Genre/Venue Creation Style */
        .item-creation {
            display: flex;
            gap: 8px;
            align-items: center;
            background-color: #1f2937;
            padding: 8px;
            border-radius: 8px;
            margin-top: 8px;
        }
        .item-creation .item-name-input {
             flex-grow: 1;
             background-color: #374151;
             border: 1px solid #4b5563;
             padding: 4px 8px;
             border-radius: 4px;
             color: white;
        }
        /* Fix for Genre Color Picker */
        #genre-color {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: transparent;
            width: 28px;
            height: 28px;
            border: none;
            cursor: pointer;
        }
        #genre-color::-webkit-color-swatch {
            border-radius: 4px;
            border: 1px solid #4b5563;
        }
        #genre-color::-moz-color-swatch {
            border-radius: 4px;
            border: 1px solid #4b5563;
        }


        .genre-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
            min-width: 0; /* Prevent overflow */
        }
        .genre-name, .venue-name {
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-genre,
        .delete-venue {
            color: #ef4444;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .delete-genre:hover,
        .delete-venue:hover {
            background-color: #fee2e2;
        }

        .dark .delete-genre:hover,
        .dark .delete-venue:hover {
            background-color: #991b1b;
        }
        
        /* CORRECTED Dark Mode Toggle Visual */
        .dark-mode-toggle+div {
            transition: all 0.3s ease;
        }
        .dark-mode-toggle+div .dot {
            transition: all 0.3s ease;
        }
        /* Dark mode on (checked) */
        .dark-mode-toggle:checked+div {
            background-color: #22c55e;
        }
        .dark-mode-toggle:checked+div .dot {
            transform: translateX(1px); /* Ball is on the LEFT */
        }
        /* Light mode on (not checked) */
        .dark-mode-toggle:not(:checked)+div {
            background-color: #1f2937; /* Black */
        }
        .dark-mode-toggle:not(:checked)+div .dot {
            transform: translateX(20px); /* Ball is on the RIGHT */
        }

        /* Highly specific selector for viewed number color */
        #setlist-list li .index-number.viewed-index {
            background-color: white;
            color: #3b82f6 !important; /* Blue button color */
            border: 1px solid #3b82f6;
            font-weight: bold;
        }
        
        /* === Redesigned Responsive Controls for Master View === */
        #master-view-controls {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        #search-container {
            position: relative;
        }
        #search {
            padding-right: 120px; /* Make space for the toggle */
        }
        #dark-mode-container {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
        }
        /* Sort dropdown width fix */
        #controls-row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        #filters-group {
            display: flex;
            flex-grow: 1; /* Allows this to expand */
            gap: 0.5rem;
            padding: 0.25rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        #sort-dropdown {
            flex-grow: 1; /* The dropdown itself expands */
        }
        .dark #filters-group {
            background-color: #1f2937;
        }

        #master-view-buttons {
            flex-shrink: 0; /* Prevent buttons from shrinking */
        }

        #master-view-buttons .btn-master {
            width: 100px; /* Equal sized buttons */
        }
        .filter-select, #genre-filter-button {
            border: none;
            background: none;
            appearance: none;
            padding: 0.5rem;
        }
        #genre-filter-button {
            width: auto;
            min-width: 120px;
        }
        
        /* === Redesigned Grid Layout for Song Item Details === */
        .song-details-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-left: auto;
        }
        .song-details-container input, .song-details-container .delete-btn {
            width: 112px;
            text-align: center; /* Center text in inputs */
        }
        .song-details-container .delete-btn {
            width: 80px;
        }
        
        .left-col:not(.collapsed) ~ main .song-details-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            width: 280px;
            gap: 0.5rem;
            align-items: stretch; /* Ensures items fill the cell height */
        }
        .left-col:not(.collapsed) ~ main .song-details-container input,
        .left-col:not(.collapsed) ~ main .song-details-container button {
            width: 100%; /* Make items fill the grid cell */
            height: 100%;
        }
        
        /* === Setlist View 1-Column Layout === */
        .setlist-view-container {
            display: flex;
            flex-direction: column; /* Stack panels vertically */
            gap: 1rem;
            height: calc(100% - 150px); /* Adjust based on controls height */
            min-height: 0;
        }
        .setlist-panel {
            display: flex;
            flex-direction: column;
            min-height: 0;
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -2px rgba(0,0,0,.1);
            overflow: hidden;
            flex: 1; /* Allow panels to share space */
        }
        .dark .setlist-panel {
            background-color: #1f2937;
        }
        .setlist-panel > .panel-header {
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            background-color: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        .dark .setlist-panel > .panel-header {
            background-color: #374151;
            border-bottom-color: #4b5563;
        }
        .setlist-panel > ul {
            overflow-y: auto;
            flex-grow: 1;
        }
        /* Add Songs panel with checkboxes */
        .add-song-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .dark .add-song-item {
            border-bottom-color: #374151;
        }
        .add-song-item label {
            flex-grow: 1;
            cursor: pointer;
            padding-left: 0.5rem;
        }
        .add-song-item input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }


        /* Consistent border on all song list items */
        #master-list > li, #setlist-list > li, #favorites-list > li, #genre-song-list > li, #plays-list > li, .add-song-item {
            border-bottom-width: 1px;
        }
        #master-list, #setlist-list, #favorites-list, #genre-song-list, #plays-list, #setlist-add-songs-list {
            border-color: #e5e7eb;
        }
        .dark #master-list, .dark #setlist-list, .dark #favorites-list, .dark #genre-song-list, .dark #plays-list, .dark #setlist-add-songs-list {
            border-color: #374151;
        }
        
        /* Touch Device Enhancements */
        main.overflow-auto,
        .setlist-songs-container,
        #genre-filter-dropdown {
            -webkit-overflow-scrolling: touch;
        }

        #master-list > li, #setlist-list > li, #favorites-list > li, #plays-list > li, #genre-song-list > li {
            padding-top: 1rem;
            padding-bottom: 1rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        #plays-list > li {
            padding-left: 1rem;
        }

        /* Single Favorite Star Fix */
        .favorite-star-container svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: #9ca3af; /* Gray outline */
            stroke-width: 1.5;
            transition: all 0.2s;
        }
        .favorite-star-container.favorited svg {
            fill: white;
            stroke: #4b5563; /* Dark outline for visibility on light backgrounds */
        }
        .dark .favorite-star-container.favorited svg {
            stroke: white; /* White outline on dark backgrounds */
        }

        /* === IMPROVED DRAG & DROP STYLING === */
        .ui-draggable-dragging {
            background-color: #3b82f6 !important;
            color: white !important;
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3) !important;
            z-index: 9999 !important;
            transform: rotate(5deg);
        }
        
        .ui-draggable-dragging * {
            color: white !important;
        }
        
        /* Improved placeholder for setlist reordering */
        #setlist-list .sortable-placeholder {
            background-color: #dbeafe !important;
            border: 2px dashed #3b82f6 !important;
            height: 60px !important;
            visibility: visible !important;
        }
        
        /* Improved drag highlight for setlists */
        .setlist-item.drag-highlight {
            background-color: #dbeafe !important;
            border: 2px dashed #3b82f6 !important;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5) !important;
        }
        
        .dark .setlist-item.drag-highlight {
            background-color: #1e3a8a !important;
            border-color: #60a5fa !important;
        }
        
        /* Improved drop flash animation */
        .drop-flash {
            animation: dropFlash 1s ease;
        }
        
        @keyframes dropFlash {
            0% { background-color: #dbeafe; }
            100% { background-color: transparent; }
        }
        
        .dark .drop-flash {
            animation: dropFlashDark 1s ease;
        }
        
        @keyframes dropFlashDark {
            0% { background-color: #1e3a8a; }
            100% { background-color: transparent; }
        }
        
        /* === IMPROVED CHECKBOX STYLING FOR ADD SONGS PANEL === */
        .add-song-item input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #3b82f6;
            border-radius: 0.25rem;
            background-color: white;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        
        .add-song-item input[type="checkbox"]:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        .add-song-item input[type="checkbox"]:checked::after {
            content: "✓";
            position: absolute;
            color: white;
            font-size: 0.875rem;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .dark .add-song-item input[type="checkbox"] {
            background-color: #374151;
            border-color: #6b7280;
        }
        
        .dark .add-song-item input[type="checkbox"]:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        /* === IMPROVED SIDEBAR LAYOUT === */
        .item-creation {
            display: flex;
            gap: 8px;
            align-items: center;
            background-color: #1f2937;
            padding: 8px;
            border-radius: 8px;
            margin-top: 8px;
            flex-wrap: nowrap;
        }
        
        .item-creation .item-name-input {
            flex-grow: 1;
            min-width: 0;
            background-color: #374151;
            border: 1px solid #4b5563;
            padding: 6px 8px;
            border-radius: 4px;
            color: white;
            font-size: 0.875rem;
        }
        
        .item-creation .btn-add {
            padding: 6px 12px;
            font-size: 0.875rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 dark:text-gray-200">
    <div class="flex h-screen font-sans" id="app">
        <aside class="left-col w-64 bg-gray-800 text-white p-4 flex-shrink-0 dark:bg-black">
            <div class="left-col-main-content">
                <div class="app-header app-header-selected" id="home-btn">
                    <h1 class="text-2xl font-bold mb-2 underline">ALL SONGS</h1>
                    <p class="text-sm whitespace-nowrap">Organize music performances</p>
                </div>

                <div class="mb-2 p-2 rounded-lg bg-gray-700" id="nav-setlists">
                    <div class="flex items-center justify-between">
                        <span class="font-medium uppercase">Setlists</span>
                        <button class="text-sm px-2 py-1 rounded-md bg-gray-600" id="toggle-setlists">▾</button>
                    </div>
                    <div class="mt-2" id="setlists-container"></div>
                    <div class="mt-2">
                        <input class="w-full p-1 text-sm rounded-md bg-gray-700" id="new-setlist-name" placeholder="New setlist name" />
                        <button class="w-full mt-1 p-1 text-sm rounded-md btn-add" id="add-setlist-btn">Add Setlist</button>
                    </div>
                </div>
                <div class="sidebar-item" id="nav-favorites">Favorites</div>
                <div class="sidebar-item" id="nav-plays">Plays</div>
                <div class="sidebar-item" id="nav-recordings">Recordings</div>
                <div class="sidebar-item" id="nav-energy">Energy Levels</div>

                <div class="mt-4">
                    <h3 class="text-sm font-semibold uppercase">Genres</h3>
                     <div class="item-creation">
                        <input type="color" id="genre-color" value="#3b82f6" title="Select color">
                        <input class="item-name-input" id="genre-name" placeholder="New genre" />
                        <button class="p-1 px-2 text-sm rounded-md whitespace-nowrap btn-add" id="add-genre">Add</button>
                    </div>
                    <div class="mt-2 space-y-1" id="genre-list"></div>
                </div>

                <div class="mt-4">
                    <h3 class="text-sm font-semibold uppercase">Venues</h3>
                    <div class="item-creation">
                        <input class="item-name-input" id="venue-name" placeholder="New venue" />
                        <button class="p-1 px-2 text-sm rounded-md whitespace-nowrap btn-add" id="add-venue">Add</button>
                    </div>
                    <div class="mt-2 space-y-1" id="venue-list"></div>
                </div>
            </div>
            
            <div class="stats-container">
                <h3 class="stats-title">Top Played</h3>
                <ul class="text-xs mt-1" id="top-played"></ul>
                <h3 class="stats-title mt-3">Least Played</h3>
                <ul class="text-xs mt-1" id="least-played"></ul>
            </div>
        </aside>

        <button id="sidebar-toggle">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>

        <main class="flex-1 p-4 overflow-auto">
            <section id="master-view">
                 <div id="master-view-controls">
                    <div id="search-container">
                        <input class="w-full p-2 rounded-lg border-transparent shadow-sm dark:bg-gray-700 dark:border-gray-600" id="search" placeholder="Search all songs..." />
                        <datalist id="search-results"></datalist>
                        <div id="dark-mode-container">
                             <label for="dark-mode-toggle" class="flex items-center cursor-pointer ml-4">
                                <span class="mr-2 text-sm text-gray-600 dark:text-gray-300">Dark</span>
                                <div class="relative">
                                    <input type="checkbox" id="dark-mode-toggle" class="dark-mode-toggle sr-only">
                                    <div class="block bg-gray-600 w-12 h-7 rounded-full"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-5 h-5 rounded-full transition"></div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div id="controls-row">
                        <div id="filters-group">
                            <select id="sort-dropdown" class="p-2 rounded-lg bg-transparent text-sm dark:bg-transparent dark:text-gray-200 filter-select">
                                <option value="name">Sort by Name</option>
                                <option value="artist">Sort by Artist</option>
                                <option value="lastPlayed">Sort by Last Played</option>
                                <option value="energy">Sort by Energy</option>
                            </select>
                            <div id="genre-filter-container" class="relative">
                                <button id="genre-filter-button" class="p-2 rounded-lg bg-transparent text-sm text-left dark:bg-transparent dark:text-gray-200">Select Genres</button>
                                <div id="genre-filter-dropdown" class="hidden absolute z-10 mt-1 w-48 bg-white rounded-xl shadow-lg max-h-60 overflow-y-auto dark:bg-gray-800 dark:border dark:border-gray-700"></div>
                            </div>
                        </div>
                        <div id="master-view-buttons" class="flex gap-2">
                            <input accept=".pdf" class="hidden" id="master-upload" multiple="" type="file" />
                            <button class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow btn-master" id="upload-master-btn">Add files</button>
                            <button class="p-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition shadow btn-master" id="delete-all-btn">Delete All</button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg overflow-hidden dark:bg-gray-800">
                    <ul id="master-list"></ul>
                </div>
                <div id="master-drop-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-8 pointer-events-none">
                    <div class="text-center bg-white dark:bg-gray-800 p-12 rounded-2xl border-4 border-dashed border-blue-500">
                        <h2 class="text-2xl font-bold">Drop Files Here</h2>
                        <p>Add PDF song sheets to ALL SONGS</p>
                    </div>
                </div>
            </section>


            <section class="hidden" id="setlist-view">
                 <div class="flex items-center gap-2 mb-2">
                    <button id="back-to-venue-btn" class="hidden p-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition dark:bg-gray-700 dark:hover:bg-gray-600">← Back</button>
                    <h2 class="text-xl font-bold" id="setlist-title">Setlist</h2>
                    <p id="setlist-total-duration" class="text-sm text-gray-500 dark:text-white ml-2"></p>
                    <p id="setlist-song-count" class="text-sm text-gray-500 dark:text-white ml-2"></p>
                </div>

                <div class="flex items-end justify-between flex-wrap gap-4 mb-2">
                    <div class="flex items-center gap-2">
                        <button id="record-show" class="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition shadow">Record Show</button>
                        <button id="stop-record" class="p-2 bg-red-600 text-white rounded-lg hidden shadow">Stop Recording</button>
                        <button id="print-setlist" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow">Print Setlist</button>
                        <div class="relative inline-block">
                            <button id="share-setlist-btn" class="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition shadow">Share Setlist</button>
                            <div id="share-options" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg z-20 dark:bg-gray-800 dark:border dark:border-gray-700">
                                <a href="#" id="share-native" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700">Share with Device (inc. PDFs)</a>
                                <a href="#" id="share-email" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700">Share via Email (text only)</a>
                                <a href="#" id="share-gmail" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700">Share via Gmail (text only)</a>
                                <a href="#" id="share-copy" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700">Copy to Clipboard (text only)</a>
                            </div>
                            <span id="copy-feedback" class="absolute right-0 -bottom-6 bg-gray-800 text-white text-xs rounded py-1 px-2 opacity-0 transition-opacity">Copied!</span>
                        </div>
                    </div>
                </div>
                
                <div id="setlist-details-container" class="mb-2">
                    <div id="setlist-details-toggle">
                        <span>Setlist Details</span>
                        <span class="toggle-arrow">▼</span>
                    </div>
                    <div id="setlist-details-content">
                        <div>
                            <label for="setlist-date">Date:</label>
                            <input type="date" id="setlist-date" class="p-1 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        <div>
                            <label for="setlist-venue">Venue:</label>
                            <select id="setlist-venue" class="p-1 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600"></select>
                        </div>
                        <div>
                            <label for="setlist-start-time">Start Time:</label>
                            <input type="time" id="setlist-start-time" class="p-1 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        <div>
                            <label for="setlist-end-time">End Time:</label>
                            <input type="time" id="setlist-end-time" class="p-1 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        <div>
                            <label for="setlist-notes">Notes:</label>
                            <input type="text" id="setlist-notes" class="p-1 rounded-md border border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                        </div>
                    </div>
                </div>

                <div class="setlist-view-container">
                    <div class="setlist-panel">
                        <div class="panel-header">Setlist Songs</div>
                        <ul id="setlist-list" class="sortable"></ul>
                    </div>
                    <div class="setlist-panel">
                        <div class="panel-header">Add Songs</div>
                        <ul id="setlist-add-songs-list"></ul>
                    </div>
                </div>
            </section>

            <section class="hidden" id="favorites-view">
                <h2 class="text-xl font-bold mb-2">Favorites</h2>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden dark:bg-gray-800">
                    <ul id="favorites-list"></ul>
                </div>
            </section>

            <section class="hidden" id="plays-view">
                <h2 class="text-xl font-bold mb-2">Plays</h2>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden dark:bg-gray-800">
                    <ul id="plays-list"></ul>
                </div>
            </section>

            <section class="hidden" id="genre-view">
                <div class="flex items-center gap-2 mb-2">
                    <button id="back-to-all-btn" class="p-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition dark:bg-gray-700 dark:hover:bg-gray-600">← Back</button>
                    <h2 class="text-xl font-bold" id="genre-title">Genre</h2>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden dark:bg-gray-800">
                    <ul id="genre-song-list"></ul>
                </div>
            </section>
        </main>
    </div>

    <script>
        // State management
        const state = {
            songs: JSON.parse(localStorage.getItem('songs')) || [],
            setlists: JSON.parse(localStorage.getItem('setlists')) || [],
            genres: JSON.parse(localStorage.getItem('genres')) || [],
            venues: JSON.parse(localStorage.getItem('venues')) || [],
            plays: JSON.parse(localStorage.getItem('plays')) || [],
            favorites: JSON.parse(localStorage.getItem('favorites')) || [],
            currentView: 'master',
            currentSetlistId: null,
            currentGenreId: null,
            currentVenueId: null,
            selectedSongs: new Set(),
            recording: false,
            recordStartTime: null,
            recordedSongs: [],
            sortBy: 'name',
            genreFilter: new Set(),
            darkMode: localStorage.getItem('darkMode') === 'true'
        };

        // Initialize app
        function initApp() {
            applyDarkMode(state.darkMode);
            renderMasterList();
            renderSetlists();
            renderGenres();
            renderVenues();
            renderStats();
            setupEventListeners();
            setupDragAndDrop();
        }

        // Apply dark mode
        function applyDarkMode(isDark) {
            state.darkMode = isDark;
            localStorage.setItem('darkMode', isDark);
            document.documentElement.classList.toggle('dark', isDark);
            document.getElementById('dark-mode-toggle').checked = isDark;
        }

        // Render master list of songs
        function renderMasterList() {
            const masterList = document.getElementById('master-list');
            masterList.innerHTML = '';

            let filteredSongs = [...state.songs];

            // Apply genre filter
            if (state.genreFilter.size > 0) {
                filteredSongs = filteredSongs.filter(song => 
                    song.genre && state.genreFilter.has(song.genre)
                );
            }

            // Apply sorting
            filteredSongs.sort((a, b) => {
                switch (state.sortBy) {
                    case 'artist':
                        return (a.artist || '').localeCompare(b.artist || '');
                    case 'lastPlayed':
                        return new Date(b.lastPlayed || 0) - new Date(a.lastPlayed || 0);
                    case 'energy':
                        return (b.energy || 0) - (a.energy || 0);
                    default: // 'name'
                        return (a.name || '').localeCompare(b.name || '');
                }
            });

            filteredSongs.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-3 border-b border-gray-200 dark:border-gray-700 draggable';
                li.draggable = true;
                li.dataset.songId = song.id;

                const songGenre = state.genres.find(g => g.id === song.genre);
                const genreColor = songGenre ? songGenre.color : '#3b82f6';

                li.innerHTML = `
                    <div class="flex items-center flex-1 min-w-0">
                        <div class="genre-dot mr-3" style="background-color: ${genreColor}"></div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium truncate">${song.name}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 truncate">${song.artist || 'Unknown Artist'}</div>
                        </div>
                    </div>
                    <div class="song-details-container">
                        <input type="number" min="0" class="energy-input p-1 rounded border border-gray-300 dark:bg-gray-700 dark:border-gray-600" 
                               value="${song.energy || 0}" placeholder="Energy" title="Energy Level" />
                        <input type="text" class="duration-input p-1 rounded border border-gray-300 dark:bg-gray-700 dark:border-gray-600" 
                               value="${song.duration || ''}" placeholder="Duration" title="Duration (e.g., 3:30)" />
                        <button class="delete-btn p-1 bg-red-600 text-white rounded hover:bg-red-700 transition text-sm">Delete</button>
                    </div>
                `;

                // Add drag event listeners
                li.addEventListener('dragstart', handleDragStart);
                li.addEventListener('dragend', handleDragEnd);

                // Add event listeners for inputs and delete button
                const energyInput = li.querySelector('.energy-input');
                const durationInput = li.querySelector('.duration-input');
                const deleteBtn = li.querySelector('.delete-btn');

                energyInput.addEventListener('change', (e) => {
                    song.energy = parseInt(e.target.value) || 0;
                    saveState();
                });

                durationInput.addEventListener('change', (e) => {
                    song.duration = e.target.value;
                    saveState();
                });

                deleteBtn.addEventListener('click', () => {
                    if (confirm(`Are you sure you want to delete "${song.name}"?`)) {
                        state.songs = state.songs.filter(s => s.id !== song.id);
                        saveState();
                        renderMasterList();
                        renderStats();
                    }
                });

                masterList.appendChild(li);
            });
        }

        // Setup drag and drop
        function setupDragAndDrop() {
            // Master list drag and drop
            const masterList = document.getElementById('master-list');
            
            // Setlist reordering
            $('#setlist-list').sortable({
                placeholder: 'sortable-placeholder',
                revert: 100,
                start: function(event, ui) {
                    ui.item.addClass('drag-highlight');
                },
                stop: function(event, ui) {
                    ui.item.removeClass('drag-highlight');
                    
                    const songIds = [];
                    $('#setlist-list li').each(function() {
                        songIds.push($(this).data('song-id'));
                    });
                    
                    const setlist = state.setlists.find(s => s.id === state.currentSetlistId);
                    if (setlist) {
                        setlist.songs = songIds.map(id => state.songs.find(s => s.id === id)).filter(Boolean);
                        saveState();
                    }
                }
            }).disableSelection();
            
            // Setlist add songs panel drag and drop
            $('#setlist-add-songs-list').sortable({
                connectWith: '#setlist-list',
                placeholder: 'sortable-placeholder',
                revert: 100,
                start: function(event, ui) {
                    ui.item.addClass('drag-highlight');
                },
                stop: function(event, ui) {
                    ui.item.removeClass('drag-highlight');
                }
            }).disableSelection();
        }

        // Handle drag start
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.songId);
            e.target.classList.add('drag-highlight');
            
            // Set drag image to a smaller, blue version
            const dragImage = e.target.cloneNode(true);
            dragImage.style.width = e.target.offsetWidth + 'px';
            dragImage.style.backgroundColor = '#3b82f6';
            dragImage.style.color = 'white';
            dragImage.style.borderRadius = '0.5rem';
            dragImage.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
            dragImage.style.transform = 'rotate(5deg)';
            document.body.appendChild(dragImage);
            e.dataTransfer.setDragImage(dragImage, e.target.offsetWidth / 2, e.target.offsetHeight / 2);
            
            setTimeout(() => {
                document.body.removeChild(dragImage);
            }, 0);
        }

        // Handle drag end
        function handleDragEnd(e) {
            e.target.classList.remove('drag-highlight');
        }

        // Render setlists in sidebar
        function renderSetlists() {
            const container = document.getElementById('setlists-container');
            container.innerHTML = '';

            state.setlists.forEach(setlist => {
                const setlistEl = document.createElement('div');
                setlistEl.className = 'setlist-item';
                setlistEl.innerHTML = `
                    <span class="setlist-name">${setlist.name}</span>
                    <div class="flex items-center">
                        <div class="del-setlist">
                            <svg viewBox="0 0 24 24">
                                <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" />
                            </svg>
                        </div>
                    </div>
                `;

                setlistEl.addEventListener('click', () => {
                    showSetlist(setlist.id);
                });

                const deleteBtn = setlistEl.querySelector('.del-setlist');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`Delete setlist "${setlist.name}"?`)) {
                        state.setlists = state.setlists.filter(s => s.id !== setlist.id);
                        saveState();
                        renderSetlists();
                        if (state.currentSetlistId === setlist.id) {
                            showView('master');
                        }
                    }
                });

                container.appendChild(setlistEl);
            });
        }

        // Show setlist view
        function showSetlist(setlistId) {
            state.currentSetlistId = setlistId;
            const setlist = state.setlists.find(s => s.id === setlistId);
            if (!setlist) return;

            document.getElementById('setlist-title').textContent = setlist.name;
            renderSetlistSongs();
            renderAddSongsPanel();
            updateSetlistStats();
            showView('setlist');
        }

        // Render songs in setlist
        function renderSetlistSongs() {
            const setlistList = document.getElementById('setlist-list');
            setlistList.innerHTML = '';

            const setlist = state.setlists.find(s => s.id === state.currentSetlistId);
            if (!setlist) return;

            setlist.songs.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-3 border-b border-gray-200 dark:border-gray-700 draggable';
                li.draggable = true;
                li.dataset.songId = song.id;

                const songGenre = state.genres.find(g => g.id === song.genre);
                const genreColor = songGenre ? songGenre.color : '#3b82f6';

                li.innerHTML = `
                    <div class="flex items-center flex-1 min-w-0">
                        <div class="index-number mr-3 bg-blue-600 text-white text-xs">${index + 1}</div>
                        <div class="genre-dot mr-3" style="background-color: ${genreColor}"></div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium truncate">${song.name}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 truncate">${song.artist || 'Unknown Artist'}</div>
                        </div>
                    </div>
                    <div class="song-details-container">
                        <input type="number" min="0" class="energy-input p-1 rounded border border-gray-300 dark:bg-gray-700 dark:border-gray-600" 
                               value="${song.energy || 0}" placeholder="Energy" title="Energy Level" />
                        <input type="text" class="duration-input p-1 rounded border border-gray-300 dark:bg-gray-700 dark:border-gray-600" 
                               value="${song.duration || ''}" placeholder="Duration" title="Duration (e.g., 3:30)" />
                        <button class="remove-btn p-1 bg-red-600 text-white rounded hover:bg-red-700 transition text-sm">Remove</button>
                    </div>
                `;

                const removeBtn = li.querySelector('.remove-btn');
                removeBtn.addEventListener('click', () => {
                    setlist.songs = setlist.songs.filter(s => s.id !== song.id);
                    saveState();
                    renderSetlistSongs();
                    renderAddSongsPanel();
                    updateSetlistStats();
                });

                setlistList.appendChild(li);
            });

            // Re-initialize sortable for setlist reordering
            $('#setlist-list').sortable('refresh');
        }

        // Render add songs panel
        function renderAddSongsPanel() {
            const addSongsList = document.getElementById('setlist-add-songs-list');
            addSongsList.innerHTML = '';

            const setlist = state.setlists.find(s => s.id === state.currentSetlistId);
            if (!setlist) return;

            const setlistSongIds = new Set(setlist.songs.map(song => song.id));
            const availableSongs = state.songs.filter(song => !setlistSongIds.has(song.id));

            availableSongs.forEach(song => {
                const li = document.createElement('li');
                li.className = 'add-song-item draggable';
                li.draggable = true;
                li.dataset.songId = song.id;

                const songGenre = state.genres.find(g => g.id === song.genre);
                const genreColor = songGenre ? songGenre.color : '#3b82f6';

                li.innerHTML = `
                    <div class="genre-dot" style="background-color: ${genreColor}"></div>
                    <label for="add-song-${song.id}" class="flex-1 min-w-0">
                        <div class="font-medium truncate">${song.name}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400 truncate">${song.artist || 'Unknown Artist'}</div>
                    </label>
                    <input type="checkbox" id="add-song-${song.id}" class="song-checkbox" />
                `;

                const checkbox = li.querySelector('.song-checkbox');
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        setlist.songs.push(song);
                    } else {
                        setlist.songs = setlist.songs.filter(s => s.id !== song.id);
                    }
                    saveState();
                    renderSetlistSongs();
                    renderAddSongsPanel();
                    updateSetlistStats();
                });

                addSongsList.appendChild(li);
            });

            // Re-initialize sortable for add songs panel
            $('#setlist-add-songs-list').sortable('refresh');
        }

        // Update setlist statistics
        function updateSetlistStats() {
            const setlist = state.setlists.find(s => s.id === state.currentSetlistId);
            if (!setlist) return;

            const totalSongs = setlist.songs.length;
            const totalDuration = setlist.songs.reduce((total, song) => {
                if (song.duration) {
                    const [minutes, seconds] = song.duration.split(':').map(Number);
                    return total + (minutes * 60 + (seconds || 0));
                }
                return total;
            }, 0);

            const minutes = Math.floor(totalDuration / 60);
            const seconds = totalDuration % 60;

            document.getElementById('setlist-song-count').textContent = `${totalSongs} songs`;
            document.getElementById('setlist-total-duration').textContent = 
                totalDuration > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : '';
        }

        // Render genres in sidebar
        function renderGenres() {
            const genreList = document.getElementById('genre-list');
            genreList.innerHTML = '';

            state.genres.forEach(genre => {
                const genreEl = document.createElement('div');
                genreEl.className = 'sidebar-item';
                genreEl.innerHTML = `
                    <div class="genre-content">
                        <div class="genre-dot" style="background-color: ${genre.color}"></div>
                        <span class="genre-name">${genre.name}</span>
                    </div>
                    <div class="delete-genre">✕</div>
                `;

                genreEl.addEventListener('click', () => {
                    showGenre(genre.id);
                });

                const deleteBtn = genreEl.querySelector('.delete-genre');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`Delete genre "${genre.name}"? This will remove the genre from all songs.`)) {
                        // Remove genre from songs
                        state.songs.forEach(song => {
                            if (song.genre === genre.id) {
                                song.genre = null;
                            }
                        });
                        state.genres = state.genres.filter(g => g.id !== genre.id);
                        saveState();
                        renderGenres();
                        renderMasterList();
                        if (state.currentGenreId === genre.id) {
                            showView('master');
                        }
                    }
                });

                genreList.appendChild(genreEl);
            });
        }

        // Show genre view
        function showGenre(genreId) {
            state.currentGenreId = genreId;
            const genre = state.genres.find(g => g.id === genreId);
            if (!genre) return;

            document.getElementById('genre-title').textContent = genre.name;
            renderGenreSongs();
            showView('genre');
        }

        // Render songs in genre view
        function renderGenreSongs() {
            const genreSongList = document.getElementById('genre-song-list');
            genreSongList.innerHTML = '';

            const genreSongs = state.songs.filter(song => song.genre === state.currentGenreId);

            genreSongs.forEach(song => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-3 border-b border-gray-200 dark:border-gray-700';
                li.dataset.songId = song.id;

                const genre = state.genres.find(g => g.id === state.currentGenreId);
                const genreColor = genre ? genre.color : '#3b82f6';

                li.innerHTML = `
                    <div class="flex items-center flex-1 min-w-0">
                        <div class="genre-dot mr-3" style="background-color: ${genreColor}"></div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium truncate">${song.name}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 truncate">${song.artist || 'Unknown Artist'}</div>
                        </div>
                    </div>
                    <div class="song-details-container">
                        <input type="number" min="0" class="energy-input p-1 rounded border border-gray-300 dark:bg-gray-700 dark:border-gray-600" 
                               value="${song.energy || 0}" placeholder="Energy" title="Energy Level" />
                        <input type="text" class="duration-input p-1 rounded border border-gray-300 dark:bg-gray-700 dark:border-gray-600" 
                               value="${song.duration || ''}" placeholder="Duration" title="Duration (e.g., 3:30)" />
                        <button class="remove-genre-btn p-1 bg-red-600 text-white rounded hover:bg-red-700 transition text-sm">Remove</button>
                    </div>
                `;

                const removeBtn = li.querySelector('.remove-genre-btn');
                removeBtn.addEventListener('click', () => {
                    song.genre = null;
                    saveState();
                    renderGenreSongs();
                    renderMasterList();
                });

                genreSongList.appendChild(li);
            });
        }

        // Render venues in sidebar
        function renderVenues() {
            const venueList = document.getElementById('venue-list');
            venueList.innerHTML = '';

            state.venues.forEach(venue => {
                const venueEl = document.createElement('div');
                venueEl.className = 'sidebar-item';
                venueEl.innerHTML = `
                    <span class="venue-name">${venue.name}</span>
                    <div class="delete-venue">✕</div>
                `;

                venueEl.addEventListener('click', () => {
                    // TODO: Implement venue view
                    alert(`Venue: ${venue.name}`);
                });

                const deleteBtn = venueEl.querySelector('.delete-venue');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`Delete venue "${venue.name}"?`)) {
                        state.venues = state.venues.filter(v => v.id !== venue.id);
                        saveState();
                        renderVenues();
                    }
                });

                venueList.appendChild(venueEl);
            });
        }

        // Render statistics
        function renderStats() {
            const topPlayed = document.getElementById('top-played');
            const leastPlayed = document.getElementById('least-played');

            // Calculate play counts
            const playCounts = {};
            state.plays.forEach(play => {
                play.songs.forEach(songId => {
                    playCounts[songId] = (playCounts[songId] || 0) + 1;
                });
            });

            const songsWithPlays = state.songs.map(song => ({
                ...song,
                playCount: playCounts[song.id] || 0
            }));

            const topPlayedSongs = [...songsWithPlays]
                .filter(song => song.playCount > 0)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 5);

            const leastPlayedSongs = [...songsWithPlays]
                .filter(song => song.playCount > 0)
                .sort((a, b) => a.playCount - b.playCount)
                .slice(0, 5);

            topPlayed.innerHTML = topPlayedSongs.map(song => 
                `<li class="truncate">${song.name} (${song.playCount})</li>`
            ).join('');

            leastPlayed.innerHTML = leastPlayedSongs.map(song => 
                `<li class="truncate">${song.name} (${song.playCount})</li>`
            ).join('');
        }

        // Show view
        function showView(view) {
            state.currentView = view;
            document.querySelectorAll('main > section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`${view}-view`).classList.remove('hidden');

            // Update header selection
            const header = document.getElementById('home-btn');
            if (view === 'master') {
                header.classList.remove('app-header-unselected');
                header.classList.add('app-header-selected');
            } else {
                header.classList.remove('app-header-selected');
                header.classList.add('app-header-unselected');
            }
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('songs', JSON.stringify(state.songs));
            localStorage.setItem('setlists', JSON.stringify(state.setlists));
            localStorage.setItem('genres', JSON.stringify(state.genres));
            localStorage.setItem('venues', JSON.stringify(state.venues));
            localStorage.setItem('plays', JSON.stringify(state.plays));
            localStorage.setItem('favorites', JSON.stringify(state.favorites));
        }

        // Setup event listeners
        function setupEventListeners() {
            // Dark mode toggle
            document.getElementById('dark-mode-toggle').addEventListener('change', (e) => {
                applyDarkMode(e.target.checked);
            });

            // Header click to return to master view
            document.getElementById('home-btn').addEventListener('click', () => {
                showView('master');
            });

            // Navigation items
            document.getElementById('nav-favorites').addEventListener('click', () => {
                // TODO: Implement favorites view
                alert('Favorites view coming soon!');
            });

            document.getElementById('nav-plays').addEventListener('click', () => {
                // TODO: Implement plays view
                alert('Plays view coming soon!');
            });

            document.getElementById('nav-recordings').addEventListener('click', () => {
                // TODO: Implement recordings view
                alert('Recordings view coming soon!');
            });

            document.getElementById('nav-energy').addEventListener('click', () => {
                // TODO: Implement energy levels view
                alert('Energy levels view coming soon!');
            });

            // Setlist creation
            document.getElementById('add-setlist-btn').addEventListener('click', () => {
                const nameInput = document.getElementById('new-setlist-name');
                const name = nameInput.value.trim();
                if (name) {
                    const newSetlist = {
                        id: Date.now().toString(),
                        name: name,
                        songs: [],
                        date: new Date().toISOString().split('T')[0],
                        venue: null,
                        startTime: null,
                        endTime: null,
                        notes: ''
                    };
                    state.setlists.push(newSetlist);
                    saveState();
                    renderSetlists();
                    nameInput.value = '';
                }
            });

            // Genre creation
            document.getElementById('add-genre').addEventListener('click', () => {
                const nameInput = document.getElementById('genre-name');
                const colorInput = document.getElementById('genre-color');
                const name = nameInput.value.trim();
                if (name) {
                    const newGenre = {
                        id: Date.now().toString(),
                        name: name,
                        color: colorInput.value
                    };
                    state.genres.push(newGenre);
                    saveState();
                    renderGenres();
                    nameInput.value = '';
                }
            });

            // Venue creation
            document.getElementById('add-venue').addEventListener('click', () => {
                const nameInput = document.getElementById('venue-name');
                const name = nameInput.value.trim();
                if (name) {
                    const newVenue = {
                        id: Date.now().toString(),
                        name: name
                    };
                    state.venues.push(newVenue);
                    saveState();
                    renderVenues();
                    nameInput.value = '';
                }
            });

            // File upload
            document.getElementById('upload-master-btn').addEventListener('click', () => {
                document.getElementById('master-upload').click();
            });

            document.getElementById('master-upload').addEventListener('change', handleFileUpload);

            // Delete all songs
            document.getElementById('delete-all-btn').addEventListener('click', () => {
                if (confirm('Are you sure you want to delete ALL songs? This cannot be undone.')) {
                    state.songs = [];
                    saveState();
                    renderMasterList();
                    renderStats();
                }
            });

            // Sort dropdown
            document.getElementById('sort-dropdown').addEventListener('change', (e) => {
                state.sortBy = e.target.value;
                renderMasterList();
            });

            // Setlist details toggle
            document.getElementById('setlist-details-toggle').addEventListener('click', () => {
                const content = document.getElementById('setlist-details-content');
                const toggle = document.getElementById('setlist-details-toggle');
                if (content.style.display === 'flex') {
                    content.style.display = 'none';
                    toggle.classList.remove('open');
                } else {
                    content.style.display = 'flex';
                    toggle.classList.add('open');
                }
            });

            // Back buttons
            document.getElementById('back-to-all-btn').addEventListener('click', () => {
                showView('master');
            });

            // Sidebar toggle
            document.getElementById('sidebar-toggle').addEventListener('click', () => {
                const leftCol = document.querySelector('.left-col');
                leftCol.classList.toggle('collapsed');
            });
        }

        // Handle file upload
        function handleFileUpload(e) {
            const files = e.target.files;
            Array.from(files).forEach(file => {
                if (file.type === 'application/pdf') {
                    const song = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        name: file.name.replace('.pdf', ''),
                        artist: 'Unknown Artist',
                        file: file,
                        energy: 0,
                        duration: '',
                        genre: null,
                        lastPlayed: null
                    };
                    state.songs.push(song);
                }
            });
            saveState();
            renderMasterList();
            renderStats();
            e.target.value = '';
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>
