<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>Setlist Manager - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
    <style>
        html,
        body,
        #app {
            height: 100%;
            overflow: hidden;
        }

        body.doc-viewer-active {
            overflow: hidden;
        }

        .sortable {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .draggable {
            cursor: move;
        }

        /* Unified selected style for sidebar items */
        .selected,
        .venue-item.selected,
        .genre-item.selected {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
        }

        .dark .selected,
        .dark .venue-item.selected,
        .dark .genre-item.selected {
            background-color: #3b82f6;
            color: white;
        }

        .venue-item.selected:hover,
        .dark .venue-item.selected:hover,
        .genre-item.selected:hover,
        .dark .genre-item.selected:hover {
            background-color: #3b82f6;
        }

        .venue-item.selected .venue-name,
        .genre-item.selected .genre-name {
            color: white;
        }

        /* Consistent Add Button Style */
        .btn-add {
            background-color: #3b82f6;
            color: white;
            border: none;
            transition: background-color 0.2s;
            flex-shrink: 0; /* Prevent button from shrinking */
        }
        .btn-add:hover {
            background-color: #2563eb;
        }

        .genre-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Fullscreen viewer styles */
        .doc-view-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 100;
            background: white;
        }

        .dark .doc-view-fullscreen {
            background: #111827;
        }

        .doc-nav-buttons {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            z-index: 103;
            opacity: 1;
            transition: opacity 0.3s;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dark .doc-nav-buttons {
            background: rgba(31, 41, 55, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .doc-nav-buttons.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .doc-nav-button {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            border: none;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            user-select: none;
        }

        .doc-nav-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .doc-nav-close {
            background: #ef4444;
        }

        .doc-nav-button:not(:disabled):hover {
            background-color: #2563eb;
        }

        .doc-nav-close:hover {
            background-color: #dc2626;
        }

        #doc-iframe-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99;
        }

        #doc-object {
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* Setlist delete button */
        .del-setlist {
            background: #ef4444;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
        }

        .del-setlist svg {
            width: 14px;
            height: 14px;
            fill: white;
        }

        .del-setlist:hover {
            background: #dc2626;
        }

        .setlist-item {
            display: flex;
            align-items: center;
            transition: all 0.2s ease-out;
        }

        .setlist-name {
            flex: 1;
        }

        /* Song selector */
        .song-selector-container {
            height: calc(100% - 150px);
            overflow-y: auto;
            padding: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dark .song-selector-container {
            background: #1f2937;
        }

        .song-selector-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            border-radius: 4px;
            margin-bottom: 4px;
            background: #f8fafc;
        }

        .dark .song-selector-item {
            background: #374151;
        }

        .song-selector-item:hover {
            background: #e2e8f0;
        }

        .dark .song-selector-item:hover {
            background: #4b5563;
        }

        .song-selector-item input {
            margin-right: 8px;
        }

        /* Setlist container */
        .setlist-container {
            display: flex;
            gap: 4px;
            height: calc(100% - 180px);
        }

        .setlist-songs-container {
            width: 75%;
            height: 100%;
            overflow-y: auto;
        }

        .setlist-selector-container {
            width: 25%;
            height: 100%;
        }
        
        /* Setlist Details Collapsible Section */
        #setlist-details-toggle {
            padding: 0.5rem 0.75rem;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        .dark #setlist-details-toggle {
            background-color: #374151;
        }
        #setlist-details-toggle .toggle-arrow {
            transition: transform 0.2s ease-in-out;
        }
        #setlist-details-toggle.open .toggle-arrow {
            transform: rotate(180deg);
        }
        #setlist-details-content {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            padding: 0.75rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            flex-wrap: wrap;
        }
        .dark #setlist-details-content {
            background-color: #374151;
        }

        /* Drag feedback */
        .drag-highlight {
            background-color: #dbeafe;
            border: 2px dashed #3b82f6;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
        }

        .dark .drag-highlight {
            background-color: #1e3a8a;
        }

        /* Header styling */
        .app-header {
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            transition: background 0.3s ease;
            cursor: pointer;
        }
        .app-header-selected {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        .app-header-unselected {
            background: #374151; /* Unified gray color */
        }
        .app-header-unselected:hover {
            background: #4b5563;
        }

        /* Stats section */
        .stats-container {
            background-color: #f3f4f6;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
            color: #1f2937;
        }

        .dark .stats-container {
            background-color: #374151;
            color: #d1d5db;
        }

        .stats-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1e40af;
        }

        .dark .stats-title {
            color: #60a5fa;
        }

        /* Animation for file addition */
        @keyframes highlight {
            0% {
                background-color: rgba(163, 230, 53, 0.5);
            }

            100% {
                background-color: transparent;
            }
        }

        .new-file {
            animation: highlight 1.5s ease-in-out;
        }

        .drop-flash {
            animation: highlight 1s ease-out;
        }

        .item-selected {
            background-color: #dbeafe !important;
        }

        .dark .item-selected {
            background-color: #1e3a8a !important;
        }


        /* Sidebar List Item Styling (Unified) */
        .sidebar-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-radius: 0.5rem;
            margin-bottom: 4px;
            background: #374151; /* Unified gray color */
            cursor: pointer;
            color: #e5e7eb;
        }
        .sidebar-item:hover {
            background: #4b5563;
        }

        .genre-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .delete-genre,
        .delete-venue {
            color: #ef4444;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .delete-genre:hover,
        .delete-venue:hover {
            background-color: #fee2e2;
        }

        .dark .delete-genre:hover,
        .dark .delete-venue:hover {
            background-color: #991b1b;
        }

        .genre-name,
        .venue-name {
            font-weight: 600;
        }

        /* Sortable placeholder */
        .sortable-placeholder {
            height: 66px; /* Match item padding */
            background-color: #dbeafe;
            border: 2px dashed #3b82f6;
            visibility: visible !important;
        }

        .dark .sortable-placeholder {
            background-color: #1e3a8a;
        }

        /* Drag feedback */
        .dragging-source {
            opacity: 0.7;
            transform: scale(0.95);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* Drag helper styling */
        .ui-sortable-helper,
        .ui-draggable-dragging {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        /* Document viewer top bar */
        .doc-top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 20px;
            z-index: 102;
            background: transparent;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            opacity: 0;
            transition: opacity 0.3s, height 0.3s;
        }

        .doc-top-bar.visible {
            opacity: 1;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
        }

        .dark .doc-top-bar.visible {
            background: rgba(0, 0, 0, 0.1);
        }

        .doc-top-bar.visible::after {
            content: "Click to show controls";
            color: #4b5563;
            font-size: 14px;
        }

        .dark .doc-top-bar.visible::after {
            color: #9ca3af;
        }

        .no-select {
            user-select: none;
        }

        /* New genre/venue creation styles */
        .item-creation {
            display: flex;
            gap: 8px;
            align-items: center;
            width: 100%; /* Ensure container takes full width */
        }

        .item-creation input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            padding: 0;
            border: 1px solid white;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            background-color: transparent;
        }
        .item-creation input[type="color"]::-webkit-color-swatch {
            border-radius: 3px;
            border: none;
        }

        .item-name-input {
            padding: 4px 8px;
            border-radius: 0.5rem;
            background: #1f2937;
            border: 1px solid #4b5563;
            color: white;
            height: 32px;
            min-width: 0; /* Important for flexbox shrinking */
            flex: 1 1 auto; /* Allow shrinking and growing */
        }
        
        .genre-edit-input {
            width: 100%;
            padding: 2px 4px;
            border-radius: 4px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #000;
        }

        .dark .genre-edit-input {
            background: #4b5563;
            border-color: #6b7280;
            color: #fff;
        }

        /* Smoother Sidebar Transition */
        .left-col {
            overflow: hidden; /* Hide content during transition */
            transition: width 0.35s cubic-bezier(0.4, 0, 0.2, 1), padding 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .left-col.collapsed {
            width: 0;
            padding: 0;
        }

        #sidebar-toggle {
            background-color: #1f2937;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 60px;
            border-radius: 0 8px 8px 0;
            flex-shrink: 0;
            transition: all 0.3s ease-in-out;
        }

        #sidebar-toggle:hover {
            background-color: #374151;
        }

        /* Setlist selector search */
        .setlist-selector-search {
            margin-bottom: 8px;
        }

        /* Dark Mode Toggle */
        #dark-mode-toggle+div {
            transition: all 0.3s ease;
        }

        #dark-mode-toggle:checked+div {
            background-color: #22c55e;
        }

        #dark-mode-toggle:checked+div .dot {
            transform: translateX(20px);
        }

        #dark-mode-toggle+div .dot {
            transition: all 0.3s ease;
        }

        /* Modal Styles */
        #song-details-modal {
            z-index: 200;
        }

        #song-details-modal-content {
            max-height: 80vh;
            border-radius: 0.75rem;
        }

        /* Setlist viewed song style */
        .index-number.viewed-index {
            background-color: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Favorite star styles */
        .favorite-star-container {
            cursor: pointer;
            color: #d1d5db;
        }

        .favorite-star-container:hover {
            color: white;
        }

        .favorite-star-container.favorited .star-filled {
            display: inline-block;
            color: white;
        }

        .favorite-star-container.favorited .star-outline {
            display: none;
        }

        .favorite-star-container:not(.favorited) .star-filled {
            display: none;
        }

        .favorite-star-container:not(.favorited) .star-outline {
            display: inline-block;
        }

        /* Energy Level 3 Animation */
        .energy-svg-3 {
            overflow: visible !important;
        }
        .energy-svg-3 .sparks path {
            opacity: 0;
            transform-origin: center center;
        }
        .energy-svg-3.spark-burst .sparks path {
            animation: spark-burst-indiv 0.5s ease-out forwards;
        }
        .energy-svg-3.spark-burst .sparks path:nth-child(1) { animation-delay: 0s; }
        .energy-svg-3.spark-burst .sparks path:nth-child(2) { animation-delay: 0.1s; }
        .energy-svg-3.spark-burst .sparks path:nth-child(3) { animation-delay: 0.05s; }
        .energy-svg-3.spark-burst .sparks path:nth-child(4) { animation-delay: 0.15s; }
        .energy-svg-3.spark-burst .sparks path:nth-child(5) { animation-delay: 0.12s; }


        @keyframes spark-burst-indiv {
            0% { transform: scale(0.3) rotate(0deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: scale(1) rotate(15deg); opacity: 1; } /* Sparks remain visible and static */
        }
        
        /* iPad & Touch Device Enhancements */
        .left-col,
        main.overflow-auto,
        .song-selector-container,
        .setlist-songs-container,
        #genre-filter-dropdown,
        #setlist-adder-genre-filter-dropdown,
        #song-details-modal-content {
            -webkit-overflow-scrolling: touch;
        }

        /* Increase touch target size for easier tapping on touch devices */
        #master-list > li, #setlist-list > li, #favorites-list > li, #plays-list > li, #genre-song-list > li {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        #plays-list > li {
            padding-left: 1rem;
        }


        /* Responsive styles */
        @media (max-width: 1024px) {
            .left-col {
                width: 256px;
            }

            .setlist-container {
                flex-direction: column;
            }

            .setlist-songs-container,
            .setlist-selector-container {
                width: 100%;
            }

            .setlist-selector-container {
                margin-top: 1rem;
            }

            #master-upload-container {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            #master-upload-container > div:first-child {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            #app {
                flex-direction: column;
            }

            .left-col {
                width: 100%;
                height: auto;
                max-height: 50vh;
            }

            .left-col.collapsed {
                width: 100%;
                height: 0;
            }

            main {
                height: auto;
            }

            .controls-container {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            #setlist-view .flex.gap-2.mb-2.items-center {
                flex-wrap: wrap;
            }
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 dark:text-gray-200">
    <div class="flex h-screen font-sans" id="app">
        <aside class="left-col w-64 bg-gray-800 text-white p-4 flex-shrink-0 dark:bg-black">
            <div class="app-header app-header-selected" id="home-btn">
                <h1 class="text-2xl font-bold mb-2 underline">ALL SONGS</h1>
                <p class="text-sm whitespace-nowrap">Organize music performances</p>
            </div>

            <div class="mb-2 p-2 rounded-lg bg-gray-700" id="nav-setlists">
                <div class="flex items-center justify-between">
                    <span class="font-medium uppercase">Setlists</span>
                    <button class="text-sm px-2 py-1 rounded-md bg-gray-600" id="toggle-setlists">▾</button>
                </div>
                <div class="mt-2" id="setlists-container"></div>
                <div class="mt-2">
                    <input class="w-full p-1 text-sm rounded-md bg-gray-700" id="new-setlist-name" placeholder="New setlist name" />
                    <button class="w-full mt-1 p-1 text-sm rounded-md btn-add" id="add-setlist-btn">Add Setlist</button>
                </div>
            </div>
            <div class="sidebar-item" id="nav-favorites">Favorites</div>
            <div class="sidebar-item" id="nav-plays">Plays</div>
            <div class="sidebar-item" id="nav-recordings">Recordings</div>
            <div class="sidebar-item" id="nav-energy">Energy Levels</div>

            <div class="mt-4">
                <h3 class="text-sm font-semibold uppercase">Genres</h3>
                <div class="mt-2">
                    <div class="item-creation">
                        <input type="color" id="genre-color" value="#3b82f6" title="Select color">
                        <input class="item-name-input" id="genre-name" placeholder="New genre" />
                        <button class="p-1 px-2 text-sm rounded-md whitespace-nowrap btn-add" id="add-genre">Add</button>
                    </div>
                </div>
                <div class="mt-2 space-y-1" id="genre-list"></div>
            </div>

            <div class="mt-4">
                <h3 class="text-sm font-semibold uppercase">Venues</h3>
                <div class="mt-2">
                    <div class="item-creation">
                        <input class="item-name-input" id="venue-name" placeholder="New venue" />
                        <button class="p-1 px-2 text-sm rounded-md whitespace-nowrap btn-add" id="add-venue">Add</button>
                    </div>
                </div>
                <div class="mt-2 space-y-1" id="venue-list"></div>
            </div>

            <div class="stats-container">
                <h3 class="stats-title">Top Played</h3>
                <ul class="text-xs mt-1" id="top-played"></ul>
                <h3 class="stats-title mt-3">Least Played</h3>
                <ul class="text-xs mt-1" id="least-played"></ul>
            </div>
        </aside>

        <button id="sidebar-toggle">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>

        <main class="flex-1 p-4 overflow-auto">
            <div class="flex items-start justify-between mb-3" id="master-upload-container">
                <div class="w-1/3">
                    <input class="w-full p-2 rounded-lg border-transparent shadow-sm dark:bg-gray-700 dark:border-gray-600" id="search" placeholder="Search all songs..." />
                    <datalist id="search-results"></datalist>
                </div>

                <div class="flex items-center gap-2">
                    <input accept=".pdf" class="hidden" id="master-upload" multiple="" type="file" />
                    <button class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow" id="upload-master-btn">Add files</button>
                    <button class="p-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition shadow" id="delete-all-btn">Delete All</button>
                    <button class="p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition shadow" disabled="" id="undo-btn">Undo</button>
                    <button class="p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition shadow" disabled="" id="redo-btn">Redo</button>

                    <label for="dark-mode-toggle" class="flex items-center cursor-pointer">
                        <span class="mr-2 text-sm text-gray-600 dark:text-gray-300">Dark Mode</span>
                        <div class="relative">
                            <input type="checkbox" id="dark-mode-toggle" class="sr-only">
                            <div class="block bg-gray-600 w-12 h-7 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-5 h-5 rounded-full transition"></div>
                        </div>
                    </label>
                </div>
            </div>

            <section id="master-view">
                <div class="flex items-center gap-2 mb-2 flex-wrap controls-container">
                    <div class="relative">
                        <select id="sort-dropdown" class="p-2 rounded-lg bg-white border-transparent shadow-sm text-sm appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 pr-8 dark:bg-gray-700 dark:border-gray-600">
                            <option value="name">Sort by Name</option>
                            <option value="artist">Sort by Artist</option>
                            <option value="lastPlayed">Sort by Last Played</option>
                            <option value="energy">Sort by Energy</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" /></svg>
                        </div>
                    </div>
                    <div id="genre-filter-container" class="relative">
                        <button id="genre-filter-button" class="p-2 rounded-lg bg-white border-transparent shadow-sm text-sm w-48 text-left dark:bg-gray-700 dark:border-gray-600">Select Genres</button>
                        <div id="genre-filter-dropdown" class="hidden absolute z-10 mt-1 w-48 bg-white rounded-xl shadow-lg max-h-60 overflow-y-auto dark:bg-gray-800 dark:border dark:border-gray-700"></div>
                    </div>
                    <button id="clear-filters-btn" class="p-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition text-sm dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 shadow-sm">Clear Filters</button>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden dark:bg-gray-800">
                    <ul class="sortable divide-y divide-gray-200 dark:divide-gray-700" id="master-list"></ul>
                </div>
                <div id="master-drop-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-8 pointer-events-none">
                    <div class="text-center bg-white dark:bg-gray-800 p-12 rounded-2xl border-4 border-dashed border-blue-500">
                        <h2 class="text-2xl font-bold">Drop Files Here</h2>
                        <p>Add PDF song sheets to ALL SONGS</p>
                    </div>
                </div>
            </section>


            <section class="hidden" id="setlist-view">
                <div class="flex items-center gap-2 mb-2">
                    <button id="back-to-venue-btn" class="hidden p-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition dark:bg-gray-700 dark:hover:bg-gray-600">← Back</button>
                    <h2 class="text-xl font-bold" id="setlist-title">Setlist</h2>
                    <p id="setlist-total-duration" class="text-sm text-gray-500 dark:text-white ml-2"></p>
                    <p id="setlist-song-count" class="text-sm text-gray-500 dark:text-white ml-2"></p>
                </div>

                <div class="flex items-end justify-between flex-wrap gap-4 mb-2">
                    <div class="flex items-center gap-2">
                        <button id="record-show" class="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition shadow">Record Show</button>
                        <button id="stop-record" class="p-2 bg-red-600 text-white rounded-lg hidden shadow">Stop Recording</button>
                        <button id="print-setlist" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow">Print Setlist</button>
                        <div class="relative inline-block">
                            <button id="share-setlist-btn" class="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition shadow">Share Setlist</button>
                            <div id="share-options" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg z-20 dark:bg-gray-800 dark:border dark:border-gray-700">
                                <a href="#" id="share-native" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700">Share with Device (inc. PDFs)</a>
                                <a href="#" id="share-email" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700">Share via Email (text only)</a>
                                <a href="#" id="share-gmail" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700">Share via Gmail (text only)</a>
                                <a href="#" id="share-copy" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700">Copy to Clipboard (text only)</a>
                            </div>
                            <span id="copy-feedback" class="absolute right-0 -bottom-6 bg-gray-800 text-white text-xs rounded py-1 px-2 opacity-0 transition-opacity">Copied!</span>
                        </div>
                    </div>
                </div>

                <div id="setlist-details-container" class="mb-2">
                    <div id="setlist-details-toggle">
                        <span>Setlist Details</span>
                        <span class="toggle-arrow">▾</span>
                    </div>
                    <div id="setlist-details-content" style="display: none;">
                        <div>
                            <label for="setlist-date" class="font-medium text-xs">Date</label>
                            <input type="date" id="setlist-date" class="block p-1 rounded-lg dark:bg-gray-700 dark:border-gray-600 w-44">
                        </div>
                        <div>
                            <label for="setlist-venue" class="font-medium text-xs">Venue</label>
                            <input type="text" id="setlist-venue" placeholder="Enter venue" class="block p-1 rounded-lg dark:bg-gray-700 dark:border-gray-600 w-44">
                        </div>
                        <div class="relative">
                            <label for="setlist-sort-filter-dropdown" class="font-medium text-xs">Order</label>
                            <select id="setlist-sort-filter-dropdown" class="block p-1 rounded-lg bg-white border-transparent text-sm appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 pr-8 dark:bg-gray-700 dark:border-gray-600 w-44">
                                <option value="custom">Custom Order</option>
                                <option value="name">Sort by Name</option>
                                <option value="artist">Sort by Artist</option>
                                <option value="genre">Sort by Genre</option>
                                <option value="energy">Sort by Energy</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 bottom-0 right-0 flex items-center px-2 text-gray-700 mb-1">
                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                    <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" /></svg>
                            </div>
                        </div>
                    </div>
                </div>


                <div id="setlist-recordings" class="mb-2"></div>


                <div class="setlist-container">
                    <div class="setlist-songs-container bg-white rounded-xl shadow-lg overflow-auto dark:bg-gray-800">
                        <ul class="sortable divide-y divide-gray-200 dark:divide-gray-700" id="setlist-list"></ul>
                    </div>
                    <div class="setlist-selector-container">
                        <div class="bg-white rounded-xl shadow-lg p-2 mb-2 dark:bg-gray-800 h-full flex flex-col">
                            <h3 class="font-semibold mb-2">Add Songs</h3>

                            <div class="setlist-selector-search">
                                <input class="w-full p-2 rounded-lg border-transparent shadow-sm dark:bg-gray-700 dark:border-gray-600" id="setlist-search" placeholder="Search songs..." />
                            </div>

                            <div class="flex items-center gap-2 my-2">
                                <div class="flex-1">
                                    <select id="right-selector-sort" class="w-full p-2 rounded-lg border-transparent shadow-sm dark:bg-gray-700 dark:border-gray-600 text-sm">
                                        <option value="default">Default Order</option>
                                        <option value="name">Sort by Name</option>
                                        <option value="artist">Sort by Artist</option>
                                        <option value="genre">Sort by Genre</option>
                                        <option value="energy">Sort by Energy</option>
                                    </select>
                                </div>
                                <div id="setlist-adder-genre-filter-container" class="relative">
                                    <button id="setlist-adder-genre-filter-button" class="p-2 rounded-lg bg-white border-transparent shadow-sm text-sm w-full dark:bg-gray-700 dark:border-gray-600">Genre</button>
                                    <div id="setlist-adder-genre-filter-dropdown" class="hidden absolute z-10 mt-1 w-48 bg-white rounded-xl shadow-lg max-h-60 overflow-y-auto right-0 dark:bg-gray-800 dark:border dark:border-gray-700"></div>
                                </div>
                            </div>
                            <ul class="song-selector-container flex-1" id="right-selector"></ul>
                        </div>
                    </div>
                </div>
            </section>

            <section class="hidden" id="favorites-view">
                <div class="flex items-center justify-between mb-2">
                     <h2 class="text-xl font-bold">Favorite Songs</h2>
                    <div class="relative">
                        <select id="favorites-sort-dropdown" class="p-2 rounded-lg bg-white border-transparent shadow-sm text-sm appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 pr-8 dark:bg-gray-700 dark:border-gray-600">
                            <option value="name">Sort by Name</option>
                            <option value="artist">Sort by Artist</option>
                            <option value="lastPlayed">Sort by Last Played</option>
                            <option value="energy">Sort by Energy</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" /></svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden dark:bg-gray-800">
                    <ul class="divide-y divide-gray-200 dark:divide-gray-700" id="favorites-list"></ul>
                </div>
            </section>

            <section class="hidden" id="genre-view">
                 <div class="flex items-center justify-between mb-2">
                     <h2 class="text-xl font-bold" id="genre-view-title">Genre</h2>
                    <div class="relative">
                        <select id="genre-sort-dropdown" class="p-2 rounded-lg bg-white border-transparent shadow-sm text-sm appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 pr-8 dark:bg-gray-700 dark:border-gray-600">
                            <option value="name">Sort by Name</option>
                            <option value="artist">Sort by Artist</option>
                            <option value="lastPlayed">Sort by Last Played</option>
                            <option value="energy">Sort by Energy</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" /></svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden dark:bg-gray-800">
                    <ul class="divide-y divide-gray-200 dark:divide-gray-700" id="genre-song-list"></ul>
                </div>
            </section>

            <section class="hidden" id="plays-view">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xl font-bold">Plays</h2>
                    <button class="p-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition shadow" id="reset-plays">Reset All Plays</button>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden dark:bg-gray-800">
                    <ul class="divide-y divide-gray-200 dark:divide-gray-700" id="plays-list"></ul>
                </div>
            </section>

            <section class="hidden" id="recordings-view">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xl font-bold">Recordings</h2>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden dark:bg-gray-800">
                    <ul class="divide-y divide-gray-200 dark:divide-gray-700" id="recordings-list"></ul>
                </div>
            </section>

            <section class="hidden" id="energy-view">
                <h2 class="text-xl font-bold mb-2">Energy Levels</h2>
                <div id="energy-level-container" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </section>

            <section class="hidden" id="venue-setlists-view">
                <h2 class="text-xl font-bold mb-2" id="venue-setlists-title"></h2>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden dark:bg-gray-800">
                    <ul class="divide-y divide-gray-200 dark:divide-gray-700" id="venue-setlists-list"></ul>
                </div>
            </section>
        </main>

        <section class="hidden" id="doc-view">
            <div class="doc-top-bar" id="doc-top-bar"></div>
            <div class="doc-nav-buttons" id="doc-nav-buttons">
                <button class="doc-nav-button no-select" id="prev-doc">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Previous
                </button>
                <button class="doc-nav-button no-select" id="next-doc">
                    Next
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
                <button class="doc-nav-button doc-nav-close no-select" id="close-doc">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Close
                </button>
            </div>
            <div id="doc-iframe-container">
            </div>
        </section>

        <div id="song-details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
            <div id="song-details-modal-content" class="bg-white dark:bg-gray-800 shadow-xl p-6 w-full max-w-2xl overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modal-song-title" class="text-2xl font-bold">Song Details</h2>
                    <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-300 text-3xl leading-none">&times;</button>
                </div>
                <div>
                    <p><strong>Artist:</strong> <span id="modal-song-artist"></span></p>
                    <p><strong>Genre:</strong> <span id="modal-song-genre"></span></p>
                    <p><strong>Play Count:</strong> <span id="modal-song-plays"></span></p>
                    <p><strong>Last Played:</strong> <span id="modal-song-last-played"></span></p>
                    <h3 class="text-lg font-semibold mt-4 mb-2">Setlist History:</h3>
                    <ul id="modal-song-history" class="list-disc pl-5 space-y-1 text-sm">
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ================== Memory Management ==================
        let objectURLs = new Set();
        window.addEventListener('unload', () => {
            objectURLs.forEach(url => URL.revokeObjectURL(url));
            objectURLs.clear();
        });
        // ================== Data Structures ==================
        let masterSongs = [];
        let setlists = {};
        let currentSetlist = null;
        let playCounts = {};
        let genres = [{
            name: 'Rock',
            color: '#ef4444'
        }, {
            name: 'Pop',
            color: '#3b82f6'
        }, {
            name: 'Jazz',
            color: '#10b981'
        }];
        const energyIcons = [
            // Level 0 (Outline)
            `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 dark:text-gray-500"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>`,
            // Level 1 (Smallest, 1/3 Filled)
            `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><defs><linearGradient id="energy-grad-1" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="67%" style="stop-color:transparent" /><stop offset="67%" style="stop-color:#f59e0b" /></linearGradient></defs><path d="M12.5 5.5L6.5 14h5l-1 5 6-7h-5l1-4.5z" fill="url(#energy-grad-1)" stroke="#b45309" stroke-width="1.5"></path></svg>`,
            // Level 2 (Medium, 2/3 Filled)
            `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><defs><linearGradient id="energy-grad-2" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="33%" style="stop-color:transparent" /><stop offset="33%" style="stop-color:#f59e0b" /></linearGradient></defs><path d="M13 3L5 14h7l-1 7 8-9h-7l1-6z" fill="url(#energy-grad-2)" stroke="#b45309" stroke-width="1.5"></path></svg>`,
            // Level 3 (Largest, Fiery with Sparks)
            `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="-4 -4 32 32" class="energy-svg-3">
                <defs>
                    <radialGradient id="energy-grad-3" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                        <stop offset="0%" style="stop-color:#FBBF24;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#F59E0B;stop-opacity:1" />
                    </radialGradient>
                </defs>
                <g class="sparks">
                    <path d="M12,0 L12.5,4 L15,4.5 L12.5,5 L12,9 L11.5,5 L9,4.5 L11.5,4 Z" fill="#FCD34D" opacity="1"/>
                    <path d="M21,8 L21.5,12 L24,12.5 L21.5,13 L21,17 L20.5,13 L18,12.5 L20.5,12 Z" fill="#FCD34D" opacity="1"/>
                    <path d="M3,8 L3.5,12 L6,12.5 L3.5,13 L3,17 L2.5,13 L0,12.5 L2.5,12 Z" fill="#FCD34D" opacity="1"/>
                    <path d="M6,17 L6.5,21 L9,21.5 L6.5,22 L6,26 L5.5,22 L3,21.5 L5.5,21 Z" fill="#FCD34D" opacity="1"/>
                    <path d="M18,17 L18.5,21 L21,21.5 L18.5,22 L18,26 L17.5,22 L15,21.5 L17.5,21 Z" fill="#FCD34D" opacity="1"/>
                </g>
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="url(#energy-grad-3)" stroke="#B45309" stroke-width="1.5"/>
            </svg>`
        ];
        let venues = [];
        let recordings = [];
        let masterSelectedGenres = [];
        let currentGenre = null;
        let viewedSongsInSetlist = new Set();
        let currentViewerContext = null;
        let currentViewerList = [];
        let currentViewerIndex = -1;
        let scrollPosition = 0;
        let scrollTimeout = null;
        let inactivityTimer = null;


        let recorder = null;
        let audioChunks = [];
        let cameFromVenue = null;
        // ================== History Management ==================
        const MAX_HISTORY = 50;
        let history = [];
        let historyIndex = -1;
        let historyLock = false;

        function recordHistory() {
            if (historyLock) return;
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }

            if (history.length >= MAX_HISTORY) {
                history.shift();
            }

            history.push({
                masterSongs: JSON.parse(JSON.stringify(masterSongs)),
                setlists: JSON.parse(JSON.stringify(setlists)),
                playCounts: JSON.parse(JSON.stringify(playCounts)),
                genres: JSON.parse(JSON.stringify(genres)),
                venues: JSON.parse(JSON.stringify(venues)),
                recordings: JSON.parse(JSON.stringify(recordings))
            });
            historyIndex = history.length - 1;
            updateHistoryButtons();
        }

        function undo() {
            if (historyIndex <= 0) return;
            historyLock = true;
            historyIndex--;
            const state = history[historyIndex];

            masterSongs = JSON.parse(JSON.stringify(state.masterSongs));
            setlists = JSON.parse(JSON.stringify(state.setlists));
            playCounts = JSON.parse(JSON.stringify(state.playCounts));
            genres = JSON.parse(JSON.stringify(state.genres));
            venues = JSON.parse(JSON.stringify(state.venues));
            recordings = JSON.parse(JSON.stringify(state.recordings));

            objectURLs.forEach(url => URL.revokeObjectURL(url));
            objectURLs.clear();
            masterSongs.forEach(song => delete song.file);

            renderAll();
            save();
            historyLock = false;
            updateHistoryButtons();
        }

        function redo() {
            if (historyIndex >= history.length - 1) return;
            historyLock = true;
            historyIndex++;
            const state = history[historyIndex];

            masterSongs = JSON.parse(JSON.stringify(state.masterSongs));
            setlists = JSON.parse(JSON.stringify(state.setlists));
            playCounts = JSON.parse(JSON.stringify(state.playCounts));
            genres = JSON.parse(JSON.stringify(state.genres));
            venues = JSON.parse(JSON.stringify(state.venues));
            recordings = JSON.parse(JSON.stringify(state.recordings));

            objectURLs.forEach(url => URL.revokeObjectURL(url));
            objectURLs.clear();
            masterSongs.forEach(song => delete song.file);

            renderAll();
            save();
            historyLock = false;
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            $('#undo-btn').prop('disabled', historyIndex <= 0);
            $('#redo-btn').prop('disabled', historyIndex >= history.length - 1);
        }

        // ================== Persistent Storage ==================
        function save() {
            localStorage.setItem('setlistData', JSON.stringify({
                masterSongs: masterSongs.map(song => ({ ...song,
                    file: undefined,
                    fileInfo: song.fileInfo ? {
                        name: song.fileInfo.name,
                        type: song.fileInfo.type,
                        size: song.fileInfo.size,
                        data: song.fileInfo.data
                    } : undefined
                })),
                setlists,
                playCounts,
                genres,
                venues,
                recordings: recordings.map(rec => ({ ...rec,
                    audioData: rec.audioData
                }))
            }));
            localStorage.setItem('darkMode', $('html').hasClass('dark') ? 'enabled' : 'disabled');
        }

        function load() {
            const raw = localStorage.getItem('setlistData');
            if (raw) {
                try {
                    const obj = JSON.parse(raw);
                    masterSongs = obj.masterSongs || [];
                    masterSongs.forEach(s => {
                        if (!s.lastPlayed) s.lastPlayed = null;
                        s.favorite = s.favorite || false; 
                    });
                    setlists = obj.setlists || {};
                    Object.keys(setlists).forEach(k => {
                        if (Array.isArray(setlists[k])) { // Legacy check
                            setlists[k] = {
                                songs: setlists[k].map(s => s.id),
                                date: '',
                                venue: ''
                            };
                        }
                    });
                    playCounts = obj.playCounts || {};
                    genres = obj.genres || genres;
                    venues = obj.venues || [];
                    recordings = obj.recordings || [];
                } catch (e) {
                    console.error("Error parsing localStorage data: ", e);
                    masterSongs = [];
                    setlists = {};
                    playCounts = {};
                    venues = [];
                    recordings = [];
                }
            }
            const darkModePref = localStorage.getItem('darkMode');
            if (darkModePref === 'disabled') {
                $('html').removeClass('dark');
                $('#dark-mode-toggle').prop('checked', false);
            } else {
                $('html').addClass('dark');
                $('#dark-mode-toggle').prop('checked', true);
            }
        }

        // ================== File Handling ==================
        function storeFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve({
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    });
                };
                reader.onerror = function() {
                    reject(new Error('Failed to read file'));
                };
                reader.readAsDataURL(file);
            });
        }

        function getFileURL(song) {
            if (!song || !song.fileInfo || !song.fileInfo.data) {
                console.error(`Invalid song or fileInfo for song: ${song?.name || 'unknown'}`);
                return null;
            }

            if (!song.file || !objectURLs.has(song.file)) {
                try {
                    const blob = dataURItoBlob(song.fileInfo.data);
                    const url = URL.createObjectURL(blob);
                    if (song.file) {
                        URL.revokeObjectURL(song.file);
                        objectURLs.delete(song.file);
                    }
                    song.file = url;
                    objectURLs.add(url);
                } catch (e) {
                    console.error(`Error creating object URL for ${song.name}:`, e);
                    return null;
                }
            }
            return song.file;
        }

        function dataURItoBlob(dataURI) {
            try {
                const split = dataURI.split(',');
                if (split.length < 2) {
                    throw new Error('Invalid data URI');
                }
                const byteString = atob(split[1]);
                const mimeString = split[0].split(':')[1].split(';')[0];
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                return new Blob([ab], {
                    type: mimeString
                });
            } catch (e) {
                console.error('Error converting data URI to Blob:', e);
                throw e;
            }
        }

        // ================== UI Helpers ==================
        function autoCollapseSidebar() {
            const $sidebar = $('.left-col');
            if (!$sidebar.hasClass('collapsed')) {
                $sidebar.addClass('collapsed');
                $('#sidebar-toggle').find('svg').html('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />');
            }
        }

        // ================== Initialization ==================
        $(function() {
            function deselectAllNav() {
                $('#home-btn').removeClass('app-header-selected').addClass('app-header-unselected');
                $('#nav-favorites, #nav-plays, #nav-recordings, #nav-energy').removeClass('selected');
                $('#setlists-container .setlist-item').removeClass('selected');
                $('#venue-list .venue-item').removeClass('selected');
                $('#genre-list .genre-item').removeClass('selected');
            }

            load();
            renderLeftSetlists();
            renderGenres(deselectAllNav);
            renderVenues(deselectAllNav);
            bindNav(deselectAllNav);
            renderMaster();

            updateTopLeast();
            recordHistory();

            $(document).on('click', '.genre-dot', function(e) {
                e.stopPropagation();
                const li = $(this).closest('li');
                const songId = li.attr('id');
                const song = masterSongs.find(s => s.id === songId);
                if (!song) return;
                const genreNames = [''].concat(genres.map(g => g.name));
                let idx = genreNames.indexOf(song.genre || '');
                idx = (idx + 1) % genreNames.length;
                song.genre = genreNames[idx];
                
                const newDot = `<span class="genre-dot" style="background:${song.genre?getGenreColor(song.genre):'#cbd5e1'}" title="${song.genre||'no genre'}"></span>`;
                 $(`li[id="${songId}"]`).find('.genre-dot').replaceWith(newDot);

                save();
                recordHistory();
            });
            $(document).on('click', '.energy-icon', function(e) {
                e.stopPropagation(); // Prevent other click handlers on the list item
                const songId = $(this).closest('li').attr('id');
                const song = masterSongs.find(s => s.id === songId);
                if (song) {
                    song.energy = (song.energy || 0) + 1;
                    if (song.energy > 3) song.energy = 0;

                    const newIconHtml = energyIcons[song.energy || 0];
                    const $listItems = $(`li[id="${songId}"]`);
                    $listItems.find('.energy-icon').html(newIconHtml);

                    if (song.energy === 3) {
                        $listItems.find('.energy-svg-3').each(function() {
                            const $svg = $(this);
                            $svg.find('.sparks path').css('opacity', 0); // Reset for animation
                            $svg.addClass('spark-burst');
                            setTimeout(() => $svg.removeClass('spark-burst'), 600);
                        });
                    }

                    if ($('#energy-view').is(':visible')) {
                        renderEnergyLevels();
                    }

                    save();
                    recordHistory();
                }
            });
            $('#add-genre').click(function() {
                const name = $('#genre-name').val().trim();
                const color = $('#genre-color').val();
                if (!name) return alert('Enter a genre name');
                if (genres.some(g => g.name.toLowerCase() === name.toLowerCase())) return alert('Genre already exists');
                genres.push({
                    name,
                    color
                });
                $('#genre-name').val('');
                renderGenres(deselectAllNav);
                save();
                recordHistory();
            });
            $('#add-venue').click(function() {
                const name = $('#venue-name').val().trim();
                if (!name) return alert('Enter a venue name');
                if (venues.some(v => v.name.toLowerCase() === name.toLowerCase())) return alert('Venue already exists');
                venues.push({
                    name
                });
                $('#venue-name').val('');
                renderVenues(deselectAllNav);
                save();
                recordHistory();
            });
            $('#sidebar-toggle').click(function() {
                const $sidebar = $('.left-col');
                $sidebar.toggleClass('collapsed');
                const $icon = $(this).find('svg');
                if ($sidebar.hasClass('collapsed')) {
                    $icon.html('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />');
                } else {
                    $icon.html('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />');
                }
            });
        });

        // ================== Event Handlers ==================
        function bindNav(deselectAllNav) {

            $('#home-btn').click(() => {
                deselectAllNav();
                $('#home-btn').removeClass('app-header-unselected').addClass('app-header-selected');
                show('master');
                autoCollapseSidebar();
            });
            $('#nav-favorites').click(() => {
                deselectAllNav();
                $('#nav-favorites').addClass('selected');
                show('favorites');
            });
            $('#favorites-sort-dropdown').on('change', renderFavorites);
            $('#genre-sort-dropdown').on('change', () => renderGenreView(currentGenre));


            $('#nav-plays').click(() => {
                deselectAllNav();
                $('#nav-plays').addClass('selected');
                show('plays');
            });
            $('#nav-recordings').click(() => {
                deselectAllNav();
                $('#nav-recordings').addClass('selected');
                show('recordings');
            });
            $('#nav-energy').click(() => {
                deselectAllNav();
                $('#nav-energy').addClass('selected');
                show('energy');
            });
            $('#setlists-container').on('click', '.setlist-item', function(e) {
                if ($(e.target).closest('.del-setlist, .edit-input').length) return;
                const name = $(this).data('name');

                deselectAllNav();
                $(this).addClass('selected');
                autoCollapseSidebar();

                cameFromVenue = null;
                currentSetlist = name;
                viewedSongsInSetlist.clear();
                $('#setlist-title').text(name);
                show('setlist');
            });
            $('#venue-setlists-list').on('click', 'li', function() {
                const setlistName = $(this).data('setlist-name');
                if (setlists[setlistName]) {
                    cameFromVenue = $('#venue-setlists-title .text-blue-600').text();
                    currentSetlist = setlistName;
                    viewedSongsInSetlist.clear();
                    show('setlist');
                }
            });
            $('#back-to-venue-btn').click(function() {
                if (cameFromVenue) {
                    renderVenueSetlists(cameFromVenue);
                    show('venue-setlists');
                }
            });
            $('#setlist-recordings').on('click', '.delete-setlist-rec', function() {
                const recId = $(this).data('id');
                if (confirm('Are you sure you want to delete this recording?')) {
                    recordings = recordings.filter(rec => rec.id !== recId);
                    save();
                    recordHistory();
                    renderSetlist();
                }
            });
            $('#toggle-setlists').click(() => $('#setlists-container').slideToggle(150));
            
            $(document).on('click', '#setlist-details-toggle', function() {
                $(this).toggleClass('open');
                $('#setlist-details-content').slideToggle(200);
            });

            $('#add-setlist-btn').click(() => {
                const name = $('#new-setlist-name').val().trim();
                if (!name) return alert('Enter a name');
                if (setlists[name]) return alert('Name exists');
                setlists[name] = {
                    songs: [],
                    date: '',
                    venue: ''
                };
                $('#new-setlist-name').val('');
                renderLeftSetlists();
                save();
                recordHistory();
            });
            $('#upload-master-btn').click(() => $('#master-upload').click());
            $('#master-upload').on('change', handleMasterUpload);
            $('#undo-btn').click(undo);
            $('#redo-btn').click(redo);

            $('#search').on('input', () => {
                renderMaster();
                updateSearchDatalist();
            });
            
            $('#setlist-search').on('input', renderRightSelector);
            $('#sort-dropdown').on('change', renderMaster);

            $('#genre-filter-button').on('click', () => $('#genre-filter-dropdown').toggleClass('hidden'));
            $('#clear-filters-btn').on('click', () => {
                masterSelectedGenres = [];
                $('#search').val('');
                updateGenreFilters('#genre-filter-dropdown', masterSelectedGenres);
                updateGenreFilterButtonText('#genre-filter-button', masterSelectedGenres);
                renderMaster();
            });
            $(document).on('change', '#genre-filter-dropdown input[type="checkbox"]', function() {
                masterSelectedGenres = [];
                $('#genre-filter-dropdown input:checked').each(function() {
                    masterSelectedGenres.push($(this).val());
                });
                updateGenreFilterButtonText('#genre-filter-button', masterSelectedGenres);
                renderMaster();
            });
            
            $('#setlist-sort-filter-dropdown').on('change', function() {
                renderSetlist();
            });
           
            $(document).on('click', function(e) {
                if (!$(e.target).closest('#genre-filter-container').length) {
                    $('#genre-filter-dropdown').addClass('hidden');
                }
                if (!$(e.target).closest('#setlist-adder-genre-filter-container').length) {
                    $('#setlist-adder-genre-filter-dropdown').addClass('hidden');
                }
                if (!$(e.target).closest('.relative').has('#share-setlist-btn').length) {
                    $('#share-options').addClass('hidden');
                }
            });
            $('#reset-plays').click(() => {
                if (confirm('Reset all plays?')) {
                    playCounts = {};
                    masterSongs.forEach(s => s.lastPlayed = null);
                    renderPlays();
                    updateTopLeast();
                    save();
                    recordHistory();
                }
            });
            $('#doc-top-bar').click(function(e) {
                if ($(e.target).is('button')) return;
                $('#doc-nav-buttons').toggleClass('hidden');
                $(this).toggleClass('hidden-controls', !$('#doc-nav-buttons').hasClass('hidden'));
            });
            $('#prev-doc').click(function(e) {
                e.stopPropagation();
                if (currentViewerIndex > 0) {
                    const prevSongId = currentViewerList[currentViewerIndex - 1].id;
                    openSongInContext(prevSongId, currentViewerContext, currentViewerIndex - 1);
                }
            });
            $('#next-doc').click(function(e) {
                e.stopPropagation();
                if (currentViewerIndex < currentViewerList.length - 1) {
                    const nextSongId = currentViewerList[currentViewerIndex + 1].id;
                    openSongInContext(nextSongId, currentViewerContext, currentViewerIndex + 1);
                }
            });
            $('#close-doc').click(function(e) {
                e.stopPropagation();
                $('body').removeClass('doc-viewer-active');
                $('#doc-view').removeClass('doc-view-fullscreen').hide();
                $('#doc-nav-buttons').removeClass('hidden');
                $('#doc-top-bar').removeClass('hidden-controls');
                resetScrollHandlers();
                currentViewerContext = null;
                currentViewerList = [];
                currentViewerIndex = -1;
                $('#doc-iframe-container').empty();
                scrollPosition = 0;
            });
            $('#delete-all-btn').click(() => {
                if (confirm('Are you sure you want to delete ALL songs?')) {
                    masterSongs.forEach(song => {
                        if (song.file) {
                            URL.revokeObjectURL(song.file);
                            objectURLs.delete(song.file);
                        }
                    });
                    masterSongs = [];
                    setlists = {};
                    playCounts = {};
                    renderAll();
                    updateTopLeast();
                    save();
                    recordHistory();
                }
            });
            $('#record-show').click(() => {
                if (!currentSetlist) return alert('Select a setlist first');
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({
                            audio: true
                        })
                        .then(stream => {
                            recorder = new MediaRecorder(stream);
                            recorder.ondataavailable = e => audioChunks.push(e.data);
                            recorder.onstop = () => {
                                const blob = new Blob(audioChunks, {
                                    type: 'audio/webm'
                                });
                                audioChunks = [];
                                saveRecording(blob);
                            };
                            recorder.start();
                            $('#record-show').addClass('hidden');
                            $('#stop-record').removeClass('hidden');
                        })
                        .catch(err => {
                            console.error('Error accessing microphone:', err);
                            alert('Could not access microphone');
                        });
                } else {
                    alert('Microphone access not supported');
                }
            });
            $('#stop-record').click(() => {
                if (recorder) {
                    recorder.stop();
                    $('#stop-record').addClass('hidden');
                    $('#record-show').removeClass('hidden');
                }
            });
            $('#print-setlist').click(() => {
                if (!currentSetlist) return;
                const setlist = setlists[currentSetlist];
                const songObjects = setlist.songs.map(id => masterSongs.find(s => s.id === id)).filter(Boolean);
                const songsWithFiles = songObjects.filter(s => s.fileInfo && s.fileInfo.data);
                const printWin = window.open('', '_blank');
                if (!printWin) {
                    alert('Please allow popups for this feature to work.');
                    return;
                }
                let html = `<html><head><title>Setlist: ${escapeHtml(currentSetlist)}</title>`;
                html += `<style>
                    body { font-family: Arial, sans-serif; margin: 20mm; }
                    h1 { font-size: 24pt; border-bottom: 2px solid #333; padding-bottom: 10px; }
                    h2 { font-size: 18pt; }
                    ol { font-size: 14pt; padding-left: 30px; }
                    li { margin-bottom: 8px; }
                    .info { font-size: 14pt; color: #555; margin-bottom: 20px; }
                    .page-break { page-break-before: always; }
                    iframe { border: none; width: 100%; height: 95vh; }
                    @media print { body { margin: 15mm; } h1 { font-size: 20pt; } }
                </style></head><body>`;
                html += `<h1>${escapeHtml(currentSetlist)}</h1>`;
                html += `<div class="info"><strong>Date:</strong> ${escapeHtml(setlist.date) || 'Not set'} | <strong>Venue:</strong> ${escapeHtml(setlist.venue) || 'Not set'}</div><ol>`;
                songObjects.forEach(s => {
                    html += `<li>${escapeHtml(s.name)}</li>`;
                });
                html += '</ol>';
                printWin.document.write(html);

                if (songsWithFiles.length === 0) {
                    printWin.document.close();
                    printWin.focus();
                    printWin.print();
                    return;
                }

                songsWithFiles.forEach(s => {
                    const fileUrl = getFileURL(s);
                    if (fileUrl) {
                        const iframeHtml = `<div class="page-break"><h2>${escapeHtml(s.name)}</h2></div><iframe src="${fileUrl}"></iframe>`;
                        printWin.document.body.insertAdjacentHTML('beforeend', iframeHtml);
                    }
                });
                const iframes = printWin.document.querySelectorAll('iframe');
                const loadingPromises = Array.from(iframes).map(iframe => {
                    return new Promise(resolve => {
                        iframe.onload = resolve;
                        iframe.onerror = () => {
                            console.error("Failed to load iframe for printing:", iframe.src);
                            resolve(); 
                        };
                    });
                });
                Promise.all(loadingPromises).then(() => {
                    printWin.document.close();
                    printWin.focus();
                    printWin.print();
                });
            });


            $('#share-setlist-btn').click(() => {
                $('#share-options').toggleClass('hidden');
            });
            $('#share-native').click(async (e) => {
                e.preventDefault();
                shareSetlist('native');
            });
            $('#share-email').click((e) => {
                e.preventDefault();
                shareSetlist('email');
            });
            $('#share-gmail').click((e) => {
                e.preventDefault();
                shareSetlist('gmail');
            });
            $('#share-copy').click((e) => {
                e.preventDefault();
                shareSetlist('copy');
            });
            $('#dark-mode-toggle').change(function() {
                $('html').toggleClass('dark', this.checked);
                save();
            });
            $('#close-modal-btn').click(() => $('#song-details-modal').addClass('hidden').removeClass('flex'));

            $('#song-details-modal').click(function(e) {
                if (e.target === this) {
                    $(this).addClass('hidden').removeClass('flex');
                }
            });

            $('#right-selector-sort').on('change', renderRightSelector);

            $(document).on('dragenter dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if ($('#master-view').is(':visible')) {
                    $('#master-drop-overlay').removeClass('hidden');
                }
            }).on('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (e.relatedTarget === null || $(e.relatedTarget).closest('#master-drop-overlay').length === 0) {
                    $('#master-drop-overlay').addClass('hidden');
                }
            }).on('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $('#master-drop-overlay').addClass('hidden');
                if ($('#master-view').is(':visible')) {
                    const dropEvent = e.originalEvent;
                    if (dropEvent.dataTransfer && dropEvent.dataTransfer.files.length > 0) {
                        const syntheticEvent = {
                            target: {
                                files: dropEvent.dataTransfer.files
                            }
                        };
                        handleMasterUpload(syntheticEvent);
                    }
                }
            });
            
            $(document).on('click', '.favorite-star-container', function(e) {
                e.stopPropagation();
                const songId = $(this).closest('li').attr('id');
                const song = masterSongs.find(s => s.id === songId);
                if (song) {
                    song.favorite = !song.favorite;
                    save();
                    recordHistory();
                    
                    const $starContainer = $(`li[id="${songId}"]`).find('.favorite-star-container');
                    if (song.favorite) {
                        $starContainer.addClass('favorited');
                    } else {
                        $starContainer.removeClass('favorited');
                    }

                    if ($('#favorites-view').is(':visible')) {
                        renderFavorites();
                    }
                }
            });
        }

        async function shareSetlist(method) {
            if (!currentSetlist) return;
            const setlist = setlists[currentSetlist];
            const songObjects = setlist.songs.map(id => masterSongs.find(s => s.id === id)).filter(Boolean);
            const text = `${escapeHtml(currentSetlist)} - ${escapeHtml(setlist.date)} @ ${escapeHtml(setlist.venue)}\n` +
                songObjects.map((s, i) => `${i+1}. ${escapeHtml(s.name)}`).join('\n');
            const subject = `Setlist: ${currentSetlist}`;

            if (method === 'native' && navigator.share) {
                const files = [];
                for (let s of songObjects) {
                    if (s.fileInfo && s.fileInfo.data) {
                        try {
                            const blob = dataURItoBlob(s.fileInfo.data);
                            const file = new File([blob], s.name + '.pdf', {
                                type: 'application/pdf'
                            });
                            files.push(file);
                        } catch (e) {
                            console.error("Could not process file for sharing:", s.name, e);
                        }
                    }
                }
                try {
                    if (navigator.canShare && navigator.canShare({
                            files: files
                        })) {
                        await navigator.share({
                            title: currentSetlist,
                            text: text,
                            files: files
                        });
                    } else {
                        await navigator.share({
                            title: currentSetlist,
                            text: text
                        });
                    }
                } catch (err) {
                    console.error('Share failed:', err);
                    fallbackCopy(text);
                }
            } else if (method === 'email') {
                window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
            } else if (method === 'gmail') {
                const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
                window.open(gmailUrl, '_blank');
            } else {
                fallbackCopy(text);
            }
            $('#share-options').addClass('hidden');
        }

        function fallbackCopy(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    const feedback = $('#copy-feedback');
                    feedback.css('opacity', 1);
                    setTimeout(() => feedback.css('opacity', 0), 2000);
                });
            } else {
                alert('Clipboard not supported. Text: ' + text);
            }
        }

        async function handleMasterUpload(e) {
            const files = e.target.files;
            const addedSongs = [];

            for (let f of files) {
                const fileName = stripExt(f.name);
                if (masterSongs.some(s => s.name.toLowerCase() === fileName.toLowerCase())) {
                    if (!confirm(`A file named "${fileName}" already exists. Add anyway?`)) continue;
                }

                const id = 's_' + Math.random().toString(36).slice(2, 9);
                try {
                    const fileInfo = await storeFile(f);
                    const song = {
                        id,
                        name: fileName,
                        artist: '',
                        genre: '',
                        notes: '',
                        duration: '',
                        energy: 0,
                        favorite: false,
                        fileInfo,
                        lastPlayed: null,
                        originalIndex: masterSongs.length
                    };
                    masterSongs.push(song);
                    playCounts[song.id] = 0;
                    addedSongs.push(song);
                } catch (error) {
                    console.error('Error processing file:', f.name, error);
                    alert(`Failed to process file: ${f.name}`);
                }
            }

            if (addedSongs.length > 0) {
                renderMaster();
                show('master');
                updateTopLeast();
                save();
                recordHistory();
            }
            $('#master-upload').val('');
        }

        function stripExt(name) {
            return name.replace(/\.[^/.]+$/, '');
        }

        function createSongItem(song, idx, context) {
            const favClass = song.favorite ? 'favorited' : '';
            const star = `<div class="w-8 flex justify-center items-center favorite-star-container ${favClass}" title="Toggle Favorite">
                        <svg class="star-outline inline-block w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.539 1.118l-3.975-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.539-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
                        <svg class="star-filled inline-block w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                      </div>`;
            const dot = `<span class="genre-dot" style="background:${song.genre?getGenreColor(song.genre):'#cbd5e1'}" title="${song.genre||'no genre'}"></span>`;
            const energyLevel = song.energy || 0;
            const energyIcon = `<span class="energy-icon flex items-center justify-center w-6 h-6" title="Energy: ${energyLevel}">${energyIcons[energyLevel]}</span>`;
            const isMasterContext = ['master', 'favorites', 'genre'].includes(context);
            const detailsBtn = isMasterContext ?
                `<button class="p-1 px-2 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600 transition details-btn">Details</button>` : '';
            const isViewed = context === 'setlist' && viewedSongsInSetlist.has(song.id);
            const viewedClass = isViewed ? 'viewed-index' : '';
            return $(`<li id="${song.id}" class="flex items-center hover:bg-gray-50 dark:hover:bg-gray-700 draggable">
                ${star}
                <div class="w-8 flex justify-center items-center font-medium text-gray-500 index-number ${viewedClass}">${idx+1}</div>
                <div class="w-8 flex justify-center items-center">${dot}</div>
                <div class="w-8 flex justify-center items-center">${energyIcon}</div>
                <div class="flex items-center flex-wrap gap-2 w-full ml-2">
                    <div class="flex-1 min-w-[120px] cursor-pointer font-medium song-name">${escapeHtml(song.name)}</div>
                    <input class="w-28 p-1 text-sm rounded-md border dark:bg-gray-600 dark:border-gray-500 artist-input" placeholder="Artist" value="${escapeHtml(song.artist||'')}">
                    <input class="w-28 p-1 text-sm rounded-md border dark:bg-gray-600 dark:border-gray-500 notes-input" placeholder="Notes" value="${escapeHtml(song.notes||'')}">
                    <input class="w-20 p-1 text-sm rounded-md border dark:bg-gray-600 dark:border-gray-500 duration-input" placeholder="Runtime" value="${escapeHtml(song.duration||'')}">
                    ${detailsBtn}
                    <button class="p-1 px-2 text-xs bg-red-600 text-white rounded-md hover:bg-red-700 transition delete-btn">${isMasterContext ? 'Delete' : 'Remove'}</button>
                </div>
            </li>`);
        }

        function handleSelection(event, containerSelector) {
            const currentItem = $(event.currentTarget);
            if (event.shiftKey || event.ctrlKey || event.metaKey) {
                currentItem.toggleClass('item-selected');
            } else {
                const wasSelected = currentItem.hasClass('item-selected');
                const hadOthersSelected = $(`${containerSelector} .item-selected`).not(currentItem).length > 0;
                $(`${containerSelector} .item-selected`).removeClass('item-selected');
                if (!wasSelected || hadOthersSelected) {
                    currentItem.addClass('item-selected');
                }
            }
        }


        function renderMaster() {
            const q = $('#search').val().toLowerCase();
            let list = masterSongs.slice();

            if (masterSelectedGenres.length > 0) {
                list = list.filter(s => masterSelectedGenres.includes(s.genre));
            }
            if (q) {
                list = list.filter(s => s.name.toLowerCase().includes(q) || (s.artist || '').toLowerCase().includes(q));
            }

            const sortMode = $('#sort-dropdown').val();
            if (sortMode === 'artist') {
                list.sort((a, b) => (a.artist || '').localeCompare(b.artist || ''));
            } else if (sortMode === 'lastPlayed') {
                list.sort((a, b) => {
                    const dateA = a.lastPlayed ? new Date(a.lastPlayed).getTime() : 0;
                    const dateB = b.lastPlayed ? new Date(b.lastPlayed).getTime() : 0;
                    return dateB - dateA;
                });
            } else if (sortMode === 'energy') { 
                list.sort((a, b) => (b.energy || 0) - (a.energy || 0));
            } else {
                list.sort((a, b) => a.name.localeCompare(b.name));
            }

            window.currentMasterViewSongs = list;
            const $ul = $('#master-list').empty();

            if (list.length === 0) {
                const placeholder = $(`<li class="p-8 text-center text-gray-500 italic"></li>`);
                if (q || masterSelectedGenres.length > 0) {
                    placeholder.text('No songs match your current filters.');
                } else {
                    placeholder.html('No songs yet. <br> Drag & drop PDF files onto the page or use the "Add files" button!');
                }
                $ul.append(placeholder);
            } else {
                list.forEach((s, idx) => {
                    $ul.append(createSongItem(s, idx, 'master'));
                });
            }

            $('#master-list').on('click', '.details-btn', function(e) {
                e.stopPropagation();
                const songId = $(this).closest('li').attr('id');
                showSongDetailsModal(songId);
            });

            // Long press and click handlers for master list items
            let pressTimer;
            let isLongPress = false;

            $('#master-list').off('mousedown touchstart', 'li')
                .on('mousedown touchstart', 'li', function(e) {
                    const $target = $(e.target);
                    if ($target.is('input, button, a, .genre-dot, .details-btn, .energy-icon, .energy-icon *, .favorite-star-container, .favorite-star-container *')) {
                        return;
                    }
                    const songId = $(this).attr('id');
                    isLongPress = false;

                    pressTimer = window.setTimeout(() => {
                        isLongPress = true;
                        showSongDetailsModal(songId);
                    }, 500); 
                }).off('mouseup touchend mouseleave', 'li')
                .on('mouseup touchend mouseleave', 'li', function() {
                    clearTimeout(pressTimer);
                });

            $('#master-list, #favorites-list, #genre-song-list').off('click', 'li').on('click', 'li', function(e) {
                if (isLongPress) {
                    e.preventDefault();
                    return;
                }
                if ($(e.target).is('input, button, a, .genre-dot, .details-btn, .energy-icon, .energy-icon *, .favorite-star-container, .favorite-star-container *')) {
                    return;
                }
                if ($(e.target).closest('.song-name').length > 0 && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
                    const songId = $(this).attr('id');
                    openSongInContext(songId, 'master');
                    return;
                }
                handleSelection(e, `#${$(this).parent().attr('id')}`);
            });


            const handleInputChange = function(e) {
                const songId = $(this).closest('li').attr('id');
                const song = masterSongs.find(s => s.id === songId);
                if (song) {
                    if ($(this).hasClass('artist-input')) song.artist = e.target.value;
                    else if ($(this).hasClass('notes-input')) song.notes = e.target.value;
                    else if ($(this).hasClass('duration-input')) song.duration = e.target.value;
                    save();
                    recordHistory();
                }
            };
            $('main').off('change').on('change', '.artist-input, .notes-input, .duration-input', handleInputChange);


            $('#master-list, #favorites-list, #genre-song-list').on('click', '.delete-btn', function() {
                const li = $(this).closest('li');
                const songId = li.attr('id');
                if (confirm(`Are you sure you want to permanently delete "${masterSongs.find(s=>s.id === songId).name}"?`)) {
                    const song = masterSongs.find(s => s.id ===
                        songId);
                    if (!song) return;
                    if (song.file) {
                        URL.revokeObjectURL(song.file);
                        objectURLs.delete(song.file);
                    }
                    removeFromAllSetlists([songId]);
                    masterSongs = masterSongs.filter(x => x.id !== songId);
                    
                    const visibleView = $('main > section:visible').attr('id');
                    if (visibleView === 'favorites-view') renderFavorites();
                    else if (visibleView === 'genre-view') renderGenreView(currentGenre);
                    else renderMaster();
                    
                    if (currentSetlist) renderSetlist();
                    updateTopLeast();
                    save();
                    recordHistory();
                }
            });

            $('#master-list .draggable').draggable({
                helper: function() {
                    const selected = $('#master-list .item-selected');
                    if (selected.length === 0 || !$(this).hasClass('item-selected')) {
                        $('#master-list .item-selected').removeClass('item-selected');
                        $(this).addClass('item-selected');
                    }
                    const count = $('#master-list .item-selected').length;
                    return $(`<div class="ui-draggable-dragging text-white bg-blue-600 rounded-lg py-1 px-2 shadow-lg">Dragging ${count} song(s)</div>`);
                },
                appendTo: 'body',
                revert: 'invalid',
                cursorAt: {
                    left: 10,
                    top: 10
                }
            });
        }

        function removeFromAllSetlists(songIds) {
            Object.keys(setlists).forEach(k => {
                setlists[k].songs = setlists[k].songs.filter(id => !songIds.includes(id));
            });
        }

        function renderLeftSetlists() {
            const $c = $('#setlists-container').empty();
            Object.keys(setlists).forEach(name => {
                const el = $(`<div class="p-2 mb-1 rounded-lg cursor-pointer setlist-item bg-gray-700">
                    <div class="flex items-center">
                        <button class="del-setlist" title="Delete setlist">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <span class="setlist-name">${escapeHtml(name)}</span>
                    </div>
                </div>`);
                el.find('.del-setlist').click((e) => {
                    e.stopPropagation();
                    if (confirm('Delete ' + name + '?')) {
                        delete setlists[name];
                        recordings = recordings.filter(r => r.setlist !== name);
                        if (currentSetlist === name) {
                            currentSetlist = null;
                            $('#home-btn').trigger('click');
                        }
                        renderLeftSetlists();
                        save();
                        recordHistory();
                    }
                });
                el.on('dblclick', function() {
                    const input = $('<input class="edit-input w-full bg-gray-600 p-1 rounded-md" value="' + escapeHtml(name) + '">');
                    $(this).find('.setlist-name').replaceWith(input);
                    input.focus();
                    input.on('blur keypress', function(ev) {
                        if (ev.type === 'keypress' && ev.key !== 'Enter') return;
                        const newName = input.val().trim();
                        if (newName && newName !== name && !setlists[newName]) {
                            setlists[newName] = setlists[name];
                            recordings.forEach(r => {
                                if (r.setlist === name) r.setlist = newName;
                            });
                            delete setlists[name];
                            if (currentSetlist === name) {
                                currentSetlist = newName;
                                $('#setlist-title').text(newName);
                            }
                        }
                        renderLeftSetlists();
                        save();
                        recordHistory();
                    });
                });
                $c.append(el);
            });

            $('.setlist-item').droppable({
                accept: '#master-list .draggable, #favorites-list .draggable, #genre-song-list .draggable, #plays-list .draggable',
                hoverClass: 'drag-highlight',
                drop: function(e, ui) {
                    const setlistName = $(this).data('name');
                    const setlist = setlists[setlistName];
                    let added = false;
                    let songIdsToAdd = [];


                    let sourceContainerId = ui.draggable.closest('ul').attr('id');
                    let sourceSelector = `#${sourceContainerId}`;

                    if (ui.draggable.hasClass('item-selected')) {
                        $(`${sourceSelector} .item-selected`).each(function() {
                            songIdsToAdd.push($(this).attr('id'));
                        });
                    } else { 
                        songIdsToAdd.push(ui.draggable.attr('id'));
                    }

                    songIdsToAdd.forEach(songId => {
                        if (songId && !setlist.songs.includes(songId)) {
                            setlist.songs.push(songId);
                            added = true;
                        }
                    });
                    if (added) {
                        $(this).addClass('drop-flash');
                        setTimeout(() => $(this).removeClass('drop-flash'), 1000);
                        save();
                        recordHistory();
                        if (currentSetlist === setlistName) {
                            renderSetlist();
                        }
                    }
                    if (sourceSelector) {
                        $(`${sourceSelector} .item-selected`).removeClass('item-selected');
                    }
                }
            });
            $('#setlists-container').sortable({
                axis: 'y',
                cursor: 'move',
                update: function() {
                    const order = $('#setlists-container .setlist-item').map((i, el) => $(el).data('name')).get();
                    const newObj = {};
                    order.forEach(n => {
                        if (setlists[n]) newObj[n] = setlists[n];
                    });
                    setlists = newObj;
                    save();
                    recordHistory();
                }
            });
        }

        function renderSetlist() {
            if (!currentSetlist) {
                $('#setlist-view').hide();
                return;
            }

            if (cameFromVenue) {
                $('#back-to-venue-btn').show();
            } else {
                $('#back-to-venue-btn').hide();
            }

            const setlist = setlists[currentSetlist];
            $('#setlist-title').text(currentSetlist);
            $('#setlist-date').val(setlist.date || '').off('change').on('change', function() {
                setlist.date = $(this).val();
                save();
                recordHistory();
            });
            $('#setlist-venue').val(setlist.venue || '').off('change').on('change', function() {
                const newVenue = $(this).val().trim();
                setlist.venue = newVenue;
                if (newVenue && !venues.some(v => v.name.toLowerCase() === newVenue.toLowerCase())) {
                    venues.push({
                        name: newVenue
                    });
                    renderVenues();
                }
                save();
                recordHistory();
            });
            $('#setlist-recordings').empty();
            const setlistRecs = recordings.filter(r => r.setlist === currentSetlist);
            if (setlistRecs.length > 0) {
                const $recsContainer = $('<div class="p-2 bg-gray-100 rounded-lg dark:bg-gray-700"></div>');
                $recsContainer.append('<h4 class="font-semibold text-sm mb-2">Recordings for this Setlist:</h4>');
                setlistRecs.forEach(r => {
                    const $recEl = $(`
                        <div class="flex items-center justify-between p-2 mb-1 bg-white rounded-lg shadow-sm dark:bg-gray-600">
                            <span class="flex-1">${escapeHtml(r.date)} @ ${escapeHtml(r.venue)}</span>
                            <audio controls src="${r.audioData}" style="height: 30px;"></audio>
                            <button class="ml-2 p-1 px-2 text-xs bg-red-600 text-white rounded-md hover:bg-red-700 transition delete-setlist-rec" data-id="${r.id}">Delete</button>
                        </div>`);
                    $recsContainer.append($recEl);
                });
                $('#setlist-recordings').append($recsContainer);
            }

            let songObjects = (setlist.songs || []).map(id => masterSongs.find(s => s.id === id)).filter(Boolean);
            const sortFilterMode = $('#setlist-sort-filter-dropdown').val();

            if (sortFilterMode !== 'custom') {
                if (sortFilterMode === 'artist') {
                    songObjects.sort((a, b) => (a.artist || '').localeCompare(b.artist || ''));
                } else if (sortFilterMode === 'name') {
                    songObjects.sort((a, b) => a.name.localeCompare(b.name));
                } else if (sortFilterMode === 'energy') {
                    songObjects.sort((a, b) => (b.energy || 0) - (a.energy || 0));
                } else if (sortFilterMode === 'genre') {
                    songObjects.sort((a, b) => (a.genre || '').localeCompare(b.genre || ''));
                }
            }

            let totalRuntime = 0;
            songObjects.forEach(s => {
                if (s && s.duration) {
                    totalRuntime += parseInt(s.duration, 10) || 0;
                }
            });
            $('#setlist-total-duration').text(`Runtime: ${totalRuntime} min`);
            $('#setlist-song-count').text(`${songObjects.length} songs`);


            window.currentSetlistViewSongs = songObjects;
            const $ul = $('#setlist-list').empty();
            songObjects.forEach((s, idx) => {
                $ul.append(createSongItem(s, idx, 'setlist'));
            });
            $('#setlist-list').on('click', '.song-name', function() {
                const songId = $(this).closest('li').attr('id');
                openSongInContext(songId, 'setlist');
            });
            $('#setlist-list').on('click', '.delete-btn', function() {
                const songId = $(this).closest('li').attr('id');
                setlist.songs = setlist.songs.filter(id => id !== songId);
                renderSetlist();
                save();
                recordHistory();
            });
            if ($('#setlist-list').hasClass('ui-sortable')) {
                $('#setlist-list').sortable('destroy');
            }
            $('#setlist-list').sortable({
                axis: 'y',
                cursor: 'move',
                placeholder: "sortable-placeholder",
                tolerance: 'pointer', // Better for detecting movement
                scroll: true,
                forcePlaceholderSize: true,
                helper: 'clone',
                start: function(e, ui) {
                    ui.placeholder.height(ui.item.height());
                    ui.item.addClass('dragging-source');
                },
                stop: function(e, ui) {
                    ui.item.removeClass('dragging-source');
                },
                update: function(event, ui) {
                    $('#setlist-sort-filter-dropdown').val('custom');
                    
                    const ids = $(this).sortable('toArray');
                    setlists[currentSetlist].songs = ids;
                    
                    $('#setlist-list .index-number').each(function(index) {
                        $(this).text(index + 1);
                    });
                    
                    save();
                    recordHistory();
                }
            }).disableSelection();
            renderRightSelector();
        }

        function renderRightSelector() {
            if (!currentSetlist) return;
            const setlist = setlists[currentSetlist];
            const $ul = $('#right-selector').empty();
            const usedIds = new Set(setlist.songs || []);

            let songsToDisplay = [...masterSongs];

            const searchTerm = $('#setlist-search').val().toLowerCase();

            if (searchTerm) {
                songsToDisplay = songsToDisplay.filter(s => {
                    return s.name.toLowerCase().includes(searchTerm) || (s.artist || '').toLowerCase().includes(searchTerm);
                });
            }

            const sortMode = $('#right-selector-sort').val();
            if (sortMode === 'name') {
                songsToDisplay.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortMode === 'artist') {
                songsToDisplay.sort((a, b) => (a.artist || '').localeCompare(b.artist || ''));
            } else if (sortMode === 'genre') {
                songsToDisplay.sort((a, b) => (a.genre || '').localeCompare(b.genre || ''));
            } else if (sortMode === 'energy') {
                songsToDisplay.sort((a, b) => (b.energy || 0) - (a.energy || 0));
            }

            songsToDisplay.forEach(s => {
                const li = $(`<li class="song-selector-item"><input type="checkbox" ${usedIds.has(s.id)?'checked':''} class="mr-2"><span>${escapeHtml(s.name)}</span></li>`);
                li.find('input').on('change', function() {
                    if (this.checked) {
                        if (!setlist.songs.includes(s.id)) setlist.songs.push(s.id);
                    } else {
                        setlist.songs = setlist.songs.filter(id => id !== s.id);
                    }
                    renderSetlist();
                    save();
                    recordHistory();
                });
                $ul.append(li);
            });
        }

        function renderPlays() {
            const $ul = $('#plays-list').empty();

            if (masterSongs.length === 0) {
                $ul.append('<li class="p-8 text-center text-gray-500 italic">Your master list is empty. Add some songs to start tracking plays.</li>');
                return;
            }

            const sortedSongs = masterSongs.slice().sort((a, b) => (playCounts[b.id] || 0) - (playCounts[a.id] || 0));
            window.currentPlaysViewSongs = sortedSongs;

            if (Object.keys(playCounts).length === 0) {
                $ul.append('<li class="p-8 text-center text-gray-500 italic">No songs have been played yet. View a song\'s file to log a play.</li>');
                return;
            }

            sortedSongs.forEach(s => {
                const li = $(`<li id="${s.id}" class="flex items-center hover:bg-gray-50 dark:hover:bg-gray-700 draggable pl-4"><div class="flex-1 cursor-pointer font-medium">${escapeHtml(s.name)}</div><div class="w-24 text-right font-medium">${playCounts[s.id]||0}</div><button class="ml-2 p-1 px-2 text-xs bg-red-600 text-white rounded-md hover:bg-red-700 transition">Reset</button></li>`);
                li.find('.flex-1').on('dblclick', () => openSongInContext(s.id, 'plays'));
                li.find('button').click(() => {
                    playCounts[s.id] =
                        0;
                    renderPlays();
                    updateTopLeast();
                    save();
                    recordHistory();
                });
                $ul.append(li);
            });

            $('#plays-list li.draggable').on('click', function(e) {
                if ($(e.target).is('button') || $(e.target).closest('button').length > 0) {
                    return;
                }
                handleSelection(e, '#plays-list');
            }).draggable({
                helper: function() {
                    const selected = $('#plays-list .item-selected');
                    if (selected.length === 0 || !$(this).hasClass('item-selected')) {
                        $('#plays-list .item-selected').removeClass('item-selected');
                        $(this).addClass('item-selected');
                    }
                    const count = $('#plays-list .item-selected').length;
                    return $(`<div class="ui-draggable-dragging text-white bg-blue-600 rounded-lg py-1 px-2 shadow-lg">Dragging ${count} song(s)</div>`);
                },
                appendTo: 'body',
                revert: 'invalid',
                cursorAt: {
                    left: 10,
                    top: 10
                }
            });
        }

        function renderRecordings() {
            const $ul = $('#recordings-list').empty();

            if (recordings.length === 0) {
                $ul.append('<li class="p-8 text-center text-gray-500 italic">No recordings have been saved. <br> Use the "Record Show" button in a setlist to create one.</li>');
                return;
            }

            recordings.forEach(r => {
                const li = $(`<li class="flex items-center p-3 hover:bg-gray-50 dark:hover:bg-gray-700"><div class="flex-1">${escapeHtml(r.setlist)} - ${escapeHtml(r.date)} @ ${escapeHtml(r.venue)}</div><audio controls src="${r.audioData}"></audio><button class="ml-2 p-1 px-2 text-xs bg-red-600 text-white rounded-md hover:bg-red-700 transition delete-rec" data-id="${r.id}">Delete</button></li>`);
                li.find('.delete-rec').click(() => {
                    recordings = recordings.filter(rec => rec.id !== r.id);
                    renderRecordings();
                    save();
                    recordHistory();
                });
                $ul.append(li);
            });
        }

        function renderFavorites() {
            const $ul = $('#favorites-list').empty();
            let favorites = masterSongs.filter(s => s.favorite);

            const sortMode = $('#favorites-sort-dropdown').val();
            if (sortMode === 'artist') {
                favorites.sort((a, b) => (a.artist || '').localeCompare(b.artist || ''));
            } else if (sortMode === 'lastPlayed') {
                favorites.sort((a, b) => {
                    const dateA = a.lastPlayed ? new Date(a.lastPlayed).getTime() : 0;
                    const dateB = b.lastPlayed ? new Date(b.lastPlayed).getTime() : 0;
                    return dateB - dateA;
                });
            } else if (sortMode === 'energy') { 
                favorites.sort((a, b) => (b.energy || 0) - (a.energy || 0));
            } else { // Default to name
                favorites.sort((a, b) => a.name.localeCompare(b.name));
            }

            favorites.forEach((s, idx) => {
                $ul.append(createSongItem(s, idx, 'favorites'));
            });

            $('#favorites-list .draggable').draggable({
                helper: function() {
                    const selected = $('#favorites-list .item-selected');
                    if (selected.length === 0 || !$(this).hasClass('item-selected')) {
                        $('#favorites-list .item-selected').removeClass('item-selected');
                        $(this).addClass('item-selected');
                    }
                    const count = $('#favorites-list .item-selected').length;
                    return $(`<div class="ui-draggable-dragging text-white bg-blue-600 rounded-lg py-1 px-2 shadow-lg">Dragging ${count} song(s)</div>`);
                },
                appendTo: 'body',
                revert: 'invalid',
                cursorAt: {
                    left: 10,
                    top: 10
                }
            });
        }

        function renderGenreView(genreName) {
            currentGenre = genreName;
            $('#genre-view-title').text(`Genre: ${genreName}`);
            const $ul = $('#genre-song-list').empty();
            
            let songsInGenre = masterSongs.filter(s => s.genre === genreName);

            const sortMode = $('#genre-sort-dropdown').val();
            if (sortMode === 'artist') {
                songsInGenre.sort((a, b) => (a.artist || '').localeCompare(b.artist || ''));
            } else if (sortMode === 'lastPlayed') {
                songsInGenre.sort((a, b) => {
                    const dateA = a.lastPlayed ? new Date(a.lastPlayed).getTime() : 0;
                    const dateB = b.lastPlayed ? new Date(b.lastPlayed).getTime() : 0;
                    return dateB - dateA;
                });
            } else if (sortMode === 'energy') { 
                songsInGenre.sort((a, b) => (b.energy || 0) - (a.energy || 0));
            } else { // Default to name
                songsInGenre.sort((a, b) => a.name.localeCompare(b.name));
            }

            songsInGenre.forEach((s, idx) => {
                $ul.append(createSongItem(s, idx, 'genre'));
            });
            
             $('#genre-song-list .draggable').draggable({
                helper: function() {
                    const selected = $('#genre-song-list .item-selected');
                    if (selected.length === 0 || !$(this).hasClass('item-selected')) {
                        $('#genre-song-list .item-selected').removeClass('item-selected');
                        $(this).addClass('item-selected');
                    }
                    const count = $('#genre-song-list .item-selected').length;
                    return $(`<div class="ui-draggable-dragging text-white bg-blue-600 rounded-lg py-1 px-2 shadow-lg">Dragging ${count} song(s)</div>`);
                },
                appendTo: 'body',
                revert: 'invalid',
                cursorAt: {
                    left: 10,
                    top: 10
                }
            });
        }


        function renderEnergyLevels() {
            const container = $('#energy-level-container').empty();
            const levels = [{
                energyValue: 1,
                songs: masterSongs.filter(s => s.energy === 1)
            }, {
                energyValue: 2,
                songs: masterSongs.filter(s => s.energy === 2)
            }, {
                energyValue: 3,
                songs: masterSongs.filter(s => s.energy === 3)
            }];
            levels.forEach(level => {
                const section = $(`<div class="p-2 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
                <div class="flex justify-center mb-2">${energyIcons[level.energyValue]}</div>
                <ul class="divide-y divide-gray-200 dark:divide-gray-700 max-h-96 overflow-y-auto"></ul>
            </div>`);

                const ul = section.find('ul');
                if (level.songs.length > 0) {
                    level.songs.sort((a, b) => a.name.localeCompare(b.name)).forEach(song => {
                        ul.append(`<li id="${song.id}" class="p-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer draggable">${escapeHtml(song.name)}</li>`);
                    });
                } else {
                    ul.append(`<li class="p-2 text-sm text-gray-500 italic">No songs in this category.</li>`);
                }
                container.append(section);
            });
            $('#energy-level-container li.draggable').on('click', function(e) {
                handleSelection(e, '#energy-level-container');
            }).draggable({
                helper: function() {
                    const selected = $('#energy-level-container .item-selected');
                    if (selected.length === 0 || !$(this).hasClass('item-selected')) {
                        $('#energy-level-container li').removeClass('item-selected');
                        $(this).addClass('item-selected');
                    }
                    const count = $('#energy-level-container .item-selected').length;
                    return $(`<div class="ui-draggable-dragging text-white bg-blue-600 rounded-lg py-1 px-2 shadow-lg">Dragging ${count} song(s)</div>`);
                },
                appendTo: 'body',
                revert: 'invalid',
                cursorAt: {
                    left: 10,
                    top: 10
                }
            });
        }

        function renderGenres(deselectAllNav) {
            $('#genre-list').empty();
            genres.forEach(g => {
                const el = $(`<div class="sidebar-item genre-item"><div class="genre-content"><div class="genre-dot" style="background:${g.color}"></div><div class="genre-name text-sm">${escapeHtml(g.name)}</div></div><span class="delete-genre" title="Delete genre">✕</span></div>`);
                el.find('.delete-genre').click((e) => {
                    e.stopPropagation();
                    genres = genres.filter(genre => genre.name !== g.name);
                    masterSongs.forEach(song => {
                        if (song.genre ===
                            g.name) song.genre = '';
                    });
                    renderGenres(deselectAllNav);
                    if ($('#master-view').is(':visible')) renderMaster();
                    if ($('#favorites-view').is(':visible')) renderFavorites();
                    if (currentGenre) renderGenreView(currentGenre);
                    if (currentSetlist) renderSetlist();
                    save();
                    recordHistory();
                });
                el.find('.genre-content').click(() => {
                    deselectAllNav();
                    el.addClass('selected');
                    renderGenreView(g.name);
                    show('genre-view');
                });
                el.find('.genre-name').on('dblclick', function(e) {
                    e.stopPropagation();
                    const oldName = $(this).text();
                    const input = $('<input class="genre-edit-input" type="text" value="' + oldName + '">');
                    $(this).replaceWith(input);
                    input.focus()[0].select();
                    input.on('blur keypress', function(ev) {
                        if (ev.type === 'keypress' && ev.key !== 'Enter') return;
                        const newName =
                            input.val().trim();
                        if (!newName || newName === oldName) {
                            renderGenres(deselectAllNav);
                            return;
                        }
                        const genre = genres.find(genre => genre.name === oldName);
                        if (genre) genre.name = newName;
                        masterSongs.forEach(song => {
                            if (song.genre === oldName) song.genre = newName;
                        });
                        renderGenres(deselectAllNav);
                        renderMaster();
                        if (currentSetlist) renderSetlist();
                        save();
                        recordHistory();
                    });
                });
                $('#genre-list').append(el);
            });
            updateGenreFilters('#genre-filter-dropdown', masterSelectedGenres);
            $('#genre-list').sortable({
                axis: 'y',
                cursor: 'move',
                placeholder: "sortable-placeholder",
                update: function() {
                    const newOrder = [];
                    $('#genre-list .genre-item').each(function() {
                        const name = $(this).find('.genre-name').text();
                        const genre = genres.find(g => g.name === name);
                        if (genre) newOrder.push(genre);
                    });
                    genres = newOrder;
                    save();
                    recordHistory();
                }
            });
        }

        function renderVenues(deselectAllNav) {
            $('#venue-list').empty();
            venues.forEach(v => {
                const el = $(`<div class="sidebar-item venue-item"><div class="venue-name text-sm">${escapeHtml(v.name)}</div><span class="delete-venue" title="Delete venue">✕</span></div>`);
                el.on('click', function(e) {
                    if ($(e.target).closest('.delete-venue, .genre-edit-input').length) return;
                    if (deselectAllNav) deselectAllNav();
                    $(this).addClass('selected');
                    renderVenueSetlists(v.name);
                    show('venue-setlists');
                });

                el.find('.delete-venue').click((e) => {
                    e.stopPropagation();
                    venues = venues.filter(venue => venue.name !== v.name);
                    Object.values(setlists).forEach(sl => {
                        if (sl.venue === v.name) sl.venue = '';
                    });
                    recordings.forEach(r => {
                        if (r.venue === v.name) r.venue = '';
                    });
                    renderVenues(deselectAllNav);
                    if (currentSetlist) renderSetlist();
                    save();
                    recordHistory();
                    if ($('#venue-setlists-view').is(':visible')) $('#home-btn').trigger('click');
                });
                el.find('.venue-name').on('dblclick', function(e) {
                    e.stopPropagation();
                    const oldName = $(this).text();
                    const input = $('<input class="genre-edit-input" type="text" value="' + oldName + '">');
                    $(this).replaceWith(input);
                    input.focus()[0].select();
                    input.on('blur keypress', function(ev) {
                        if (ev.type === 'keypress' && ev.key !== 'Enter') return;
                        const newName = input.val().trim();
                        if (!newName || newName === oldName) {
                            renderVenues(deselectAllNav);
                            return;
                        }
                        const venue = venues.find(venue => venue.name === oldName);
                        if (venue) venue.name = newName;
                        Object.values(setlists).forEach(sl => {
                            if (sl.venue === oldName) sl.venue = newName;
                        });
                        recordings.forEach(r => {
                            if (r.venue === oldName) r.venue = newName;
                        });
                        renderVenues(deselectAllNav);
                        if (currentSetlist) renderSetlist();
                        save();
                        recordHistory();
                    });
                });
                $('#venue-list').append(el);
            });
            $('#venue-list').sortable({
                axis: 'y',
                cursor: 'move',
                placeholder: "sortable-placeholder",
                update: function() {
                    const newOrder = [];
                    $('#venue-list .venue-item').each(function() {
                        const name = $(this).find('.venue-name').text();
                        const venue = venues.find(v => v.name === name);
                        if (venue) newOrder.push(venue);
                    });
                    venues = newOrder;
                    save();
                    recordHistory();
                }
            });
        }

        function renderVenueSetlists(venueName) {
            $('#venue-setlists-title').html(`Setlists for: <span class="text-blue-600">${escapeHtml(venueName)}</span>`);
            const $ul = $('#venue-setlists-list').empty();
            const matchingSetlists = Object.entries(setlists).filter(([name, data]) => data.venue === venueName);
            if (matchingSetlists.length === 0) {
                $ul.append('<li class="p-4 text-center text-gray-500">No setlists found for this venue.</li>');
                return;
            }

            matchingSetlists.forEach(([name, data]) => {
                const li = $(`<li class="p-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" data-setlist-name="${escapeHtml(name)}">
                    <div class="font-medium">${escapeHtml(name)}</div>
                    <div class="text-sm text-gray-500">${escapeHtml(data.date) || 'No date'}</div>
                </li>`);
                $ul.append(li);
            });
        }

        function updateGenreFilters(dropdownSelector, selectedArray) {
            const $dropdown = $(dropdownSelector).empty();
            if (genres.length === 0) {
                $dropdown.append('<div class="p-2 text-sm text-gray-500">No genres created.</div>');
                return;
            }
            genres.forEach(g => {
                const isChecked = selectedArray.includes(g.name);
                $dropdown.append(`<label class="flex items-center p-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer"><input type="checkbox" value="${escapeHtml(g.name)}" class="form-checkbox h-4 w-4 text-blue-600 rounded-md mr-2" ${isChecked ? 'checked' : ''}>${escapeHtml(g.name)}</label>`);
            });
        }

        function updateGenreFilterButtonText(buttonSelector, selectedArray, defaultText = 'Select Genres') {
            const button = $(buttonSelector);
            if (selectedArray.length === 0) {
                button.text(defaultText);
            } else if (selectedArray.length === 1) {
                button.text(escapeHtml(selectedArray[0]));
            } else {
                button.text(`${selectedArray.length} genres`);
            }
        }

        function getGenreColor(name) {
            const g = genres.find(x => x.name === name);
            return g ? g.color : '#cbd5e1';
        }

        function escapeHtml(s) {
            return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function updateTopLeast() {
            const pairs = Object.entries(playCounts).filter(([id]) => masterSongs.find(s => s.id === id)).sort((a, b) => b[1] - a[1]);
            $('#top-played').empty();
            $('#least-played').empty();
            pairs.slice(0, 3).forEach(([id, c]) => {
                const s = masterSongs.find(x => x.id === id);
                if (s) $('#top-played').append(`<li>${escapeHtml(s.name)}: ${c}</li>`);
            });
            pairs.slice(-3).reverse().forEach(([id, c]) => {
                const s = masterSongs.find(x => x.id === id);
                if (s) $('#least-played').append(`<li>${escapeHtml(s.name)}: ${c}</li>`);
            });
        }

        function updateSearchDatalist() {
            $('#search-results').empty();
            masterSongs.forEach(s => {
                $('#search-results').append(`<option value="${escapeHtml(s.name)}">`);
            });
        }

        function renderAll() {
            renderLeftSetlists();
            renderGenres();
            renderVenues();
            renderMaster();
            if (currentSetlist) renderSetlist();
            renderPlays();
            renderRecordings();
            renderFavorites();
            renderEnergyLevels();
            if (currentGenre) renderGenreView(currentGenre);
            updateTopLeast();
        }

        function openSongInContext(songId, context, index = -1) {
            const song = masterSongs.find(s => s.id === songId);
            if (!song) {
                alert('File not found');
                return;
            }
            playCounts[song.id] = (playCounts[song.id] || 0) + 1;
            song.lastPlayed = new Date().toISOString().split('T')[0];
            updateTopLeast();
            save();
            // Do not re-render the whole list, to avoid jarring UI shifts. The data is saved.

            // Determine the current list for next/prev navigation
            const visibleView = $('main > section:visible').attr('id');
            if (visibleView === 'master-view') {
                 currentViewerList = window.currentMasterViewSongs;
            } else if (visibleView === 'setlist-view') {
                currentViewerList = window.currentSetlistViewSongs;
            } else if (visibleView === 'plays-view') {
                 currentViewerList = window.currentPlaysViewSongs;
            } else if (visibleView === 'favorites-view') {
                currentViewerList = masterSongs.filter(s => s.favorite); // Re-filter to be safe
            } else if (visibleView === 'genre-view' && currentGenre) {
                currentViewerList = masterSongs.filter(s => s.genre === currentGenre);
            } else {
                currentViewerList = masterSongs;
            }

            currentViewerContext = context;
            if (index === -1) {
                index = currentViewerList.findIndex(s => s.id === songId);
            }
            currentViewerIndex = index;
            if (currentViewerContext === 'setlist') {
                viewedSongsInSetlist.add(songId);
                renderSetlist();
            }

            const url = getFileURL(song);
            if (!url) {
                alert('File not available');
                return;
            }
            
            try {
                $('body').addClass('doc-viewer-active');
                const $container = $('#doc-iframe-container');
                const objectTag = `<object id="doc-object" data="${url}" type="application/pdf" width="100%" height="100%"><p>Your browser does not support PDFs. Please download the PDF to view it: <a href="${url}" target="_blank">Download PDF</a>.</p></object>`;
                $container.empty().append(objectTag);

                $('#doc-view').addClass('doc-view-fullscreen').show();
                $('#doc-nav-buttons').removeClass('hidden');
                $('#doc-top-bar').removeClass('hidden-controls');
                $('#prev-doc').prop('disabled', index <= 0);
                $('#next-doc').prop('disabled', index >= currentViewerList.length - 1);
                let touchstartX = 0;
                $('#doc-view').off('touchstart touchend').on('touchstart', e => {
                    touchstartX = e.originalEvent.changedTouches[0].screenX;
                }).on('touchend', e => {
                    const touchendX = e.originalEvent.changedTouches[0].screenX;
                    if (touchendX < touchstartX - 50) $('#next-doc').trigger('click');
                    if (touchendX > touchstartX + 50) $('#prev-doc').trigger('click');
                });
                setupScrollHandlers();
            } catch (e) {
                console.error(`Error opening file for song ${song.name}:`, e);
                alert('Error opening file');
            }
        }

        function saveRecording(blob) {
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                const audioData = reader.result;
                const id = 'r_' + Math.random().toString(36).slice(2, 9);
                const setlist = setlists[currentSetlist];
                recordings.push({
                    id,
                    setlist: currentSetlist,
                    date: setlist.date,
                    venue: setlist.venue,
                    audioData
                });
                save();
                recordHistory();
                if ($('#recordings-view').is(':visible')) renderRecordings();
                if ($('#setlist-view').is(':visible') && currentSetlist) renderSetlist();
            };
        }

        function setupScrollHandlers() {
            scrollPosition = 0;
            resetScrollHandlers();
            $('#doc-view').on('mousemove', showNavButtons);
            $(window).on('blur.docview', function(){
                if(document.activeElement == $('#doc-object')[0]) {
                    showNavButtons();
                }
            });
            startInactivityTimer();
        }

        function resetScrollHandlers() {
            $('#doc-view').off('mousemove', showNavButtons);
            $(window).off('blur.docview');
            clearTimeout(inactivityTimer);
        }

        function showNavButtons() {
            $('#doc-nav-buttons').removeClass('hidden');
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                $('#doc-nav-buttons').addClass('hidden');
            }, 3000);
        }

        function startInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                $('#doc-nav-buttons').addClass('hidden');
            }, 3000);
        }

        function show(view) {
            $('main > section').hide();
            $(`#${view}-view`).show();

            currentGenre = (view === 'genre-view') ? currentGenre : null;

            if (['master-view'].includes(view)) {
                 $('#master-upload-container').show();
            } else {
                 $('#master-upload-container').hide();
            }

            if (view !== 'setlist' && view !== 'venue-setlists') {
                cameFromVenue = null;
            }

            // Call the correct render function for the view
            if (view === 'master') renderMaster();
            else if (view === 'plays') renderPlays();
            else if (view === 'recordings') renderRecordings();
            else if (view === 'energy') renderEnergyLevels();
            else if (view === 'favorites') renderFavorites();
            else if (view === 'setlist') renderSetlist();
        }

        function getSetlistHistoryForSong(songId) {
            const history = [];
            Object.entries(setlists).forEach(([name, data]) => {
                if (data.songs.includes(songId)) {
                    history.push({
                        name,
                        date: data.date,
                        venue: data.venue
                    });
                }
            });
            return history.sort((a, b) => (b.date || '').localeCompare(a.date || '')); 
        }

        function showSongDetailsModal(songId) {
            const song = masterSongs.find(s => s.id === songId);
            if (!song) return;

            $('#modal-song-title').text(song.name);
            $('#modal-song-artist').text(song.artist || 'N/A');
            $('#modal-song-genre').text(song.genre || 'N/A');
            $('#modal-song-plays').text(playCounts[song.id] || 0);
            $('#modal-song-last-played').text(song.lastPlayed || 'Never');

            const history = getSetlistHistoryForSong(songId);
            const $historyUl = $('#modal-song-history').empty();
            if (history.length > 0) {
                history.forEach(item => {
                    const date = item.date ? ` on ${item.date}` : '';
                    const venue = item.venue ? ` at ${item.venue}` : '';
                    $historyUl.append(`<li>In <strong>${escapeHtml(item.name)}</strong>${date}${venue}</li>`);
                });
            } else {
                $historyUl.append('<li>Not included in any setlists yet.</li>');
            }

            $('#song-details-modal').removeClass('hidden').addClass('flex');
        }
    </script>
</body>

</html>
